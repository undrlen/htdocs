<?php
 use UmiCms\Service;use UmiCms\Mail\EngineFactory;class umiMail implements iUmiMail {private $template;private $is_commited = false;private $is_sended = false;private $subject = '';private $from_email = 'no_reply@no_reply.ru';private $from_name = 'No_address';private $files = [];private $recipients = [];private $reply_to = [];private $copy = [];private $hidden_copy = [];private $priority;private $mess_body;private $content;private $sTxtBody;private $arrHeaders = [];private $arrContentImages = [];private $arrAttachmentsImages = [];private $arrAttachments = [];private static $arrImagesCache = [];private static $arrAttachmentsCache = [];private $engine;private $sendResult = [];private $innerImgToAttach = true;private $additionalParameters = '';private $parseContent;const SECTION = 'mail';const ENGINE = 'engine';const DEFAULT_PARSE_CONTENT = 'default.parse.content';public function __construct($v66f6181bcb4cff4cd38fbc804a036db6 = 'default', $vad1943a9fd6d3d7ee1e6af41a5b0d3e7 = null) {$this->template = $v66f6181bcb4cff4cd38fbc804a036db6;$this->priority = 'normal';$v2245023265ae4cf87d02c8b6ba991139 = mainConfiguration::getInstance();if (!is_string($vad1943a9fd6d3d7ee1e6af41a5b0d3e7)) {$vad1943a9fd6d3d7ee1e6af41a5b0d3e7 = (string) $this->getEngine();}if (empty($vad1943a9fd6d3d7ee1e6af41a5b0d3e7)) {$vad1943a9fd6d3d7ee1e6af41a5b0d3e7 = 'phpMail';}$this->engine = $vad1943a9fd6d3d7ee1e6af41a5b0d3e7;$v35e8a5fc166b981e69e2db9887e88045 = $v2245023265ae4cf87d02c8b6ba991139->get('kernel', 'inner-img-to-attachment');if ($v35e8a5fc166b981e69e2db9887e88045 !== null) {$this->innerImgToAttach = (bool) $v35e8a5fc166b981e69e2db9887e88045;}$this->setNeedToParseContent($this->getContentFlag());}public function isNeedToParseContent() {return $this->parseContent;}public function setNeedToParseContent($v327a6c4304ad5938eaf0efb6cc3e53dc = true) {$this->parseContent = (bool) $v327a6c4304ad5938eaf0efb6cc3e53dc;return $this;}public function getSendResult() {if (!$this->is_sended) {throw new coreException('Mail was not send.');}return $this->sendResult;}public function addRecipient($v0c83f57c786a0b4a39efab23731c7ebc, $vb068931cc450442b63f5b3d276ea4297 = false) {$v509d7ef3dfcfe96ac9dd57e27c7e8dc9 = explode(',', $v0c83f57c786a0b4a39efab23731c7ebc);$v509d7ef3dfcfe96ac9dd57e27c7e8dc9 = array_filter($v509d7ef3dfcfe96ac9dd57e27c7e8dc9, function ($v0c83f57c786a0b4a39efab23731c7ebc) {return self::checkEmail($v0c83f57c786a0b4a39efab23731c7ebc);});if (empty($v509d7ef3dfcfe96ac9dd57e27c7e8dc9)) {return false;}$vb068931cc450442b63f5b3d276ea4297 = is_string($vb068931cc450442b63f5b3d276ea4297) ? trim($vb068931cc450442b63f5b3d276ea4297) : '';foreach ($v509d7ef3dfcfe96ac9dd57e27c7e8dc9 as $v0c83f57c786a0b4a39efab23731c7ebc) {$vd6e41fc5d1bcfead1db3b6dc05774971 = [trim($v0c83f57c786a0b4a39efab23731c7ebc), $vb068931cc450442b63f5b3d276ea4297];if (!in_array($vd6e41fc5d1bcfead1db3b6dc05774971, $this->recipients)) {$this->recipients[] = $vd6e41fc5d1bcfead1db3b6dc05774971;}}return true;}public function hasRecipients() {return !empty($this->recipients);}public function addCopy($v0c83f57c786a0b4a39efab23731c7ebc, $vb068931cc450442b63f5b3d276ea4297 = false) {if (self::checkEmail($v0c83f57c786a0b4a39efab23731c7ebc)) {$v12cba3ee81cf4a793796a51b6327c678 = ($vb068931cc450442b63f5b3d276ea4297 ? trim($vb068931cc450442b63f5b3d276ea4297) . ' ' : '') . '<' . trim($v0c83f57c786a0b4a39efab23731c7ebc) . '>';if (!in_array($v12cba3ee81cf4a793796a51b6327c678, $this->copy)) {$this->copy[] = $v12cba3ee81cf4a793796a51b6327c678;}return true;}return false;}public function addHiddenCopy($v0c83f57c786a0b4a39efab23731c7ebc, $vb068931cc450442b63f5b3d276ea4297 = false) {if (self::checkEmail($v0c83f57c786a0b4a39efab23731c7ebc)) {$v12cba3ee81cf4a793796a51b6327c678 = ($vb068931cc450442b63f5b3d276ea4297 ? trim($vb068931cc450442b63f5b3d276ea4297) . ' ' : '') . '<' . trim($v0c83f57c786a0b4a39efab23731c7ebc) . '>';if (!in_array($v12cba3ee81cf4a793796a51b6327c678, $this->hidden_copy)) {$this->hidden_copy[] = $v12cba3ee81cf4a793796a51b6327c678;}return true;}return false;}public function addReplyTo($v0c83f57c786a0b4a39efab23731c7ebc, $vb068931cc450442b63f5b3d276ea4297 = false) {if (self::checkEmail($v0c83f57c786a0b4a39efab23731c7ebc)) {$v690b684a6c535da876147eb8d72b4e29 = ($vb068931cc450442b63f5b3d276ea4297 ? trim($vb068931cc450442b63f5b3d276ea4297) . ' ' : '') . '<' . trim($v0c83f57c786a0b4a39efab23731c7ebc) . '>';if (!in_array($v690b684a6c535da876147eb8d72b4e29, $this->reply_to)) {$this->reply_to[] = $v690b684a6c535da876147eb8d72b4e29;}return true;}return false;}public function setFrom($v0c83f57c786a0b4a39efab23731c7ebc, $vb068931cc450442b63f5b3d276ea4297 = false) {if (self::checkEmail($v0c83f57c786a0b4a39efab23731c7ebc)) {$this->from_email = $v0c83f57c786a0b4a39efab23731c7ebc;$this->from_name = str_replace(['"', "'"], ["\\\"", "\\'"], $vb068931cc450442b63f5b3d276ea4297);return true;}return false;}public function getSubject() {return $this->subject;}public function setSubject($vb5e3374e43f6544852f7751dfc529100) {$this->subject = (string) str_replace("\n", ' ', str_replace("\r", '', $vb5e3374e43f6544852f7751dfc529100));}public function getContent() {return $this->content;}public function setContent($va5374bce6e736150046560d951958df7, $v020be71a1d373e050f3760cd6d81ea7e = true) {$this->content = (string) $va5374bce6e736150046560d951958df7;$this->content = str_replace('&#037;', '%', $this->content);if ($v020be71a1d373e050f3760cd6d81ea7e) {$this->content = def_module::parseTPLMacroses($this->content);}}public function setTxtContent($va9cdadb3209df7e7f81aa1f3b9aaf4f0) {$this->sTxtBody = (string) $va9cdadb3209df7e7f81aa1f3b9aaf4f0;}public function setPriorityLevel($vc9e9a848920877e76685b2e4e76de38d = 'normal') {switch ($vc9e9a848920877e76685b2e4e76de38d) {case 'highest':     $this->priority = '1 (Highest)';break;case 'hight':     $this->priority = '2 (Hight)';break;case 'normal':     $this->priority = '3 (Normal)';break;case 'low':     $this->priority = '4 (Low)';break;case 'lowest':     $this->priority = '5 (Lowest)';break;default:     $this->priority = '3 (Normal)';break;}}public function setImportanceLevel($vc9e9a848920877e76685b2e4e76de38d = 'normal') {}public function commit() {$this->is_commited = true;}private function addHTMLImage($va83269b957a782de9de17b330b439574, $v1a58436e50c600514b0e0e25873e5c40 = 'image/jpeg') {$v7c610e4d8f0bc3df13a676914dbc6224 = $va83269b957a782de9de17b330b439574;if (mb_strtolower(mb_substr($va83269b957a782de9de17b330b439574, 0, 7)) !== 'http://') {if (!file_exists($va83269b957a782de9de17b330b439574)) {if (isset($_SERVER['SERVER_NAME'])) {$v67b3dba8bc6778101892eb77249db32e = $_SERVER['SERVER_NAME'];$vad5f82e879a9c5d6b5b442eb37e50551 = null;}else {$vad5f82e879a9c5d6b5b442eb37e50551 = Service::DomainCollection()       ->getDefaultDomain();$v67b3dba8bc6778101892eb77249db32e = $vad5f82e879a9c5d6b5b442eb37e50551->getHost();}$v7c610e4d8f0bc3df13a676914dbc6224 = getSelectedServerProtocol($vad5f82e879a9c5d6b5b442eb37e50551) . '://' . $v67b3dba8bc6778101892eb77249db32e . '/' . ltrim($va83269b957a782de9de17b330b439574, '/');}}if (isset(self::$arrImagesCache[$v7c610e4d8f0bc3df13a676914dbc6224])) {$this->arrAttachmentsImages[$v7c610e4d8f0bc3df13a676914dbc6224] = self::$arrImagesCache[$v7c610e4d8f0bc3df13a676914dbc6224];$this->arrContentImages[$va83269b957a782de9de17b330b439574] = $v7c610e4d8f0bc3df13a676914dbc6224;return true;}if (($v5d60b99373796eecf6015de3d66712f0 = @file_get_contents($v7c610e4d8f0bc3df13a676914dbc6224)) !== false) {$v33d1ae3aef5ddc2f5717e8f4856a5797 = basename($v7c610e4d8f0bc3df13a676914dbc6224);$this->arrAttachmentsImages[$v7c610e4d8f0bc3df13a676914dbc6224] = [     'name' => $v33d1ae3aef5ddc2f5717e8f4856a5797,     'path' => $va83269b957a782de9de17b330b439574,     'data' => $v5d60b99373796eecf6015de3d66712f0,     'content-type' => $v1a58436e50c600514b0e0e25873e5c40,     'sizes' => @getimagesize($va83269b957a782de9de17b330b439574),     'cid' => md5(uniqid(mt_rand(), true))    ];self::$arrImagesCache[$v7c610e4d8f0bc3df13a676914dbc6224] = $this->arrAttachmentsImages[$v7c610e4d8f0bc3df13a676914dbc6224];$this->arrContentImages[$va83269b957a782de9de17b330b439574] = $v7c610e4d8f0bc3df13a676914dbc6224;return true;}return false;}private function addAttachment($vabdc6fca39c945587efec7f17113d48a, $v1a58436e50c600514b0e0e25873e5c40 = 'application/octet-stream') {if (isset(self::$arrAttachmentsCache[$vabdc6fca39c945587efec7f17113d48a])) {$this->arrAttachments[$vabdc6fca39c945587efec7f17113d48a] = self::$arrAttachmentsCache[$vabdc6fca39c945587efec7f17113d48a];return true;}$v33d1ae3aef5ddc2f5717e8f4856a5797 = basename($vabdc6fca39c945587efec7f17113d48a);if (($v30131c31f301d25a705810f37232ef77 = @file_get_contents($vabdc6fca39c945587efec7f17113d48a)) !== false) {$this->arrAttachments[$vabdc6fca39c945587efec7f17113d48a] = [     'name' => $v33d1ae3aef5ddc2f5717e8f4856a5797,     'path' => $vabdc6fca39c945587efec7f17113d48a,     'data' => $v30131c31f301d25a705810f37232ef77,     'content-type' => $v1a58436e50c600514b0e0e25873e5c40,     'disposition' => 'attachment',     'cid' => md5(uniqid(mt_rand(), true))    ];self::$arrAttachmentsCache[$vabdc6fca39c945587efec7f17113d48a] = $this->arrAttachments[$vabdc6fca39c945587efec7f17113d48a];return true;}return false;}public static function clearFilesCache() {self::$arrAttachmentsCache = [];self::$arrImagesCache = [];}public function getHeaders($vf28cf985778b731802febf0cd05df0c2 = [], $v57c13771c665e3e754d45cf1f203bdae = false) {$v99b7ac2b500826e1b6e5496c094befbe = [];$v99b7ac2b500826e1b6e5496c094befbe['MIME-Version'] = '1.0';$v99b7ac2b500826e1b6e5496c094befbe = array_merge($v99b7ac2b500826e1b6e5496c094befbe, $vf28cf985778b731802febf0cd05df0c2);$this->arrHeaders =    $v57c13771c665e3e754d45cf1f203bdae ? array_merge($this->arrHeaders, $v99b7ac2b500826e1b6e5496c094befbe) : array_merge($v99b7ac2b500826e1b6e5496c094befbe, $this->arrHeaders);return $this->encodeHeaders($this->arrHeaders);}private function encodeHeaders($v99b7ac2b500826e1b6e5496c094befbe) {$v76e5bebbd31002d9f9bdc30cf3f9e80e = [];foreach ($v99b7ac2b500826e1b6e5496c094befbe as $vcba6edd8118e56459daee1a4a52365e1 => $v2c0f0eef009b52594d1845816b697bed) {$v6cddaf13bfc401291a3950ae3689a443 = preg_split("/(\s)/", $v2c0f0eef009b52594d1845816b697bed, -1, PREG_SPLIT_DELIM_CAPTURE);$va6996137ab5b77c55984187e30bc413f = '';$v0726147c36ed3459eb2dc69141d33b3f = '';foreach ($v6cddaf13bfc401291a3950ae3689a443 as $v2c0f0eef009b52594d1845816b697bed) {if (!trim($v2c0f0eef009b52594d1845816b697bed)) {$va6996137ab5b77c55984187e30bc413f .= $v2c0f0eef009b52594d1845816b697bed;continue;}$v2c0f0eef009b52594d1845816b697bed = $va6996137ab5b77c55984187e30bc413f . $v2c0f0eef009b52594d1845816b697bed;$va6996137ab5b77c55984187e30bc413f = '';$v1c0d2979616c420cd68d69d39ee78673 = $v0134137bbc984a9b06209bcff860206f = '';if (mb_substr($v2c0f0eef009b52594d1845816b697bed, 0, 1) == '"') {$v2c0f0eef009b52594d1845816b697bed = mb_substr($v2c0f0eef009b52594d1845816b697bed, 1);$v1c0d2979616c420cd68d69d39ee78673 = '"';}if (mb_substr($v2c0f0eef009b52594d1845816b697bed, -1, 1) == '"') {$v2c0f0eef009b52594d1845816b697bed = mb_substr($v2c0f0eef009b52594d1845816b697bed, 0, -1);$v0134137bbc984a9b06209bcff860206f = '"';}if (preg_match('/[\x80-\xFF]{1}/', $v2c0f0eef009b52594d1845816b697bed)) {$v2c0f0eef009b52594d1845816b697bed = iconv_mime_encode(       $vcba6edd8118e56459daee1a4a52365e1,       $v2c0f0eef009b52594d1845816b697bed,       [        'input-charset' => 'UTF-8',        'output-charset' => 'UTF-8',        'line-break-chars' => umiMimePart::UMI_MIMEPART_CRLF       ]      );$v2c0f0eef009b52594d1845816b697bed = preg_replace('/^' . preg_quote($vcba6edd8118e56459daee1a4a52365e1, '/') . "\:\ /", '', $v2c0f0eef009b52594d1845816b697bed);}$v0726147c36ed3459eb2dc69141d33b3f .= $v1c0d2979616c420cd68d69d39ee78673 . $v2c0f0eef009b52594d1845816b697bed . $v0134137bbc984a9b06209bcff860206f;}$v76e5bebbd31002d9f9bdc30cf3f9e80e[$vcba6edd8118e56459daee1a4a52365e1] = $v0726147c36ed3459eb2dc69141d33b3f;}return $v76e5bebbd31002d9f9bdc30cf3f9e80e;}private function parseContent() {if (mainConfiguration::getInstance()->get('system', 'use-old-templater') && getRequest('scheme') !== null) {unset($_REQUEST['scheme']);}try {list($v66f6181bcb4cff4cd38fbc804a036db6) = def_module::loadTemplatesForMail('mail/' . $this->template, 'body');}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v66f6181bcb4cff4cd38fbc804a036db6 = "%header%\n%content%";}$v87cd8b8808600624d8c590cfc2e6e94b = [    'header' => $this->subject,    'content' => $this->content   ];$v9a0364b9e99bb480dd25e1f0284c8555 = def_module::parseTemplateForMail($v66f6181bcb4cff4cd38fbc804a036db6, $v87cd8b8808600624d8c590cfc2e6e94b);if ($this->innerImgToAttach) {$this->attachInnerImages($v9a0364b9e99bb480dd25e1f0284c8555);}$v67b3dba8bc6778101892eb77249db32e = Service::DomainDetector()->detectHost();$v9a0364b9e99bb480dd25e1f0284c8555 = preg_replace('#(href)\s*=\s*(["\']?)?(/([^\s"\']+))#i', '$1=$2http://' . $v67b3dba8bc6778101892eb77249db32e . '$3', $v9a0364b9e99bb480dd25e1f0284c8555);if ($this->innerImgToAttach) {foreach ($this->arrContentImages as $va83269b957a782de9de17b330b439574 => $v7c610e4d8f0bc3df13a676914dbc6224) {if (!isset($this->arrAttachmentsImages[$v7c610e4d8f0bc3df13a676914dbc6224])) {continue;}$v8b9f60798e84fcd02a6f16731fad0d75 = $this->arrAttachmentsImages[$v7c610e4d8f0bc3df13a676914dbc6224];$vaa5bb0b328edf04bdeade3062181e7ae = [      '/(\s)((?i)src|background|href(?-i))\s*=\s*(["\']?)' . preg_quote($va83269b957a782de9de17b330b439574, '/') . '\3/',      '/(?i)url(?-i)\(\s*(["\']?)' . preg_quote($va83269b957a782de9de17b330b439574, '/') . '\1\s*\)/'     ];$v765a7aaaad7c01a34106aa80b74e28b7 = [      '\1\2=\3cid:' . $v8b9f60798e84fcd02a6f16731fad0d75['cid'] . '\3',      'url(\1cid:' . $v8b9f60798e84fcd02a6f16731fad0d75['cid'] . '\2)'     ];$v9a0364b9e99bb480dd25e1f0284c8555 = preg_replace($vaa5bb0b328edf04bdeade3062181e7ae, $v765a7aaaad7c01a34106aa80b74e28b7, $v9a0364b9e99bb480dd25e1f0284c8555);}}return $v9a0364b9e99bb480dd25e1f0284c8555;}private function attachInnerImages($v9a0364b9e99bb480dd25e1f0284c8555) {$v8ca4fa72471ea85932e2bb61cdff5cc8 = [];$v8097653eba9b51a9f4f51ae17ea80bbc = '#<\w+[^>]+\s((?i)src|background|href(?-i))\s*=\s*(["\']?)?([\w\?=\.\-_:\/]+.(jpeg|jpg|gif|png|bmp))\2#i';if (preg_match_all($v8097653eba9b51a9f4f51ae17ea80bbc, $v9a0364b9e99bb480dd25e1f0284c8555, $v9c28d32df234037773be184dbdafc274)) {$v8ca4fa72471ea85932e2bb61cdff5cc8 = isset($v9c28d32df234037773be184dbdafc274[3]) ? $v9c28d32df234037773be184dbdafc274[3] : [];}$vc573b069d6962858aa56c6448c393920 = [];$v4ff5d94f84f75e0877cd02f5dc2cb58a = '#(?i)url(?-i)\(\s*(["\']?)([\w\.\-_:\/]+.(jpeg|jpg|gif|png|bmp))\1\s*\)#';if (preg_match_all($v4ff5d94f84f75e0877cd02f5dc2cb58a, $v9a0364b9e99bb480dd25e1f0284c8555, $v9c28d32df234037773be184dbdafc274)) {$vc573b069d6962858aa56c6448c393920 = isset($v9c28d32df234037773be184dbdafc274[2]) ? $v9c28d32df234037773be184dbdafc274[2] : [];}$v1a6a0ba3e8bcd6438f1fcdb31e963d09 = array_unique(array_merge($v8ca4fa72471ea85932e2bb61cdff5cc8, $vc573b069d6962858aa56c6448c393920));foreach ($v1a6a0ba3e8bcd6438f1fcdb31e963d09 as $v28b569d3f9a3e63f94ca6fad969475f9) {$this->addHTMLImage($v28b569d3f9a3e63f94ca6fad969475f9);}}public function send() {if ($this->is_sended) {return true;}if ($this->content == '') {return false;}$this->arrHeaders['From'] = ($this->from_name ? "$this->from_name " : '') . '<' . $this->from_email . '>';$this->arrHeaders['X-Mailer'] = 'UMI.CMS';if (umiCount($this->reply_to)) {$this->arrHeaders['Reply-To'] = implode(', ', $this->reply_to);}if (umiCount($this->copy)) {$this->arrHeaders['Cc'] = implode(', ', $this->copy);}if (umiCount($this->hidden_copy)) {$this->arrHeaders['Bcc'] = implode(', ', $this->hidden_copy);}$this->arrHeaders['X-Priority'] = $this->priority;$v9a0364b9e99bb480dd25e1f0284c8555 = $this->isNeedToParseContent() ? $this->parseContent() : $this->content;foreach ($this->files as $v3b569bcd1bf089908a7a85ead9f9ab9a) {$this->addAttachment($v3b569bcd1bf089908a7a85ead9f9ab9a->getFilePath());}$v46f2f0d388f714c268d510d3ddbdfe88 = (bool) umiCount($this->arrAttachments);$va491666beca97718aeb4d201ac898bb5 = (bool) umiCount($this->arrAttachmentsImages);$vcae3e24516df3c71ced3f01fc0ee6c65 = (bool) mb_strlen($v9a0364b9e99bb480dd25e1f0284c8555);$vdb9129f4c75531384e13d0a0d7dae6e9 = (bool) mb_strlen($this->sTxtBody);$v69476a86c388a5b8e4e18eeaea2ae2ba = !$vcae3e24516df3c71ced3f01fc0ee6c65 && (bool) mb_strlen($v9a0364b9e99bb480dd25e1f0284c8555);$vd6d25fae8ec76ccadc5deee4ee0c4896 = new umiMimePart('', []);switch (true) {case $v69476a86c388a5b8e4e18eeaea2ae2ba && !$v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addTextPart($this->sTxtBody);break;case !$vcae3e24516df3c71ced3f01fc0ee6c65 && !$vdb9129f4c75531384e13d0a0d7dae6e9 && $v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addMixedPart();foreach ($this->arrAttachments as $v5d659066115284c2f4023431d517fe38) {$vd6d25fae8ec76ccadc5deee4ee0c4896->addAttachmentPart($v5d659066115284c2f4023431d517fe38);}break;case $v69476a86c388a5b8e4e18eeaea2ae2ba && $v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addMixedPart();$vd6d25fae8ec76ccadc5deee4ee0c4896->addTextPart($this->sTxtBody);foreach ($this->arrAttachments as $v5d659066115284c2f4023431d517fe38) {$vd6d25fae8ec76ccadc5deee4ee0c4896->addAttachmentPart($v5d659066115284c2f4023431d517fe38);}break;case $vcae3e24516df3c71ced3f01fc0ee6c65 && !$va491666beca97718aeb4d201ac898bb5 && !$v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addMixedPart();if ($vdb9129f4c75531384e13d0a0d7dae6e9) {$vb09cfd144243e0299ce0a896ca163843 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addAlternativePart();$vb09cfd144243e0299ce0a896ca163843->addTextPart($this->sTxtBody);$vb09cfd144243e0299ce0a896ca163843->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}else {$vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}break;case $vcae3e24516df3c71ced3f01fc0ee6c65 && $va491666beca97718aeb4d201ac898bb5 && !$v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addRelatedPart();if ($vdb9129f4c75531384e13d0a0d7dae6e9) {$vb09cfd144243e0299ce0a896ca163843 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addAlternativePart();$vb09cfd144243e0299ce0a896ca163843->addTextPart($this->sTxtBody);$vb09cfd144243e0299ce0a896ca163843->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}else {$vd6d25fae8ec76ccadc5deee4ee0c4896->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}foreach ($this->arrAttachmentsImages as $v8b9f60798e84fcd02a6f16731fad0d75) {$vd6d25fae8ec76ccadc5deee4ee0c4896->addHtmlImagePart($v8b9f60798e84fcd02a6f16731fad0d75);}break;case $vcae3e24516df3c71ced3f01fc0ee6c65 && !$va491666beca97718aeb4d201ac898bb5 && $v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addMixedPart();if ($vdb9129f4c75531384e13d0a0d7dae6e9) {$vb09cfd144243e0299ce0a896ca163843 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addAlternativePart();$vb09cfd144243e0299ce0a896ca163843->addTextPart($this->sTxtBody);$vb09cfd144243e0299ce0a896ca163843->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}else {$vd6d25fae8ec76ccadc5deee4ee0c4896->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);}foreach ($this->arrAttachments as $v5d659066115284c2f4023431d517fe38) {$vd6d25fae8ec76ccadc5deee4ee0c4896->addAttachmentPart($v5d659066115284c2f4023431d517fe38);}break;case $vcae3e24516df3c71ced3f01fc0ee6c65 && $va491666beca97718aeb4d201ac898bb5 && $v46f2f0d388f714c268d510d3ddbdfe88:     $vd6d25fae8ec76ccadc5deee4ee0c4896 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addMixedPart();if ($vdb9129f4c75531384e13d0a0d7dae6e9) {$vb09cfd144243e0299ce0a896ca163843 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addAlternativePart();$vb09cfd144243e0299ce0a896ca163843->addTextPart($this->sTxtBody);$v692f1e5fb84fbda80e99a0ce848bc2b1 = $vb09cfd144243e0299ce0a896ca163843->addRelatedPart();}else {$v692f1e5fb84fbda80e99a0ce848bc2b1 = $vd6d25fae8ec76ccadc5deee4ee0c4896->addRelatedPart();}$v692f1e5fb84fbda80e99a0ce848bc2b1->addHtmlPart($v9a0364b9e99bb480dd25e1f0284c8555);foreach ($this->arrAttachmentsImages as $v8b9f60798e84fcd02a6f16731fad0d75) {$v692f1e5fb84fbda80e99a0ce848bc2b1->addHtmlImagePart($v8b9f60798e84fcd02a6f16731fad0d75);}foreach ($this->arrAttachments as $v5d659066115284c2f4023431d517fe38) {$vd6d25fae8ec76ccadc5deee4ee0c4896->addAttachmentPart($v5d659066115284c2f4023431d517fe38);}break;}$v766454ac4fb7a41c6ebf95bfb8130318 = $vd6d25fae8ec76ccadc5deee4ee0c4896->encodePart();$this->mess_body = $v766454ac4fb7a41c6ebf95bfb8130318['body'];$v99b7ac2b500826e1b6e5496c094befbe = $this->getHeaders($v766454ac4fb7a41c6ebf95bfb8130318['headers'], true);$v5c27dddc7f7c23c046aa4f514147f839 = '';foreach ($v99b7ac2b500826e1b6e5496c094befbe as $vcba6edd8118e56459daee1a4a52365e1 => $v2c0f0eef009b52594d1845816b697bed) {$v5c27dddc7f7c23c046aa4f514147f839 .= $vcba6edd8118e56459daee1a4a52365e1 . ': ' . $v2c0f0eef009b52594d1845816b697bed . umiMimePart::UMI_MIMEPART_CRLF;}foreach ($this->recipients as $ve6a967f2c984f079715d7daa3f9b5f90) {$v4b5789f850e658bcfb56173ae0a5b7ca = trim(str_replace("\n", ' ', $ve6a967f2c984f079715d7daa3f9b5f90[1]));$v3c902d39aefa7bdd0ecdc8125687558f = trim($ve6a967f2c984f079715d7daa3f9b5f90[0]);if ($v3c902d39aefa7bdd0ecdc8125687558f === '') {continue;}$v22c7ae03c1d7ec9ffafe48c116510eed = $v3c902d39aefa7bdd0ecdc8125687558f;if ($v4b5789f850e658bcfb56173ae0a5b7ca !== '') {$v22c7ae03c1d7ec9ffafe48c116510eed = iconv_mime_encode(      '',      $ve6a967f2c984f079715d7daa3f9b5f90[1],      [       'input-charset' => 'UTF-8',       'output-charset' => 'UTF-8',       'line-break-chars' => ''      ]     );$v22c7ae03c1d7ec9ffafe48c116510eed = ltrim($v22c7ae03c1d7ec9ffafe48c116510eed, ' :');$v22c7ae03c1d7ec9ffafe48c116510eed .= ' <' . $v3c902d39aefa7bdd0ecdc8125687558f . '>';}$v18510ea4e30a52ff7b53e7b5e2691d83 = '';if ($this->subject !== '') {$v18510ea4e30a52ff7b53e7b5e2691d83 = iconv_mime_encode(      '',      $this->subject,      [       'input-charset' => 'UTF-8',       'output-charset' => 'UTF-8',       'line-break-chars' => ''      ]     );$v18510ea4e30a52ff7b53e7b5e2691d83 = ltrim($v18510ea4e30a52ff7b53e7b5e2691d83, ' :');}$v78e731027d8fd50ed642340b7c9a63b3 = $this->mess_body;$v166e64f6c3677d0c513901242a3e702d = $this->getAdditionalParameters();$v161c9aaa4fe035e7b2f465bc59f3ab45 = new umiEventPoint('core_sendmail');$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('to', $v22c7ae03c1d7ec9ffafe48c116510eed);$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('subject', $v18510ea4e30a52ff7b53e7b5e2691d83);$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('body', $v78e731027d8fd50ed642340b7c9a63b3);$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('headers', $v5c27dddc7f7c23c046aa4f514147f839);$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('parameters', $v166e64f6c3677d0c513901242a3e702d);$v161c9aaa4fe035e7b2f465bc59f3ab45->setParam('mail', $this);$v161c9aaa4fe035e7b2f465bc59f3ab45->addRef('to', $v22c7ae03c1d7ec9ffafe48c116510eed);$v161c9aaa4fe035e7b2f465bc59f3ab45->addRef('subject', $v18510ea4e30a52ff7b53e7b5e2691d83);$v161c9aaa4fe035e7b2f465bc59f3ab45->addRef('body', $v78e731027d8fd50ed642340b7c9a63b3);$v161c9aaa4fe035e7b2f465bc59f3ab45->addRef('headers', $v5c27dddc7f7c23c046aa4f514147f839);$v161c9aaa4fe035e7b2f465bc59f3ab45->addRef('parameters', $v166e64f6c3677d0c513901242a3e702d);$v161c9aaa4fe035e7b2f465bc59f3ab45->setMode('before');$v161c9aaa4fe035e7b2f465bc59f3ab45->call();$this->sendResult = $this->internalMail($v22c7ae03c1d7ec9ffafe48c116510eed, $v18510ea4e30a52ff7b53e7b5e2691d83, $v78e731027d8fd50ed642340b7c9a63b3, $v5c27dddc7f7c23c046aa4f514147f839, $v166e64f6c3677d0c513901242a3e702d);$v161c9aaa4fe035e7b2f465bc59f3ab45->setMode('after');$v161c9aaa4fe035e7b2f465bc59f3ab45->call();}return $this->is_sended = true;}public function getAdditionalParameters() {return $this->additionalParameters;}public function setAdditionalParameters($v166e64f6c3677d0c513901242a3e702d) {if (!is_string($v166e64f6c3677d0c513901242a3e702d) || empty($v166e64f6c3677d0c513901242a3e702d)) {throw new InvalidArgumentException('Incorrect parameters given, params value must be not empty string.');}$this->additionalParameters = $v166e64f6c3677d0c513901242a3e702d;return $this;}private function internalMail($vf5d942275912929683d28c2d9904ccce, $vb5e3374e43f6544852f7751dfc529100, $v78e731027d8fd50ed642340b7c9a63b3, $v4340fd73e75df7a9d9e45902a59ba3a4, $v166e64f6c3677d0c513901242a3e702d) {try {$v7b334b7260361141659fa9862e803476 = EngineFactory::get($this->engine);}catch (Exception $v42552b1f133f9f8eb406d4f306ea9fd1) {umiExceptionHandler::report($v42552b1f133f9f8eb406d4f306ea9fd1);$v7b334b7260361141659fa9862e803476 = EngineFactory::createDefault();}$v57bdf2ced5c364d8a040512e00c051d2 = $v7b334b7260361141659fa9862e803476->setSubject($vb5e3374e43f6544852f7751dfc529100)    ->setMessage($v78e731027d8fd50ed642340b7c9a63b3)    ->setHeaders($v4340fd73e75df7a9d9e45902a59ba3a4)    ->setParameters($v166e64f6c3677d0c513901242a3e702d)    ->send($vf5d942275912929683d28c2d9904ccce);return [    'mailTo' => $vf5d942275912929683d28c2d9904ccce,    'subject' => $vb5e3374e43f6544852f7751dfc529100,    'message' => $v78e731027d8fd50ed642340b7c9a63b3,    'headers' => $v4340fd73e75df7a9d9e45902a59ba3a4,    'isOk' => $v57bdf2ced5c364d8a040512e00c051d2   ];}public function attachFile(iUmiFile $v8c7dd922ad47494fc02c388e12c00eac) {if (!in_array($v8c7dd922ad47494fc02c388e12c00eac, $this->files) && $v8c7dd922ad47494fc02c388e12c00eac->isExists()) {$this->files[] = $v8c7dd922ad47494fc02c388e12c00eac;return true;}}public function __destruct() {if ($this->is_commited && !$this->is_sended) {$this->send();}}public static function checkEmail($v0c83f57c786a0b4a39efab23731c7ebc) {if (!is_string($v0c83f57c786a0b4a39efab23731c7ebc) || empty($v0c83f57c786a0b4a39efab23731c7ebc)) {return false;}return (bool) preg_match("/.+\@.+\..+/", $v0c83f57c786a0b4a39efab23731c7ebc);}private function getEngine() {$va2364ba3572ed4debd86815bd429c536 = $this->getCustomPrefix() . self::ENGINE;return $this->isUseCustomSettings()    ? Service::Registry()->get($va2364ba3572ed4debd86815bd429c536)    : $this->getConfigMailValue(self::ENGINE);}private function getContentFlag() {$va2364ba3572ed4debd86815bd429c536 = $this->getCustomPrefix() . 'disable-parse';return $this->isUseCustomSettings()    ? !Service::Registry()->get($va2364ba3572ed4debd86815bd429c536)    : $this->getConfigMailValue(self::DEFAULT_PARSE_CONTENT);}private function getConfigMailValue($vb068931cc450442b63f5b3d276ea4297) {return mainConfiguration::getInstance()->get(self::SECTION, $vb068931cc450442b63f5b3d276ea4297);}private function isUseCustomSettings() {return (bool) Service::Registry()    ->get($this->getCustomPrefix() . 'use-custom-settings');}private function getCustomPrefix() {$v72ee76c5c29383b7c9f9225c1fa4d10b = Service::DomainDetector()->detectId();$v694b5b6b5536d28285396c8ce7c268bc = Service::LanguageDetector()->detectId();return "//settings/mail/$v72ee76c5c29383b7c9f9225c1fa4d10b/$v694b5b6b5536d28285396c8ce7c268bc/";}}