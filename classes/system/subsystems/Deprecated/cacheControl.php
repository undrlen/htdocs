<?php
 use UmiCms\Service;class staticCache {protected $config, $enabled, $splitLevel = 5,   $requestUri, $isAdmin = false, $cacheFolder, $cacheFilePath;public function __construct() {$this->config = mainConfiguration::getInstance();$this->enabled = (bool) $this->config->get('cache', 'static.enabled');if ($this->enabled) {$v851148b4fd8fd7ae74bd9100c5c0c898 = $this->config->includeParam('system.static-cache');$ve440be6a92dba11caa790215081671ae = $this->config->includeParam('sys-temp-path');if (!$v851148b4fd8fd7ae74bd9100c5c0c898) {$v851148b4fd8fd7ae74bd9100c5c0c898 = $ve440be6a92dba11caa790215081671ae . '/static-cache/';}if (mb_substr($v851148b4fd8fd7ae74bd9100c5c0c898, -1, 1) != '/') {$v851148b4fd8fd7ae74bd9100c5c0c898 .= '/';}$v851148b4fd8fd7ae74bd9100c5c0c898 .= preg_replace('/^www\./i', '', getServer("HTTP_HOST") . "/");$this->setRequestUri(getServer('REQUEST_URI'));$this->setCacheFolder($v851148b4fd8fd7ae74bd9100c5c0c898);$this->cacheFilePath = $this->prepareCacheFile();}}public function setRequestUri($vb6ee27ee7fe19b0c0dd907d5f947aa12) {$vb6ee27ee7fe19b0c0dd907d5f947aa12 = trim($vb6ee27ee7fe19b0c0dd907d5f947aa12, '/');if (!$vb6ee27ee7fe19b0c0dd907d5f947aa12) {$vb6ee27ee7fe19b0c0dd907d5f947aa12 = '__splash';}$this->requestUri = $vb6ee27ee7fe19b0c0dd907d5f947aa12;$v5fdedfe381eef204ab3354d244885a40 = false;if (mb_substr($vb6ee27ee7fe19b0c0dd907d5f947aa12, 0, mb_strlen('admin')) == 'admin') {$v5fdedfe381eef204ab3354d244885a40 = true;}elseif (mb_substr($vb6ee27ee7fe19b0c0dd907d5f947aa12, 3, mb_strlen('admin')) == 'admin') {$v5fdedfe381eef204ab3354d244885a40 = true;}$this->isAdmin = $v5fdedfe381eef204ab3354d244885a40;}public function setCacheFolder($v7f6a05a4bb9b16a1f4b36e9000d1bc3c) {if (is_dir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c)) {$this->cacheFolder = $v7f6a05a4bb9b16a1f4b36e9000d1bc3c;return true;}mkdir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c, 0777, true);if (is_dir($v7f6a05a4bb9b16a1f4b36e9000d1bc3c)) {$this->cacheFolder = $v7f6a05a4bb9b16a1f4b36e9000d1bc3c;return true;}return false;}public function cleanup() {$this->deleteElementsRelatedPages();}protected function deleteElementsRelatedPages() {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v5e9298abf28337d6b7f5ab24a28c62f9 = $vb81ca7c0ccaa77e7aa91936ab0070695->getUpdatedElements();foreach ($v5e9298abf28337d6b7f5ab24a28c62f9 as $v7552cd149af7495ee7d8225974e50f80) {$this->deleteElementRelatedPages($v7552cd149af7495ee7d8225974e50f80);}}protected function deleteElementRelatedPages($v7552cd149af7495ee7d8225974e50f80) {$this->enabled = (bool) $this->config->get('cache', 'static.enabled');if (!$this->enabled) {return false;}$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v8e2dcfd7e7e24b1ca76c1193f645902b = $vb81ca7c0ccaa77e7aa91936ab0070695->getElement($v7552cd149af7495ee7d8225974e50f80);if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceOf umiHierarchyElement) {return false;}$v851148b4fd8fd7ae74bd9100c5c0c898 = $this->config->includeParam('system.static-cache');$ve440be6a92dba11caa790215081671ae = $this->config->includeParam('sys-temp-path');if (!$v851148b4fd8fd7ae74bd9100c5c0c898) {$v851148b4fd8fd7ae74bd9100c5c0c898 = $ve440be6a92dba11caa790215081671ae . '/static-cache/';}if (mb_substr($v851148b4fd8fd7ae74bd9100c5c0c898, -1, 1) != '/') {$v851148b4fd8fd7ae74bd9100c5c0c898 .= '/';}$v14a0ffee308315f250f040d5b4d48560 = domainsCollection::getInstance();$vad5f82e879a9c5d6b5b442eb37e50551 = $v14a0ffee308315f250f040d5b4d48560->getDomain($v8e2dcfd7e7e24b1ca76c1193f645902b->getDomainId());if (!$vad5f82e879a9c5d6b5b442eb37e50551 instanceof domain) {return false;}$vad5f82e879a9c5d6b5b442eb37e50551 = $vad5f82e879a9c5d6b5b442eb37e50551->getHost();$v851148b4fd8fd7ae74bd9100c5c0c898 .= preg_replace('/^www\./i', '', $vad5f82e879a9c5d6b5b442eb37e50551 . "/");if ($this->isMobileCache()) {$v851148b4fd8fd7ae74bd9100c5c0c898 .= 'mobile/';}$vc75eef18aa39700880ea1fbbf20ccd39 = ($v8e2dcfd7e7e24b1ca76c1193f645902b->getIsDefault()) ? '' : $vb81ca7c0ccaa77e7aa91936ab0070695->getPathById($v7552cd149af7495ee7d8225974e50f80);$v851148b4fd8fd7ae74bd9100c5c0c898 .= $vc75eef18aa39700880ea1fbbf20ccd39;$v8c7dd922ad47494fc02c388e12c00eac = $v851148b4fd8fd7ae74bd9100c5c0c898 . 'index.html';$this->deleteFileIfExists($v8c7dd922ad47494fc02c388e12c00eac);$this->deleteFolderIfEmpty(dirname($v8c7dd922ad47494fc02c388e12c00eac));}protected function deleteFolderIfEmpty($vd6fe1d0be6347b8ef2427fa629c04485) {$vd6fe1d0be6347b8ef2427fa629c04485 = realpath($vd6fe1d0be6347b8ef2427fa629c04485);if (!is_dir($vd6fe1d0be6347b8ef2427fa629c04485)) {return false;}$v736007832d2167baaae763fd3a3f3cf1 = opendir($vd6fe1d0be6347b8ef2427fa629c04485);while (($vbe8f80182e0c983916da7338c2c1c040 = readdir($v736007832d2167baaae763fd3a3f3cf1)) !== false) {if ($vbe8f80182e0c983916da7338c2c1c040 == "." || $vbe8f80182e0c983916da7338c2c1c040 == "..") {continue;}return false;}if (is_writable($vd6fe1d0be6347b8ef2427fa629c04485)) {return false;}$v2405a5d61f2f462a1371b33338295c09 = realpath($vd6fe1d0be6347b8ef2427fa629c04485 . "/../");rmdir($vd6fe1d0be6347b8ef2427fa629c04485);$this->deleteFolderIfEmpty($v2405a5d61f2f462a1371b33338295c09);return true;}public static function getExpireTime() {$v3f48301f2668ec4eec370518ddcffe63 = mainConfiguration::getInstance();switch ($v3f48301f2668ec4eec370518ddcffe63->get('cache', 'static.mode')) {case 'test': {return 10;}case 'short': {return 10 * 60;}case 'long': {return 3600 * 2 * 365;}default: {return 3600 * 24;}}}public function isUserGuest() {return Service::Auth()    ->isLoginAsGuest();}public function isNeedToUseCache() {if (!$this->enabled) {return false;}if ($this->isAdmin) {return false;}if (!$this->isAllowedRequest()) {return false;}if (!$this->isUserGuest()) {return false;}if (count($_POST) > 0) {return false;}return true;}public function load() {$v2245023265ae4cf87d02c8b6ba991139 = $this->config;$vf5ff5d5b5b4c9e0d71455ae2afb95b85 = $this->cacheFilePath;$v402057acf8b85f96287136ae594be0cb = file_exists($vf5ff5d5b5b4c9e0d71455ae2afb95b85);$vcd91e7679d575a2c548bd2c889c23b9e = self::getExpireTime();if ($v402057acf8b85f96287136ae594be0cb && (filemtime($vf5ff5d5b5b4c9e0d71455ae2afb95b85) + $vcd91e7679d575a2c548bd2c889c23b9e) < time()) {$this->deleteFileIfExists($vf5ff5d5b5b4c9e0d71455ae2afb95b85);return false;}if (!$this->isNeedToUseCache() || !$v402057acf8b85f96287136ae594be0cb) {return false;}$v9a0364b9e99bb480dd25e1f0284c8555 = trim(file_get_contents($vf5ff5d5b5b4c9e0d71455ae2afb95b85));$vdf5feafab86601ea0e1e6fe6e20df6c5 = 'text/html';if ($v9a0364b9e99bb480dd25e1f0284c8555) {if (!$v2245023265ae4cf87d02c8b6ba991139->get('cache', 'static.ignore-stat')) {$this->saveStatInfo();}$v7f2db423a49b305459147332fb01cf87 = outputBuffer::current();$v7f2db423a49b305459147332fb01cf87->contentType($vdf5feafab86601ea0e1e6fe6e20df6c5);$v7f2db423a49b305459147332fb01cf87->charset('utf-8');$v7f2db423a49b305459147332fb01cf87->clear();$v7f2db423a49b305459147332fb01cf87->push($v9a0364b9e99bb480dd25e1f0284c8555);if ($v2245023265ae4cf87d02c8b6ba991139->get('cache', 'static.debug')) {$vac201fd270c3b96beab24f2829780ab2 = <<<HTML
<!-- Load from static cache -->
HTML;     $v7f2db423a49b305459147332fb01cf87->push($vac201fd270c3b96beab24f2829780ab2);}$v7f2db423a49b305459147332fb01cf87->end();}}public function isAllowedRequest() {$v8d6c391e7cb39133c91b73281a24f21f = Service::CacheKeyValidatorFactory()    ->create('BlackList');return $v8d6c391e7cb39133c91b73281a24f21f->isValid($this->requestUri);}public function save($v9a0364b9e99bb480dd25e1f0284c8555) {if (!$this->isNeedToUseCache() || !$v9a0364b9e99bb480dd25e1f0284c8555) {return false;}$vd6fe1d0be6347b8ef2427fa629c04485 = $this->cacheFilePath;file_put_contents($vd6fe1d0be6347b8ef2427fa629c04485, $v9a0364b9e99bb480dd25e1f0284c8555);@chmod($vd6fe1d0be6347b8ef2427fa629c04485, 0777);}protected function isMobileCache() {return (Service::Request()->isMobile() &&    (bool) $this->config->get('cache', 'static.cache-for-mobile-devices'));}protected function prepareCacheFile() {$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 = $this->cacheFolder;if ($this->requestUri != '__splash') {$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 .= $this->requestUri;}if (mb_substr($vcbf56cfaa0d6ce4269c1e0ab4f5eeff4, -1) != '/') {$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 .= '/';}if ($this->isMobileCache()) {$vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 .= 'mobile/';}$vcb423dbc0d39eaf2392d7e258b11545c = $vcbf56cfaa0d6ce4269c1e0ab4f5eeff4 . 'index.html';if (!$this->isAdmin && $this->createDirectory($vcbf56cfaa0d6ce4269c1e0ab4f5eeff4) == false) {return false;}return $vcb423dbc0d39eaf2392d7e258b11545c;}protected function createDirectory($vd6fe1d0be6347b8ef2427fa629c04485) {$vd6fe1d0be6347b8ef2427fa629c04485 = preg_replace('~/{2,}~', '/', $vd6fe1d0be6347b8ef2427fa629c04485);return is_dir($vd6fe1d0be6347b8ef2427fa629c04485) ? is_writable($vd6fe1d0be6347b8ef2427fa629c04485) : mkdir($vd6fe1d0be6347b8ef2427fa629c04485, 0777, true);}protected function deleteFileIfExists($v47826cacc65c665212b821e6ff80b9b0) {if (!is_file($v47826cacc65c665212b821e6ff80b9b0)) {return true;}return is_writable($v47826cacc65c665212b821e6ff80b9b0) ? unlink($v47826cacc65c665212b821e6ff80b9b0) : false;}protected function saveStatInfo() {$v8b1dc169bf460ee884fceef66c6607d6 = cmsController::getInstance();$v8b1dc169bf460ee884fceef66c6607d6->analyzePath();$va55bfe58c5374dd01c2bd30c25648906 = $v8b1dc169bf460ee884fceef66c6607d6->getModule("stat");if ($va55bfe58c5374dd01c2bd30c25648906 instanceof stat) {$va55bfe58c5374dd01c2bd30c25648906->pushStat();}}}