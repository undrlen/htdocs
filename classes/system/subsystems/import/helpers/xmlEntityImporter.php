<?php
 use UmiCms\Service;use UmiCms\System\Orm\Entity\iExchange;use UmiCms\System\Import\UmiDump\Entity\iBaseImporter;use UmiCms\System\Import\UmiDump\Helper\Entity\iSourceIdBinder;class xmlEntityImporter implements iBaseImporter {private $parser;private $relations;private $result;private $forcedDomainId;private $changeFilePathCallback;public function __construct(DOMXPath $v3643b86326b2ffcc0a085b4dd3a4309b, iSourceIdBinder $v06c5b10273a69992d8c6933e294909fa) {$this->parser = $v3643b86326b2ffcc0a085b4dd3a4309b;$this->relations = $v06c5b10273a69992d8c6933e294909fa;$this->result = [    'created' => 0,    'updated' => 0,    'errors' => [],    'log' => [],   ];}public function import() {$v22a3c602451fa234213b052a9190ea4e = $this->parser->evaluate('/umidump/entities/entity');foreach ($v22a3c602451fa234213b052a9190ea4e as $v904392a19930b5c35e97bfd3c4dac307) {try {$this->importEntity($v904392a19930b5c35e97bfd3c4dac307);}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$this->logError($ve1671797c52e15f763380b45e841ec32->getMessage());}}return $this->getResult();}public function setForcedDomainId($vb80bb7740288fda1f201890375a60c8f) {$this->forcedDomainId = $vb80bb7740288fda1f201890375a60c8f;return $this;}public function setChangeFilePathCallback(callable $v924a8ceeac17f54d3be3f8cdf1c04eb2) {$this->changeFilePathCallback = $v924a8ceeac17f54d3be3f8cdf1c04eb2;return $this;}public function getSourceIdBinder() {return $this->relations;}public function logCreated($vb80bb7740288fda1f201890375a60c8f) {$this->result['log'][] = getLabel('label-entity') . " ({$vb80bb7740288fda1f201890375a60c8f}) " . getLabel('label-has-been-created-f');$this->result['created'] += 1;return $this;}public function logUpdated($vb80bb7740288fda1f201890375a60c8f) {$this->result['log'][] = getLabel('label-entity') . " ({$vb80bb7740288fda1f201890375a60c8f}) " . getLabel('label-has-been-updated-f');$this->result['updated'] += 1;return $this;}public function logError($v78e731027d8fd50ed642340b7c9a63b3) {$this->result['errors'][] = $v78e731027d8fd50ed642340b7c9a63b3;return $this;}public function getResult() {return $this->result;}private function importEntity(DOMElement $v904392a19930b5c35e97bfd3c4dac307) {$vb80bb7740288fda1f201890375a60c8f = $this->getRequiredAttribute($v904392a19930b5c35e97bfd3c4dac307, 'id');$v0f096338b64a1d1b348b86df38313c01 = $this->getRequiredAttribute($v904392a19930b5c35e97bfd3c4dac307, 'service');$v22884db148f0ffb0d830ba431102b0b5 = $v904392a19930b5c35e97bfd3c4dac307->getAttribute('module');if (is_string($v22884db148f0ffb0d830ba431102b0b5) && !empty($v22884db148f0ffb0d830ba431102b0b5)) {cmsController::getInstance()     ->getModule($v22884db148f0ffb0d830ba431102b0b5);}$vaaabf0d39951f3e6c3e8a7911df524c2 = $this->getService($v0f096338b64a1d1b348b86df38313c01);$v74693d2fc58b46bd06410f278e39aa71 = $this->getEntityProperties($v904392a19930b5c35e97bfd3c4dac307);$v86dce043678952b27d5b27a5296f020c = $v904392a19930b5c35e97bfd3c4dac307->getAttribute('install-only');if ($vaaabf0d39951f3e6c3e8a7911df524c2 instanceof iExchange) {$v74693d2fc58b46bd06410f278e39aa71['id'] = $vb80bb7740288fda1f201890375a60c8f;$v74693d2fc58b46bd06410f278e39aa71[self::INSTALL_ONLY_FLAG] = $v86dce043678952b27d5b27a5296f020c;$vaaabf0d39951f3e6c3e8a7911df524c2->importOne($v74693d2fc58b46bd06410f278e39aa71, $this);return $this;}$vaab9e1de16f38176f86d7a92ba337a8d = $vaaabf0d39951f3e6c3e8a7911df524c2->getMap()->get('EXCHANGE_RELATION_TABLE_NAME');$vb1b26d9d245655a2cf8422f066203b2a = $this->getEntityId($vb80bb7740288fda1f201890375a60c8f, $vaab9e1de16f38176f86d7a92ba337a8d);$v74693d2fc58b46bd06410f278e39aa71 = $vaaabf0d39951f3e6c3e8a7911df524c2->updateRelatedId($v74693d2fc58b46bd06410f278e39aa71, $this->getSourceIdBinder()->getSourceId());$v459a537453bbf223e68093348442bdac = $this->getForcedDomainId();$v55a17d3496ffa3a665d5b97becee86c2 = $this->getChangeFilePathCallback();foreach ($v74693d2fc58b46bd06410f278e39aa71 as $v3c6e0b8a9c15224a8228b9a98ca1531d => $v2063c1608d6e0baf80249c42e2be5804) {if ($v3c6e0b8a9c15224a8228b9a98ca1531d === 'domain_id' && $v459a537453bbf223e68093348442bdac) {$v74693d2fc58b46bd06410f278e39aa71[$v3c6e0b8a9c15224a8228b9a98ca1531d] = $v459a537453bbf223e68093348442bdac;}if ($v3c6e0b8a9c15224a8228b9a98ca1531d === 'image' && is_callable($v55a17d3496ffa3a665d5b97becee86c2)) {$v74693d2fc58b46bd06410f278e39aa71[$v3c6e0b8a9c15224a8228b9a98ca1531d] = call_user_func_array($v55a17d3496ffa3a665d5b97becee86c2, [$v2063c1608d6e0baf80249c42e2be5804]);}}if ($vb1b26d9d245655a2cf8422f066203b2a) {if ($v86dce043678952b27d5b27a5296f020c) {return $this;}$v74693d2fc58b46bd06410f278e39aa71['id'] = $vb1b26d9d245655a2cf8422f066203b2a;$this->update($vb80bb7740288fda1f201890375a60c8f, $v74693d2fc58b46bd06410f278e39aa71, $vaaabf0d39951f3e6c3e8a7911df524c2);}else {$this->create($vb80bb7740288fda1f201890375a60c8f, $v74693d2fc58b46bd06410f278e39aa71, $vaaabf0d39951f3e6c3e8a7911df524c2);}return $this;}private function getRequiredAttribute($v904392a19930b5c35e97bfd3c4dac307, $v3c6e0b8a9c15224a8228b9a98ca1531d) {$vd2eb444e35c0a71f0a85df8194acb5b6 = $v904392a19930b5c35e97bfd3c4dac307->getAttribute($v3c6e0b8a9c15224a8228b9a98ca1531d);if (!$vd2eb444e35c0a71f0a85df8194acb5b6) {throw new importException(getLabel('error-no-entity-attribute', false, $v3c6e0b8a9c15224a8228b9a98ca1531d));}return $vd2eb444e35c0a71f0a85df8194acb5b6;}private function getService($vb068931cc450442b63f5b3d276ea4297) {return Service::get($vb068931cc450442b63f5b3d276ea4297);}private function getEntityId($vb80bb7740288fda1f201890375a60c8f, $vaab9e1de16f38176f86d7a92ba337a8d) {return $this->getSourceIdBinder()->getInternalId($vb80bb7740288fda1f201890375a60c8f, $vaab9e1de16f38176f86d7a92ba337a8d);}private function update($vb80bb7740288fda1f201890375a60c8f, $v74693d2fc58b46bd06410f278e39aa71, $vdb6d9b451b818ccc9a449383f2f0c450) {$result = $vdb6d9b451b818ccc9a449383f2f0c450->import([$v74693d2fc58b46bd06410f278e39aa71]);$v1d78dc8ed51214e518b5114fe24490ae = $vdb6d9b451b818ccc9a449383f2f0c450->getMap();$vce4acafe434b6575927f54bc57c475a4 = $v1d78dc8ed51214e518b5114fe24490ae->get('CREATED_COUNTER_KEY');$vcb8cd26d0fb4b2cc20e847e8e6c0c556 = $v1d78dc8ed51214e518b5114fe24490ae->get('UPDATED_COUNTER_KEY');$vdcac2cfa77a105cbc09299740ab71ecc = $v1d78dc8ed51214e518b5114fe24490ae->get('IMPORT_ERRORS_KEY');if ($result[$vce4acafe434b6575927f54bc57c475a4]) {$this->logCreated($vb80bb7740288fda1f201890375a60c8f);}elseif ($result[$vcb8cd26d0fb4b2cc20e847e8e6c0c556]) {$this->logUpdated($vb80bb7740288fda1f201890375a60c8f);}$va44a1e7f9ba5a541a05348e354ab7a49 = $result[$vdcac2cfa77a105cbc09299740ab71ecc];foreach ($va44a1e7f9ba5a541a05348e354ab7a49 as $vd83a5a8080de341e6551f42e0feece88) {$this->logError($vd83a5a8080de341e6551f42e0feece88);}}private function create($vb80bb7740288fda1f201890375a60c8f, $v74693d2fc58b46bd06410f278e39aa71, $vdb6d9b451b818ccc9a449383f2f0c450) {$vf5e638cc78dd325906c1298a0c21fb6b = $vdb6d9b451b818ccc9a449383f2f0c450->create($v74693d2fc58b46bd06410f278e39aa71);$vaab9e1de16f38176f86d7a92ba337a8d = $vdb6d9b451b818ccc9a449383f2f0c450->getMap()->get('EXCHANGE_RELATION_TABLE_NAME');$this->getSourceIdBinder()->defineRelation($vb80bb7740288fda1f201890375a60c8f, $vf5e638cc78dd325906c1298a0c21fb6b->getId(), $vaab9e1de16f38176f86d7a92ba337a8d);$this->logCreated($vb80bb7740288fda1f201890375a60c8f);}private function getEntityProperties(DOMElement $v904392a19930b5c35e97bfd3c4dac307) {$vca3a34ad419c2f783bc2dbda90d53c41 = [];$vc4d0f9d0bcfa937675892b4cfd81a671 = $v904392a19930b5c35e97bfd3c4dac307->childNodes;foreach ($vc4d0f9d0bcfa937675892b4cfd81a671 as $v96b8eeb9e337bd8704b337b404d62688) {if (!$v96b8eeb9e337bd8704b337b404d62688 instanceof DOMElement) {continue;}$v2063c1608d6e0baf80249c42e2be5804 = ($v96b8eeb9e337bd8704b337b404d62688->nodeValue === '') ? null : $v96b8eeb9e337bd8704b337b404d62688->nodeValue;$vca3a34ad419c2f783bc2dbda90d53c41[$v96b8eeb9e337bd8704b337b404d62688->tagName] = $v2063c1608d6e0baf80249c42e2be5804;}return $vca3a34ad419c2f783bc2dbda90d53c41;}private function getForcedDomainId() {return $this->forcedDomainId;}private function getChangeFilePathCallback() {return $this->changeFilePathCallback;}}