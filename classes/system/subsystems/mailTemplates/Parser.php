<?php
 namespace UmiCms\System\MailTemplates;use iUmiObject;use MailTemplate;use UmiCms\Service;class Parser implements iParser {const FIELD_WRAPPER_SYMBOL = '%';private $template;public function __construct(MailTemplate $v66f6181bcb4cff4cd38fbc804a036db6) {$this->template = $v66f6181bcb4cff4cd38fbc804a036db6;}public function parse(array $v21ffce5b8a6cc8cc6a41448dd69623c9 = [], array $v7beef54c8a75efe23880c9c3bfaf46d7 = []) {$v21ffce5b8a6cc8cc6a41448dd69623c9 = $this->stripSpecialCharacters($v21ffce5b8a6cc8cc6a41448dd69623c9);$vea5c81a3845840be5b424c1f2a6c860f = array_filter($v21ffce5b8a6cc8cc6a41448dd69623c9, function ($veca07335a33c5aeb5e1bc7c98b4b9d80) {return !is_array($veca07335a33c5aeb5e1bc7c98b4b9d80);});$vaba6fe61631d2971fd864efbf9b4a46b = array_filter($v21ffce5b8a6cc8cc6a41448dd69623c9, 'is_array');$v9a0364b9e99bb480dd25e1f0284c8555 = $this->parseRootVariables($vea5c81a3845840be5b424c1f2a6c860f);$v9a0364b9e99bb480dd25e1f0284c8555 = $this->parseObjectFields($v9a0364b9e99bb480dd25e1f0284c8555, $v7beef54c8a75efe23880c9c3bfaf46d7);return $this->parseRecursiveVariables($v9a0364b9e99bb480dd25e1f0284c8555, $vaba6fe61631d2971fd864efbf9b4a46b, $v7beef54c8a75efe23880c9c3bfaf46d7);}private function stripSpecialCharacters($v21ffce5b8a6cc8cc6a41448dd69623c9) {if (!is_array($v21ffce5b8a6cc8cc6a41448dd69623c9)) {return $v21ffce5b8a6cc8cc6a41448dd69623c9;}foreach (array_keys($v21ffce5b8a6cc8cc6a41448dd69623c9) as $v06e3d36fa30cea095545139854ad1fb9) {$v2063c1608d6e0baf80249c42e2be5804 = $v21ffce5b8a6cc8cc6a41448dd69623c9[$v06e3d36fa30cea095545139854ad1fb9];unset($v21ffce5b8a6cc8cc6a41448dd69623c9[$v06e3d36fa30cea095545139854ad1fb9]);$v06e3d36fa30cea095545139854ad1fb9 = preg_replace('/^\W*(\w+)\W*$/', '$1', $v06e3d36fa30cea095545139854ad1fb9);$v21ffce5b8a6cc8cc6a41448dd69623c9[$v06e3d36fa30cea095545139854ad1fb9] = $this->stripSpecialCharacters($v2063c1608d6e0baf80249c42e2be5804);}return $v21ffce5b8a6cc8cc6a41448dd69623c9;}private function parseRootVariables(array $v21ffce5b8a6cc8cc6a41448dd69623c9) {$vd05b6ed7d2345020440df396d6da7f73 = array_keys($v21ffce5b8a6cc8cc6a41448dd69623c9);$vf09cc7ee3a9a93273f4b80601cafb00c = array_values($v21ffce5b8a6cc8cc6a41448dd69623c9);$vd0e0c3ab351b07a793d3d05c399aca8a = array_map(function ($v2063c1608d6e0baf80249c42e2be5804) {return self::FIELD_WRAPPER_SYMBOL . $v2063c1608d6e0baf80249c42e2be5804 . self::FIELD_WRAPPER_SYMBOL;}, $vd05b6ed7d2345020440df396d6da7f73);return str_replace($vd0e0c3ab351b07a793d3d05c399aca8a, $vf09cc7ee3a9a93273f4b80601cafb00c, $this->template->getContent());}private function parseRecursiveVariables($v9a0364b9e99bb480dd25e1f0284c8555, array $v21ffce5b8a6cc8cc6a41448dd69623c9, $v7beef54c8a75efe23880c9c3bfaf46d7) {while (preg_match('/%parse\.([^%]+)%/', $v9a0364b9e99bb480dd25e1f0284c8555, $v9c28d32df234037773be184dbdafc274, PREG_OFFSET_CAPTURE)) {$vea2b2676c28c0db26d39331a336c6b92 = $v9c28d32df234037773be184dbdafc274[0][1];$v2fa47f7c65fec19cc163b195725e3844 = mb_strlen($v9c28d32df234037773be184dbdafc274[0][0]);list($v918d83c715c19dd93ff49f87e2fae0b3, $v13f88dc44ff0794f441a6e73ebf40826) = explode('.', $v9c28d32df234037773be184dbdafc274[1][0]);$va299646c25d32f257513fa155e771c33 = $this->template     ->getNotification()     ->getTemplateByName($v918d83c715c19dd93ff49f87e2fae0b3);$vf5300127f646a4550bc4a04fbe393e79 = $this->parseTemplateList($va299646c25d32f257513fa155e771c33, $v21ffce5b8a6cc8cc6a41448dd69623c9[$v13f88dc44ff0794f441a6e73ebf40826], $v7beef54c8a75efe23880c9c3bfaf46d7);$v9a0364b9e99bb480dd25e1f0284c8555 = substr_replace($v9a0364b9e99bb480dd25e1f0284c8555, $vf5300127f646a4550bc4a04fbe393e79, $vea2b2676c28c0db26d39331a336c6b92, $v2fa47f7c65fec19cc163b195725e3844);}return $v9a0364b9e99bb480dd25e1f0284c8555;}private function parseTemplateList($v66f6181bcb4cff4cd38fbc804a036db6, array $vd2cf103077b0cd5467ba560e0c2ac41a, array $v7beef54c8a75efe23880c9c3bfaf46d7) {if (!$v66f6181bcb4cff4cd38fbc804a036db6 instanceof MailTemplate) {return '';}$v9a0364b9e99bb480dd25e1f0284c8555 = [];foreach ($vd2cf103077b0cd5467ba560e0c2ac41a as $v21ffce5b8a6cc8cc6a41448dd69623c9) {$v9a0364b9e99bb480dd25e1f0284c8555[] = $v66f6181bcb4cff4cd38fbc804a036db6->parse($v21ffce5b8a6cc8cc6a41448dd69623c9, $v7beef54c8a75efe23880c9c3bfaf46d7);}return implode("\n", $v9a0364b9e99bb480dd25e1f0284c8555);}private function parseObjectFields($v9a0364b9e99bb480dd25e1f0284c8555, array $v7beef54c8a75efe23880c9c3bfaf46d7) {while (preg_match('/%((?!parse\.)[\w\-]+\.[^%]+)%/', $v9a0364b9e99bb480dd25e1f0284c8555, $v9c28d32df234037773be184dbdafc274, PREG_OFFSET_CAPTURE)) {$vea2b2676c28c0db26d39331a336c6b92 = $v9c28d32df234037773be184dbdafc274[0][1];$v2fa47f7c65fec19cc163b195725e3844 = mb_strlen($v9c28d32df234037773be184dbdafc274[0][0]);$vfe849c56c0fad0b0cea83bfda0e8f490 = explode('.', $v9c28d32df234037773be184dbdafc274[1][0]);list($v6b9cabb4eeb65f66097d5658f2a92258, $v972bf3f05d14ffbdb817bef60638ff00, $vd2a9eea7f92a144ec124b10c0a9efcab) = array_pad($vfe849c56c0fad0b0cea83bfda0e8f490, 3, '');$va8cfde6331bd59eb2ac96f8911c4b666 = $this->getObject($v6b9cabb4eeb65f66097d5658f2a92258, $v7beef54c8a75efe23880c9c3bfaf46d7);$v2063c1608d6e0baf80249c42e2be5804 = ($va8cfde6331bd59eb2ac96f8911c4b666 instanceof iUmiObject) ? $this->getFieldValue($va8cfde6331bd59eb2ac96f8911c4b666, $v972bf3f05d14ffbdb817bef60638ff00, $vd2a9eea7f92a144ec124b10c0a9efcab) : '';$v9a0364b9e99bb480dd25e1f0284c8555 = substr_replace($v9a0364b9e99bb480dd25e1f0284c8555, $v2063c1608d6e0baf80249c42e2be5804, $vea2b2676c28c0db26d39331a336c6b92, $v2fa47f7c65fec19cc163b195725e3844);}return $v9a0364b9e99bb480dd25e1f0284c8555;}private function getObject($v6b9cabb4eeb65f66097d5658f2a92258, array $v7beef54c8a75efe23880c9c3bfaf46d7) {$vbb0e5453232ea82d5243b2122131de01 = $this->template->getVariableForRelatedTypeList();$vc4b80de5b80300601d8d109c2260ddd5 = isset($vbb0e5453232ea82d5243b2122131de01[$v6b9cabb4eeb65f66097d5658f2a92258]) ? $vbb0e5453232ea82d5243b2122131de01[$v6b9cabb4eeb65f66097d5658f2a92258] : [$v6b9cabb4eeb65f66097d5658f2a92258];foreach ($v7beef54c8a75efe23880c9c3bfaf46d7 as $va8cfde6331bd59eb2ac96f8911c4b666) {if (!$va8cfde6331bd59eb2ac96f8911c4b666 instanceof iUmiObject) {continue;}$v726e8e4809d4c1b28a6549d86436a124 = $va8cfde6331bd59eb2ac96f8911c4b666->getType();if (!$v726e8e4809d4c1b28a6549d86436a124 instanceof \iUmiObjectType) {continue;}$v2aa3b95fffa7fee478c11e57e2c53047 = $v726e8e4809d4c1b28a6549d86436a124->getGUID();$va08f2aee9de301619776deb6fee83e50 = $v726e8e4809d4c1b28a6549d86436a124->getParentId();$v2d167696e35bbbaa2b026d0ffbbeaf68 = \umiObjectTypesCollection::getInstance()     ->getType($va08f2aee9de301619776deb6fee83e50);$v71b5718811b7a3755a94134ef6356b5e = $v2d167696e35bbbaa2b026d0ffbbeaf68 ? $v2d167696e35bbbaa2b026d0ffbbeaf68->getGUID() : '';foreach ($vc4b80de5b80300601d8d109c2260ddd5 as $v87300a2707489dfdf139e7268fde018d) {if ($v2aa3b95fffa7fee478c11e57e2c53047 == $v87300a2707489dfdf139e7268fde018d || $v71b5718811b7a3755a94134ef6356b5e == $v87300a2707489dfdf139e7268fde018d) {return $va8cfde6331bd59eb2ac96f8911c4b666;}}}return null;}private function getFieldValue(iUmiObject $va8cfde6331bd59eb2ac96f8911c4b666, $v972bf3f05d14ffbdb817bef60638ff00, $vd2a9eea7f92a144ec124b10c0a9efcab = '') {$v06e3d36fa30cea095545139854ad1fb9 = $va8cfde6331bd59eb2ac96f8911c4b666->getPropByName($v972bf3f05d14ffbdb817bef60638ff00);if (!$v06e3d36fa30cea095545139854ad1fb9 instanceof \iUmiObjectProperty) {return '';}$v319e2726bcc98302437312a8ebfe9deb = $va8cfde6331bd59eb2ac96f8911c4b666->getValue($v972bf3f05d14ffbdb817bef60638ff00);switch ($v06e3d36fa30cea095545139854ad1fb9->getDataType()) {case 'boolean':     return $this->getBooleanFieldValue($v319e2726bcc98302437312a8ebfe9deb);case 'file':    case 'video':    case 'img_file':     return $this->getImageFieldValue($v319e2726bcc98302437312a8ebfe9deb);case 'relation':     return $this->getRelationFieldValue($v06e3d36fa30cea095545139854ad1fb9, $vd2a9eea7f92a144ec124b10c0a9efcab);case 'tags':     return $this->getTagsFieldValue($v319e2726bcc98302437312a8ebfe9deb);case 'optioned':     return $this->getOptionedFieldValue($v06e3d36fa30cea095545139854ad1fb9);default:     return $va8cfde6331bd59eb2ac96f8911c4b666->getValue($v972bf3f05d14ffbdb817bef60638ff00);}}private function getBooleanFieldValue($v319e2726bcc98302437312a8ebfe9deb) {return $v319e2726bcc98302437312a8ebfe9deb    ? getLabel('boolean-yes', 'umiNotifications')    : getLabel('boolean-no', 'umiNotifications');}private function getImageFieldValue($v319e2726bcc98302437312a8ebfe9deb) {$vad5f82e879a9c5d6b5b442eb37e50551 = Service::DomainDetector()->detectHost();return getServerProtocol() . '://' . $vad5f82e879a9c5d6b5b442eb37e50551 . $v319e2726bcc98302437312a8ebfe9deb;}private function getRelationFieldValue(\iUmiObjectProperty $v06e3d36fa30cea095545139854ad1fb9, $vd2a9eea7f92a144ec124b10c0a9efcab = '') {$vbb7827c1d06a998c6ac9588f39b1c4d8 = $this->getGuideItemList($v06e3d36fa30cea095545139854ad1fb9->getFieldId());$v319e2726bcc98302437312a8ebfe9deb = $v06e3d36fa30cea095545139854ad1fb9->getValue();$vcf18563b2faa9f3635cd5ad27a53fa1e = \umiObjectsCollection::getInstance();$va8cfde6331bd59eb2ac96f8911c4b666 = $vcf18563b2faa9f3635cd5ad27a53fa1e->getById($v319e2726bcc98302437312a8ebfe9deb);if ($va8cfde6331bd59eb2ac96f8911c4b666 instanceof iUmiObject && $vd2a9eea7f92a144ec124b10c0a9efcab !== '') {return $this->getFieldValue($va8cfde6331bd59eb2ac96f8911c4b666, $vd2a9eea7f92a144ec124b10c0a9efcab);}$result = [];if (!$v06e3d36fa30cea095545139854ad1fb9->getIsMultiple()) {return $this->getItemValue($vbb7827c1d06a998c6ac9588f39b1c4d8, $v319e2726bcc98302437312a8ebfe9deb);}foreach ($v319e2726bcc98302437312a8ebfe9deb as $vb80bb7740288fda1f201890375a60c8f) {$result[] = $this->getItemValue($vbb7827c1d06a998c6ac9588f39b1c4d8, $vb80bb7740288fda1f201890375a60c8f);}return implode(', ', $result);}private function getOptionedFieldValue(\iUmiObjectProperty $v06e3d36fa30cea095545139854ad1fb9) {$vbb7827c1d06a998c6ac9588f39b1c4d8 = $this->getGuideItemList($v06e3d36fa30cea095545139854ad1fb9->getFieldId());$result = [];foreach ($v06e3d36fa30cea095545139854ad1fb9->getValue() as $vef3e30e070f70244fd6578d88a6b77ac) {$v3362c2e683feb614336ab0f41324ec57 = $this->getItemValue($vbb7827c1d06a998c6ac9588f39b1c4d8, $vef3e30e070f70244fd6578d88a6b77ac['rel']);$result[] = "$v3362c2e683feb614336ab0f41324ec57: {$vef3e30e070f70244fd6578d88a6b77ac['float']}" ;}return implode("\n", $result);}private function getGuideItemList($v945100186b119048837b9859c2c46410) {$v52eb29c6d8ea0d3a5bb3654f49bbd7c7 = \umiFieldsCollection::getInstance()    ->getField($v945100186b119048837b9859c2c46410)    ->getGuideId();return \umiObjectsCollection::getInstance()    ->getGuidedItems($v52eb29c6d8ea0d3a5bb3654f49bbd7c7);}private function getTagsFieldValue($v319e2726bcc98302437312a8ebfe9deb) {return implode(', ', $v319e2726bcc98302437312a8ebfe9deb);}private function getItemValue($vbb7827c1d06a998c6ac9588f39b1c4d8, $vb80bb7740288fda1f201890375a60c8f) {return isset($vbb7827c1d06a998c6ac9588f39b1c4d8[$vb80bb7740288fda1f201890375a60c8f]) ? $vbb7827c1d06a998c6ac9588f39b1c4d8[$vb80bb7740288fda1f201890375a60c8f] : '';}}