<?php
 namespace UmiCms\System\Orm\Entity;use UmiCms\System\Orm\iEntity;use UmiCms\System\Orm\Entity\Repository\iHistory;use UmiCms\System\Orm\Entity\Mapper\tInjector as tMapperInjector;use UmiCms\System\Orm\Entity\Schema\tInjector as tSchemaInjector;use UmiCms\System\Orm\Entity\Factory\tInjector as tFactoryInjector;use UmiCms\System\Orm\Entity\Builder\tInjector as tBuilderInjector;use UmiCms\System\Orm\Entity\Attribute\Accessor\tInjector as tAttributeAccessorInjector;abstract class Repository implements iRepository {use tMapperInjector;use tSchemaInjector;use tFactoryInjector;use tBuilderInjector;use tAttributeAccessorInjector;private $connection;private $history;public function __construct(   \IConnection $v4717d53ebfdfea8477f780ec66151dcb,   iHistory $v3cd15f8f2940aff879df34df4e5c2cd1,   iSchema $vc9550d5fad73447fc24ba47f95d1c6b7,   iAccessor $v9efcb42ee143be09c45d33ed2fba175b,   iFactory $v9549dd6065d019211460c59a86dd6536,   iBuilder $vc87a8ca60f0891b79d192fa86f019916  ) {$this->setConnection($v4717d53ebfdfea8477f780ec66151dcb)    ->setHistory($v3cd15f8f2940aff879df34df4e5c2cd1)    ->setSchema($vc9550d5fad73447fc24ba47f95d1c6b7)    ->setAttributeAccessor($v9efcb42ee143be09c45d33ed2fba175b)    ->setFactory($v9549dd6065d019211460c59a86dd6536)    ->setBuilder($vc87a8ca60f0891b79d192fa86f019916);}public function get($vb80bb7740288fda1f201890375a60c8f) {$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT * FROM `$vaab9e1de16f38176f86d7a92ba337a8d` WHERE `id` = $vb80bb7740288fda1f201890375a60c8f LIMIT 0,1;
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a)    ->setFetchAssoc();$vf5e638cc78dd325906c1298a0c21fb6b = $this->mapEntity($result);if ($vf5e638cc78dd325906c1298a0c21fb6b instanceof iEntity) {$this->getHistory()     ->logGet(iMapper::ID, $vf5e638cc78dd325906c1298a0c21fb6b->getId());}return $vf5e638cc78dd325906c1298a0c21fb6b;}public function getAll() {$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT * FROM `$vaab9e1de16f38176f86d7a92ba337a8d`;
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a)    ->setFetchAssoc();$v8e4a156539e5e358472044b3e46a1fa1 = $this->mapEntityList($result);$this->logGetAll($v8e4a156539e5e358472044b3e46a1fa1);return $v8e4a156539e5e358472044b3e46a1fa1;}public function getListByIdList(array $v5a2576254d428ddc22a03fac145c8749) {return $this->getListByValueList(iMapper::ID, $v5a2576254d428ddc22a03fac145c8749);}public function getListByValueList($vb068931cc450442b63f5b3d276ea4297, array $v993fcb1e163e40a45771f626d3ea0f0f) {if (isEmptyArray($v993fcb1e163e40a45771f626d3ea0f0f)) {return [];}$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$v77cf30aff0e4d03af400f7152de113c2 = $this->glueValueListCondition($v993fcb1e163e40a45771f626d3ea0f0f);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT * FROM `$vaab9e1de16f38176f86d7a92ba337a8d` WHERE `$vb068931cc450442b63f5b3d276ea4297` IN $v77cf30aff0e4d03af400f7152de113c2;
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a)    ->setFetchAssoc();$v8e4a156539e5e358472044b3e46a1fa1 = $this->mapEntityList($result);if (count($v8e4a156539e5e358472044b3e46a1fa1) > 0) {$this->getHistory()     ->logGet($vb068931cc450442b63f5b3d276ea4297, $v993fcb1e163e40a45771f626d3ea0f0f);}return $v8e4a156539e5e358472044b3e46a1fa1;}public function getListBy($vb068931cc450442b63f5b3d276ea4297, $v2063c1608d6e0baf80249c42e2be5804) {$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v85a806d506f3f95ce987b9f3f579e7dc = $v4717d53ebfdfea8477f780ec66151dcb->escape($vb068931cc450442b63f5b3d276ea4297);$v704c580ebcb03db9ee84b85d4cef9244 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v2063c1608d6e0baf80249c42e2be5804);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT * FROM `$vaab9e1de16f38176f86d7a92ba337a8d` WHERE `$v85a806d506f3f95ce987b9f3f579e7dc` = '$v704c580ebcb03db9ee84b85d4cef9244';
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a)    ->setFetchAssoc();$v8e4a156539e5e358472044b3e46a1fa1 = $this->mapEntityList($result);if (!isEmptyArray($v8e4a156539e5e358472044b3e46a1fa1)) {$this->getHistory()     ->logGet($vb068931cc450442b63f5b3d276ea4297, $v2063c1608d6e0baf80249c42e2be5804);}return $v8e4a156539e5e358472044b3e46a1fa1;}public function save(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {if (!$this->isValidEntity($vf5e638cc78dd325906c1298a0c21fb6b)) {throw new \ErrorException('Incorrect entity given');}if ($vf5e638cc78dd325906c1298a0c21fb6b->hasId()) {$vf5e638cc78dd325906c1298a0c21fb6b = $this->update($vf5e638cc78dd325906c1298a0c21fb6b);}else {$vf5e638cc78dd325906c1298a0c21fb6b = $this->create($vf5e638cc78dd325906c1298a0c21fb6b);}return $vf5e638cc78dd325906c1298a0c21fb6b->setUpdated(false);}public function delete($vb80bb7740288fda1f201890375a60c8f) {if (!is_numeric($vb80bb7740288fda1f201890375a60c8f)) {return $this;}$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `$vaab9e1de16f38176f86d7a92ba337a8d` WHERE `id` = $vb80bb7740288fda1f201890375a60c8f;
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);if ($v4717d53ebfdfea8477f780ec66151dcb->affectedRows()) {$this->getHistory()     ->logDelete($vb80bb7740288fda1f201890375a60c8f);}return $this;}public function deleteList(array $v5a2576254d428ddc22a03fac145c8749) {if (isEmptyArray($v5a2576254d428ddc22a03fac145c8749)) {return $this;}$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$veff1dac249aac914ac0ee0454b070750 = $this->glueValueListCondition($v5a2576254d428ddc22a03fac145c8749);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `$vaab9e1de16f38176f86d7a92ba337a8d` WHERE `id` IN $veff1dac249aac914ac0ee0454b070750;
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);if ($v4717d53ebfdfea8477f780ec66151dcb->affectedRows()) {$v3cd15f8f2940aff879df34df4e5c2cd1 = $this->getHistory();foreach ($v5a2576254d428ddc22a03fac145c8749 as $vb80bb7740288fda1f201890375a60c8f) {$v3cd15f8f2940aff879df34df4e5c2cd1->logDelete($vb80bb7740288fda1f201890375a60c8f);}}return $this;}public function clear() {$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `$vaab9e1de16f38176f86d7a92ba337a8d`;
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}public function getHistory() {return $this->history;}protected function getTable() {return $this->getSchema()->getContainerName();}abstract protected function isValidEntity($vf5e638cc78dd325906c1298a0c21fb6b);protected function mapEntity(\IQueryResult $v26d59e24afcb9c11f03ffe8392b68734) {if ($v26d59e24afcb9c11f03ffe8392b68734->length() === 0) {return null;}$vf5e638cc78dd325906c1298a0c21fb6b = $this->getFactory()    ->create();$v6dd047148d685270458ecc44ee128a4d = $v26d59e24afcb9c11f03ffe8392b68734->fetch();return $this->getBuilder()    ->buildAttributesList($vf5e638cc78dd325906c1298a0c21fb6b, $v6dd047148d685270458ecc44ee128a4d);}protected function mapEntityList(\IQueryResult $v26d59e24afcb9c11f03ffe8392b68734) {$result = [];if ($v26d59e24afcb9c11f03ffe8392b68734->length() === 0) {return $result;}$v9549dd6065d019211460c59a86dd6536 = $this->getFactory();$vc87a8ca60f0891b79d192fa86f019916 = $this->getBuilder();foreach ($v26d59e24afcb9c11f03ffe8392b68734 as $vf1965a857bc285d26fe22023aa5ab50d) {$vf5e638cc78dd325906c1298a0c21fb6b = $v9549dd6065d019211460c59a86dd6536->create();$vc87a8ca60f0891b79d192fa86f019916->buildAttributesList($vf5e638cc78dd325906c1298a0c21fb6b, $vf1965a857bc285d26fe22023aa5ab50d);$result[] = $vf5e638cc78dd325906c1298a0c21fb6b;}return $result;}protected function update(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {if (!$vf5e638cc78dd325906c1298a0c21fb6b->isUpdated()) {return $vf5e638cc78dd325906c1298a0c21fb6b;}$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$v3f9178c25b78ed8bed19091bcb62e266 = $this->getUpdateCondition($vf5e638cc78dd325906c1298a0c21fb6b);$vb80bb7740288fda1f201890375a60c8f = (int) $vf5e638cc78dd325906c1298a0c21fb6b->getId();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
UPDATE `$vaab9e1de16f38176f86d7a92ba337a8d` SET $v3f9178c25b78ed8bed19091bcb62e266 WHERE `id` = $vb80bb7740288fda1f201890375a60c8f;
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);if ($v4717d53ebfdfea8477f780ec66151dcb->affectedRows()) {$this->getHistory()     ->logUpdate($vb80bb7740288fda1f201890375a60c8f);}return $vf5e638cc78dd325906c1298a0c21fb6b;}protected function getUpdateCondition(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {$v3f9178c25b78ed8bed19091bcb62e266 = '';foreach ($this->getEscapedRow($vf5e638cc78dd325906c1298a0c21fb6b) as $v6a992d5529f459a44fee58c733255e86 => $v2063c1608d6e0baf80249c42e2be5804) {$v2063c1608d6e0baf80249c42e2be5804 = ($v2063c1608d6e0baf80249c42e2be5804 === null) ? 'NULL' : "'$v2063c1608d6e0baf80249c42e2be5804'";$v3f9178c25b78ed8bed19091bcb62e266 .= " `$v6a992d5529f459a44fee58c733255e86` = $v2063c1608d6e0baf80249c42e2be5804,";}return rtrim($v3f9178c25b78ed8bed19091bcb62e266, ',');}protected function getEscapedRow(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {$v4209ae65645472477d5389fe6ba7c0fa = $this->getAttributeAccessor();$vf1965a857bc285d26fe22023aa5ab50d = [];$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();foreach ($v4209ae65645472477d5389fe6ba7c0fa->accessOneToAll($vf5e638cc78dd325906c1298a0c21fb6b) as $v6a992d5529f459a44fee58c733255e86 => $v2063c1608d6e0baf80249c42e2be5804) {$vf1965a857bc285d26fe22023aa5ab50d[$v6a992d5529f459a44fee58c733255e86] = ($v2063c1608d6e0baf80249c42e2be5804 === null) ? $v2063c1608d6e0baf80249c42e2be5804 : $v4717d53ebfdfea8477f780ec66151dcb->escape($v2063c1608d6e0baf80249c42e2be5804);}return $vf1965a857bc285d26fe22023aa5ab50d;}protected function create(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {$vaab9e1de16f38176f86d7a92ba337a8d = $this->getTable();$v3f9178c25b78ed8bed19091bcb62e266 = $this->getInsertCondition($vf5e638cc78dd325906c1298a0c21fb6b);$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO `$vaab9e1de16f38176f86d7a92ba337a8d` $v3f9178c25b78ed8bed19091bcb62e266
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vb80bb7740288fda1f201890375a60c8f = $v4717d53ebfdfea8477f780ec66151dcb->insertId();$this->getHistory()    ->logCreate($vb80bb7740288fda1f201890375a60c8f);return $vf5e638cc78dd325906c1298a0c21fb6b->setId($vb80bb7740288fda1f201890375a60c8f);}protected function getInsertCondition(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {$vfeb5e66b6e13d46d6d261718e4bb27c2 = $this->getEscapedRow($vf5e638cc78dd325906c1298a0c21fb6b);$v69fe4aec8073954bf273e3113edd24cf = array_keys($vfeb5e66b6e13d46d6d261718e4bb27c2);$v3f9178c25b78ed8bed19091bcb62e266 = '(`' . implode('`, `', $v69fe4aec8073954bf273e3113edd24cf) . '`)';$v993fcb1e163e40a45771f626d3ea0f0f = [];foreach ($vfeb5e66b6e13d46d6d261718e4bb27c2 as $v6a992d5529f459a44fee58c733255e86 => $v2063c1608d6e0baf80249c42e2be5804) {$v993fcb1e163e40a45771f626d3ea0f0f[] = ($v2063c1608d6e0baf80249c42e2be5804 === null) ? 'NULL' : "'$v2063c1608d6e0baf80249c42e2be5804'";}return $v3f9178c25b78ed8bed19091bcb62e266 . ' VALUES (' . implode(', ', $v993fcb1e163e40a45771f626d3ea0f0f) . ')';}protected function glueValueListCondition(array $v5a2576254d428ddc22a03fac145c8749) {if (isEmptyArray($v5a2576254d428ddc22a03fac145c8749)) {return '()';}$v5a2576254d428ddc22a03fac145c8749 = array_map(function($vb80bb7740288fda1f201890375a60c8f) {return $this->getConnection()->escape($vb80bb7740288fda1f201890375a60c8f);}, $v5a2576254d428ddc22a03fac145c8749);$v5a2576254d428ddc22a03fac145c8749 = array_unique($v5a2576254d428ddc22a03fac145c8749);return "('" . implode("', '", $v5a2576254d428ddc22a03fac145c8749) . "')";}protected function logGetAll(array $v8e4a156539e5e358472044b3e46a1fa1) {$v3cd15f8f2940aff879df34df4e5c2cd1 = $this->getHistory();if (!isEmptyArray($v8e4a156539e5e358472044b3e46a1fa1)) {$v3cd15f8f2940aff879df34df4e5c2cd1->logGetAll(count($v8e4a156539e5e358472044b3e46a1fa1));}$v4209ae65645472477d5389fe6ba7c0fa = $this->getAttributeAccessor();foreach ($v8e4a156539e5e358472044b3e46a1fa1 as $vf5e638cc78dd325906c1298a0c21fb6b) {foreach ($v4209ae65645472477d5389fe6ba7c0fa->accessOneToAll($vf5e638cc78dd325906c1298a0c21fb6b) as $vb068931cc450442b63f5b3d276ea4297 => $v2063c1608d6e0baf80249c42e2be5804) {$v3cd15f8f2940aff879df34df4e5c2cd1->logGet($vb068931cc450442b63f5b3d276ea4297, $v2063c1608d6e0baf80249c42e2be5804);}}return $this;}protected function getConnection() {return $this->connection;}protected function setConnection(\IConnection $v4717d53ebfdfea8477f780ec66151dcb) {$this->connection = $v4717d53ebfdfea8477f780ec66151dcb;return $this;}protected function setHistory(iHistory $v3cd15f8f2940aff879df34df4e5c2cd1) {$this->history = $v3cd15f8f2940aff879df34df4e5c2cd1;return $this;}}