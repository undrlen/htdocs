<?php
 namespace UmiCms\System\Trade\Offer;use \iUmiObject as iObject;use \iUmiObjectType as iType;use UmiCms\System\Orm\iEntity;use UmiCms\System\Trade\iOffer;use UmiCms\System\Orm\Entity\Facade as AbstractFacade;use UmiCms\System\Trade\Stock\iBalance as iStockBalance;use UmiCms\System\Trade\Offer\Price\iFacade as iOfferPriceFacade;use UmiCms\System\Trade\Stock\Balance\iFacade as iStockBalanceFacade;use UmiCms\System\Trade\Offer\Data\Object\Type\iFacade as iTypeFacade;use UmiCms\System\Trade\Offer\Data\Object\iFacade as iDataObjectFacade;use UmiCms\System\Trade\Offer\Vendor\Code\iGenerator as VendorCodeGenerator;class Facade extends AbstractFacade implements iFacade  {private $dataObjectFacade;private $offerPriceFacade;private $vendorCodeGenerator;private $typeFacade;private $stockBalanceFacade;public function create(array $v6dd047148d685270458ecc44ee128a4d = []) {if (!isset($v6dd047148d685270458ecc44ee128a4d[iMapper::NAME])) {throw new \ErrorException('Trade offer name expected');}$v585be0ab2e7b8c75397b0d047a05925d = $this->getTypeFacade();if (!isset($v6dd047148d685270458ecc44ee128a4d[iMapper::TYPE_ID])) {$v6dd047148d685270458ecc44ee128a4d[iMapper::TYPE_ID] = $v585be0ab2e7b8c75397b0d047a05925d     ->getRootType()     ->getId();}else {$v599dcce2998a6b40b1e38e8c6006cb0a = $v585be0ab2e7b8c75397b0d047a05925d->get($v6dd047148d685270458ecc44ee128a4d[iMapper::TYPE_ID]);if (!$v599dcce2998a6b40b1e38e8c6006cb0a instanceof iType) {throw new \ErrorException('Incorrect trade offer type id given');}}$vd60db28d94d538bbb249dcc7f2273ab1 = parent::create($v6dd047148d685270458ecc44ee128a4d);if (!$vd60db28d94d538bbb249dcc7f2273ab1->hasDataObjectId()) {$v7beebf4251f2ace3d8e03527fe1bf86e = $this->getDataObjectFacade()     ->createByOffer($vd60db28d94d538bbb249dcc7f2273ab1);$vd60db28d94d538bbb249dcc7f2273ab1->setDataObject($v7beebf4251f2ace3d8e03527fe1bf86e);}if (!$vd60db28d94d538bbb249dcc7f2273ab1->hasVendorCode()) {$v5e7411aadb2b5c499e8b08bad3d8621d = $this->getVendorCodeGenerator()     ->generate($vd60db28d94d538bbb249dcc7f2273ab1);$vd60db28d94d538bbb249dcc7f2273ab1->setVendorCode($v5e7411aadb2b5c499e8b08bad3d8621d);}if ($vd60db28d94d538bbb249dcc7f2273ab1->isUpdated()) {$this->save($vd60db28d94d538bbb249dcc7f2273ab1);}return $vd60db28d94d538bbb249dcc7f2273ab1;}public function createForProduct(iObject $vf5bf48aa40cad7891eb709fcf1fde128) {return $this->create([    iMapper::TYPE_ID => $vf5bf48aa40cad7891eb709fcf1fde128->getTypeId(),    iMapper::NAME => $vf5bf48aa40cad7891eb709fcf1fde128->getName()   ]);}public function save(iEntity $vd60db28d94d538bbb249dcc7f2273ab1) {parent::save($vd60db28d94d538bbb249dcc7f2273ab1);$vb80bb7740288fda1f201890375a60c8f = $vd60db28d94d538bbb249dcc7f2273ab1->getId();$vd60db28d94d538bbb249dcc7f2273ab1 = parent::get($vb80bb7740288fda1f201890375a60c8f);if ($vd60db28d94d538bbb249dcc7f2273ab1->hasDataObjectId()) {$this->saveDataObject($vd60db28d94d538bbb249dcc7f2273ab1);}$v1ce04e66ebc23f41470794a384368c39 = $this->getOfferPriceFacade();foreach ($v1ce04e66ebc23f41470794a384368c39->getCollectionByOffer($vb80bb7740288fda1f201890375a60c8f) as $v78a5eb43deef9a7b5b9ce157b9d52ac4) {$v1ce04e66ebc23f41470794a384368c39->save($v78a5eb43deef9a7b5b9ce157b9d52ac4);}$vc5285befd935249bfe0fc854ec704bc2 = $this->getStockBalanceFacade();foreach ($vc5285befd935249bfe0fc854ec704bc2->getCollectionByOffer($vb80bb7740288fda1f201890375a60c8f) as $vaaf14eb24c59ba6c7c896e44745d6155) {$vc5285befd935249bfe0fc854ec704bc2->save($vaaf14eb24c59ba6c7c896e44745d6155);}return $this;}public function delete($vb80bb7740288fda1f201890375a60c8f) {$vd60db28d94d538bbb249dcc7f2273ab1 = parent::get($vb80bb7740288fda1f201890375a60c8f);if ($this->isValidEntity($vd60db28d94d538bbb249dcc7f2273ab1) && $vd60db28d94d538bbb249dcc7f2273ab1->hasDataObjectId()) {try {$this->getDataObjectFacade()      ->delete($vd60db28d94d538bbb249dcc7f2273ab1->getDataObjectId());}catch (\ErrorException $v42552b1f133f9f8eb406d4f306ea9fd1) {}}$v1ce04e66ebc23f41470794a384368c39 = $this->getOfferPriceFacade();$vdee4fc532b4c7477015b62f27cb58ef2 = [];foreach ($v1ce04e66ebc23f41470794a384368c39->getCollectionByOffer($vb80bb7740288fda1f201890375a60c8f) as $v78a5eb43deef9a7b5b9ce157b9d52ac4) {$vdee4fc532b4c7477015b62f27cb58ef2[] = $v78a5eb43deef9a7b5b9ce157b9d52ac4->getId();}$v1ce04e66ebc23f41470794a384368c39->deleteList($vdee4fc532b4c7477015b62f27cb58ef2);$vc5285befd935249bfe0fc854ec704bc2 = $this->getStockBalanceFacade();$va4c83538af0509d7a5da173f04d131a7 = [];foreach ($vc5285befd935249bfe0fc854ec704bc2->getCollectionByOffer($vb80bb7740288fda1f201890375a60c8f) as $vaaf14eb24c59ba6c7c896e44745d6155) {$va4c83538af0509d7a5da173f04d131a7[] = $vaaf14eb24c59ba6c7c896e44745d6155->getId();}$vc5285befd935249bfe0fc854ec704bc2->deleteList($va4c83538af0509d7a5da173f04d131a7);return parent::delete($vb80bb7740288fda1f201890375a60c8f);}public function copy(iEntity $v36cd38f49b9afa08222c0dc9ebfe35eb) {$v6dd047148d685270458ecc44ee128a4d = $this->extractAttributeList($v36cd38f49b9afa08222c0dc9ebfe35eb);unset($v6dd047148d685270458ecc44ee128a4d[iMapper::ID]);unset($v6dd047148d685270458ecc44ee128a4d[iMapper::VENDOR_CODE]);unset($v6dd047148d685270458ecc44ee128a4d[iMapper::ORDER]);$v12cba3ee81cf4a793796a51b6327c678 = $this->create($v6dd047148d685270458ecc44ee128a4d);try {$v2e2ea6a28d66517a4b0811d956f4d89e = $this->getDataObjectFacade();$v1083b46552e9151eb86637decfca9028 = $v2e2ea6a28d66517a4b0811d956f4d89e->get($v36cd38f49b9afa08222c0dc9ebfe35eb->getDataObjectId());if ($v1083b46552e9151eb86637decfca9028 instanceof iObject) {$v890b7edb6e2701a225449d2963d28a05 = $v2e2ea6a28d66517a4b0811d956f4d89e->copy($v1083b46552e9151eb86637decfca9028);$v12cba3ee81cf4a793796a51b6327c678->setDataObjectId($v890b7edb6e2701a225449d2963d28a05->getId());}$v5e7411aadb2b5c499e8b08bad3d8621d = $this->getVendorCodeGenerator()     ->generate($v12cba3ee81cf4a793796a51b6327c678);$v12cba3ee81cf4a793796a51b6327c678->setVendorCode($v5e7411aadb2b5c499e8b08bad3d8621d);$this->save($v12cba3ee81cf4a793796a51b6327c678);$v1ce04e66ebc23f41470794a384368c39 = $this->getOfferPriceFacade();foreach ($v1ce04e66ebc23f41470794a384368c39->getCollectionByOffer($v36cd38f49b9afa08222c0dc9ebfe35eb->getId()) as $vbc5c000c7bc709c2cd740610365fdaca) {$v537af1f50bc4d8140811f484427f01d3 = $v1ce04e66ebc23f41470794a384368c39->copy($vbc5c000c7bc709c2cd740610365fdaca);$v537af1f50bc4d8140811f484427f01d3->setOfferId($v12cba3ee81cf4a793796a51b6327c678->getId());$v1ce04e66ebc23f41470794a384368c39->save($v537af1f50bc4d8140811f484427f01d3);}$vc5285befd935249bfe0fc854ec704bc2 = $this->getStockBalanceFacade();foreach ($vc5285befd935249bfe0fc854ec704bc2->getCollectionByOffer($v36cd38f49b9afa08222c0dc9ebfe35eb->getId()) as $vaaf14eb24c59ba6c7c896e44745d6155) {$v6e8d12f04857ea73c05db1f793108e88 = $vc5285befd935249bfe0fc854ec704bc2->copy($vaaf14eb24c59ba6c7c896e44745d6155);$v6e8d12f04857ea73c05db1f793108e88->setOfferId($v12cba3ee81cf4a793796a51b6327c678->getId());$vc5285befd935249bfe0fc854ec704bc2->save($v6e8d12f04857ea73c05db1f793108e88);}}catch (\Exception $v42552b1f133f9f8eb406d4f306ea9fd1) {if ($v12cba3ee81cf4a793796a51b6327c678 instanceof iOffer) {$this->delete($v12cba3ee81cf4a793796a51b6327c678->getId());}throw $v42552b1f133f9f8eb406d4f306ea9fd1;}return $v12cba3ee81cf4a793796a51b6327c678;}public function moveCollectionByMode(iCollection $vdb6d9b451b818ccc9a449383f2f0c450, iOffer $v7f68e4246e70eb166a53a18203a6fbcb, $v15d61712450a686a7f365adf4fef581f) {if (!in_array($v15d61712450a686a7f365adf4fef581f, $this->getMoveModeList())) {throw new \ErrorException('Invalid move mode given');}switch ($v15d61712450a686a7f365adf4fef581f) {case self::MOVE_MODE_BEFORE_ENTITY : {return $this->moveCollectionBefore($vdb6d9b451b818ccc9a449383f2f0c450, $v7f68e4246e70eb166a53a18203a6fbcb);}case self::MOVE_MODE_AFTER_ENTITY : {return $this->moveCollectionAfter($vdb6d9b451b818ccc9a449383f2f0c450, $v7f68e4246e70eb166a53a18203a6fbcb);}default : {throw new \ErrorException('Unexpected move mode');}}}public function moveCollectionAfter(iCollection $vdb6d9b451b818ccc9a449383f2f0c450, iOffer $v7f68e4246e70eb166a53a18203a6fbcb) {$v88268c4937b86c4e794288845b28f9ce = $v7f68e4246e70eb166a53a18203a6fbcb->getOrder();$v6192211e0f25726086a582dd30a60dd2 = $v88268c4937b86c4e794288845b28f9ce;foreach ($vdb6d9b451b818ccc9a449383f2f0c450 as $vf722caa2322c2affaa5868714d66cf69) {$this->changeOrderIndex($vf722caa2322c2affaa5868714d66cf69, $v6192211e0f25726086a582dd30a60dd2, function($v6a992d5529f459a44fee58c733255e86) {return $v6a992d5529f459a44fee58c733255e86 + 1;});}return $this;}public function moveCollectionBefore(iCollection $vdb6d9b451b818ccc9a449383f2f0c450, iOffer $v7f68e4246e70eb166a53a18203a6fbcb) {$v88268c4937b86c4e794288845b28f9ce = $v7f68e4246e70eb166a53a18203a6fbcb->getOrder();$v6192211e0f25726086a582dd30a60dd2 = $v88268c4937b86c4e794288845b28f9ce;foreach ($vdb6d9b451b818ccc9a449383f2f0c450 as $vf722caa2322c2affaa5868714d66cf69) {$this->changeOrderIndex($vf722caa2322c2affaa5868714d66cf69, $v6192211e0f25726086a582dd30a60dd2, function($v6a992d5529f459a44fee58c733255e86) {return $v6a992d5529f459a44fee58c733255e86 - 1;});}return $this;}public function setDataObjectFacade(iDataObjectFacade $v00c169d5e8a598d3908199ef8c64c279) {$this->dataObjectFacade = $v00c169d5e8a598d3908199ef8c64c279;return $this;}public function setOfferPriceFacade(iOfferPriceFacade $v00c169d5e8a598d3908199ef8c64c279) {$this->offerPriceFacade = $v00c169d5e8a598d3908199ef8c64c279;return $this;}public function setVendorCoderGenerator(VendorCodeGenerator $vdac9630aec642a428cd73f4be0a03569) {$this->vendorCodeGenerator = $vdac9630aec642a428cd73f4be0a03569;return $this;}public function setTypeFacade(iTypeFacade $v585be0ab2e7b8c75397b0d047a05925d) {$this->typeFacade = $v585be0ab2e7b8c75397b0d047a05925d;return $this;}public function setStockBalanceFacade(iStockBalanceFacade $vc5285befd935249bfe0fc854ec704bc2) {$this->stockBalanceFacade = $vc5285befd935249bfe0fc854ec704bc2;return $this;}protected function isValidEntity($vf5e638cc78dd325906c1298a0c21fb6b) {return $vf5e638cc78dd325906c1298a0c21fb6b instanceof iEntity;}protected function getMoveModeList() {return [    self::MOVE_MODE_AFTER_ENTITY,    self::MOVE_MODE_BEFORE_ENTITY,   ];}private function changeOrderIndex(iOffer $vd60db28d94d538bbb249dcc7f2273ab1, &$vb8e4e90b3f95b19320583770cc2b0380, callable $vff112a0b44b145cd1426c18aae3a3c74) {$vb8e4e90b3f95b19320583770cc2b0380 = $vff112a0b44b145cd1426c18aae3a3c74($vb8e4e90b3f95b19320583770cc2b0380);$vd60db28d94d538bbb249dcc7f2273ab1->setOrder($vb8e4e90b3f95b19320583770cc2b0380);$this->save($vd60db28d94d538bbb249dcc7f2273ab1);}private function saveDataObject(iOffer $vd60db28d94d538bbb249dcc7f2273ab1) {$v2e2ea6a28d66517a4b0811d956f4d89e = $this->getDataObjectFacade();$v7beebf4251f2ace3d8e03527fe1bf86e = $v2e2ea6a28d66517a4b0811d956f4d89e->get($vd60db28d94d538bbb249dcc7f2273ab1->getDataObjectId());if ($v7beebf4251f2ace3d8e03527fe1bf86e instanceof iObject) {$v2e2ea6a28d66517a4b0811d956f4d89e->save($v7beebf4251f2ace3d8e03527fe1bf86e);}return $this;}private function getDataObjectFacade() {return $this->dataObjectFacade;}private function getOfferPriceFacade() {return $this->offerPriceFacade;}private function getVendorCodeGenerator() {return $this->vendorCodeGenerator;}private function getTypeFacade() {return $this->typeFacade;}private function getStockBalanceFacade() {return $this->stockBalanceFacade;}}