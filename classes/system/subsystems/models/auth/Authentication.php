<?php
 namespace UmiCms\System\Auth;use UmiCms\System\Auth\AuthenticationRules;use UmiCms\System\Session\iSession;class Authentication implements iAuthentication {private $authenticationRulesFactory;private $session;public function __construct(AuthenticationRules\iFactory $v61f095636fba733e5b19c94522e24005, iSession $v21d6f40cfb511982e4424e0e250a9557) {$this->authenticationRulesFactory = $v61f095636fba733e5b19c94522e24005;$this->session = $v21d6f40cfb511982e4424e0e250a9557;}public function authenticate($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99) {$this->validateLogin($vd56b699830e77ba53855679cb1d252da);$this->validatePassword($v5f4dcc3b5aa765d61d8327deb882cf99);$v8e44f0089b076e18a718eb9ca3d94674 = $this->getAuthenticationRulesFactory()    ->createByLoginAndPassword($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99)    ->validate();if ($v8e44f0089b076e18a718eb9ca3d94674 === false) {throw new AuthenticationException("Cannot authenticate user by login = {$vd56b699830e77ba53855679cb1d252da} and password = {$v5f4dcc3b5aa765d61d8327deb882cf99}");}return $v8e44f0089b076e18a718eb9ca3d94674;}public function authenticateByLoginAndHash($vd56b699830e77ba53855679cb1d252da, $v0800fc577294c34e0b28ad2839435945) {$this->validateLogin($vd56b699830e77ba53855679cb1d252da);$this->validatePassword($v0800fc577294c34e0b28ad2839435945);$v8e44f0089b076e18a718eb9ca3d94674 = $this->getAuthenticationRulesFactory()    ->createByLoginAndHash($vd56b699830e77ba53855679cb1d252da, $v0800fc577294c34e0b28ad2839435945)    ->validate();if ($v8e44f0089b076e18a718eb9ca3d94674 === false) {throw new AuthenticationException("Cannot authenticate user by login = {$vd56b699830e77ba53855679cb1d252da} and hash = {$v0800fc577294c34e0b28ad2839435945}");}return $v8e44f0089b076e18a718eb9ca3d94674;}public function authenticateByCode($vc13367945d5d4c91047b3b50234aa7ab) {$this->validateCode($vc13367945d5d4c91047b3b50234aa7ab);$v8e44f0089b076e18a718eb9ca3d94674 = $this->getAuthenticationRulesFactory()    ->createByActivationCode($vc13367945d5d4c91047b3b50234aa7ab)    ->validate();if ($v8e44f0089b076e18a718eb9ca3d94674 === false) {throw new AuthenticationException("Cannot authenticate user by activation code = {$vc13367945d5d4c91047b3b50234aa7ab}");}return $v8e44f0089b076e18a718eb9ca3d94674;}public function authenticateBySocials($vd56b699830e77ba53855679cb1d252da, $v9e9f3d70bd8c8957627eada96d967706) {$this->validateLogin($vd56b699830e77ba53855679cb1d252da);$this->validateProvider($v9e9f3d70bd8c8957627eada96d967706);$v8e44f0089b076e18a718eb9ca3d94674 = $this->getAuthenticationRulesFactory()    ->createByLoginAndProvider($vd56b699830e77ba53855679cb1d252da, $v9e9f3d70bd8c8957627eada96d967706)    ->validate();if ($v8e44f0089b076e18a718eb9ca3d94674 === false) {throw new AuthenticationException("Cannot authenticate user by login = {$vd56b699830e77ba53855679cb1d252da} and provider = {$v9e9f3d70bd8c8957627eada96d967706}");}return $v8e44f0089b076e18a718eb9ca3d94674;}public function authenticateByUserId($v8e44f0089b076e18a718eb9ca3d94674) {$this->validateUserId($v8e44f0089b076e18a718eb9ca3d94674);$v8e44f0089b076e18a718eb9ca3d94674 = $this->getAuthenticationRulesFactory()    ->createByUserId($v8e44f0089b076e18a718eb9ca3d94674)    ->validate();if ($v8e44f0089b076e18a718eb9ca3d94674 === false) {throw new AuthenticationException("Cannot authenticate user by id = {$v8e44f0089b076e18a718eb9ca3d94674}");}return $v8e44f0089b076e18a718eb9ca3d94674;}public function authenticateByRequestParams() {$vd56b699830e77ba53855679cb1d252da = getRequest('u-login');$v5f4dcc3b5aa765d61d8327deb882cf99 = getRequest('u-password');try {return $this->authenticate($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99);}catch (AuthenticationException $v42552b1f133f9f8eb406d4f306ea9fd1) {$v0800fc577294c34e0b28ad2839435945 = getRequest('u-password-md5') ?: getRequest('u-password-hash');$v0800fc577294c34e0b28ad2839435945 = $this->isUmiManagerHash($v0800fc577294c34e0b28ad2839435945) ? '' : $v0800fc577294c34e0b28ad2839435945;return $this->authenticateByLoginAndHash($vd56b699830e77ba53855679cb1d252da, $v0800fc577294c34e0b28ad2839435945);}}public function authenticateByHeaders() {$vd56b699830e77ba53855679cb1d252da = getServer('u-login');$v5f4dcc3b5aa765d61d8327deb882cf99 = getServer('u-password');return $this->authenticate($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99);}public function authenticateByHttpBasic() {$vd56b699830e77ba53855679cb1d252da = getServer('PHP_AUTH_USER');$v5f4dcc3b5aa765d61d8327deb882cf99 = getServer('PHP_AUTH_PW');return $this->authenticate($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99);}public function authenticateByUmiHttpBasic() {$v7eb165150c495ddb045970caf880c6e4 = getRequest('umi_authorization');$vf88fde07ec2f08f79d336c5ed2ee8817 = explode(':', base64_decode(mb_substr($v7eb165150c495ddb045970caf880c6e4, 6)));if (umiCount($vf88fde07ec2f08f79d336c5ed2ee8817) != 2) {throw new WrongCredentialsException('Cannot parse umi_authorization param');}list($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99) = $vf88fde07ec2f08f79d336c5ed2ee8817;return $this->authenticate($vd56b699830e77ba53855679cb1d252da, $v5f4dcc3b5aa765d61d8327deb882cf99);}public function authenticateBySession() {$v8e44f0089b076e18a718eb9ca3d94674 = $this->getSession()    ->get('user_id');return $this->authenticateByUserId($v8e44f0089b076e18a718eb9ca3d94674);}public function authenticateFakeUser($v8e44f0089b076e18a718eb9ca3d94674) {$this->validateUserId($v8e44f0089b076e18a718eb9ca3d94674);$v05bdbe76dd5b2e738afc3539f7b96325 = $this->getAuthenticationRulesFactory()    ->createByFakeUser($v8e44f0089b076e18a718eb9ca3d94674)    ->validate();if ($v05bdbe76dd5b2e738afc3539f7b96325 === false) {throw new AuthenticationException("Cannot authenticate fake user by id = {$v8e44f0089b076e18a718eb9ca3d94674}");}return $v05bdbe76dd5b2e738afc3539f7b96325;}public function authenticateByPreviousUserId() {$v21d6f40cfb511982e4424e0e250a9557 = $this->getSession();if (!$v21d6f40cfb511982e4424e0e250a9557->get('fake-user')) {throw new WrongCredentialsException('fake-user flag expected for authenticate by previous user id');}$v8e44f0089b076e18a718eb9ca3d94674 = $v21d6f40cfb511982e4424e0e250a9557->get('old_user_id');return $this->authenticateByUserId($v8e44f0089b076e18a718eb9ca3d94674);}private function validateUserId($v8e44f0089b076e18a718eb9ca3d94674) {if (!is_int($v8e44f0089b076e18a718eb9ca3d94674) || $v8e44f0089b076e18a718eb9ca3d94674 <= 0) {throw new WrongCredentialsException('Wrong user id given, integer > 0 expected');}}private function validateLogin($vd56b699830e77ba53855679cb1d252da) {$this->validateNotEmptyString($vd56b699830e77ba53855679cb1d252da, 'login');}private function validatePassword($v5f4dcc3b5aa765d61d8327deb882cf99) {$this->validateNotEmptyString($v5f4dcc3b5aa765d61d8327deb882cf99, 'password');}private function validateProvider($v9e9f3d70bd8c8957627eada96d967706) {$this->validateNotEmptyString($v9e9f3d70bd8c8957627eada96d967706, 'provider');}private function validateCode($vc13367945d5d4c91047b3b50234aa7ab) {$this->validateNotEmptyString($vc13367945d5d4c91047b3b50234aa7ab, 'activation code');}private function validateNotEmptyString($vb45cffe084dd3d20d928bee85e7b0f21, $vb068931cc450442b63f5b3d276ea4297) {if (!is_string($vb45cffe084dd3d20d928bee85e7b0f21) || $vb45cffe084dd3d20d928bee85e7b0f21 === '') {throw new WrongCredentialsException("Wrong user {$vb068931cc450442b63f5b3d276ea4297} given, not empty string expected");}}private function getAuthenticationRulesFactory() {return $this->authenticationRulesFactory;}private function getSession() {return $this->session;}private function isUmiManagerHash($v0800fc577294c34e0b28ad2839435945) {return $v0800fc577294c34e0b28ad2839435945 === 'null';}}