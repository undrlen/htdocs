<?php
 use UmiCms\Service;class backupModel extends singleton implements iBackupModel {protected function __construct() {}public static function getInstance($v4a8a08f09d37b73795649038408b5f33 = null) {return parent::getInstance(__CLASS__);}public function getChanges($va6eb4816205178e88dad66a16a19ff45 = false) {$va9205dcfd4a6f7c2cbe8be01566ff84a = Service::Registry();if (!$va9205dcfd4a6f7c2cbe8be01566ff84a->get('modules/backup/enabled')) {return false;}$vaa9f73eea60a006820d0f8768bc8a3fc = (int) $va9205dcfd4a6f7c2cbe8be01566ff84a->get('//modules/backup/max_save_actions');$vbae06316313152c3dd23cc012ff88343 = (int) $va9205dcfd4a6f7c2cbe8be01566ff84a->get('//modules/backup/max_timelimit');$vc5b5790b8b74a68d0cde09c8f1080fc5 = $vbae06316313152c3dd23cc012ff88343 * 3600 * 24;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$va6eb4816205178e88dad66a16a19ff45 = (int) $va6eb4816205178e88dad66a16a19ff45;$vaa9f73eea60a006820d0f8768bc8a3fc = ($vaa9f73eea60a006820d0f8768bc8a3fc > 2) ? $vaa9f73eea60a006820d0f8768bc8a3fc : 2;$vac5c74b64b4b8352ef2f181affb5ac2a =    "SELECT id, ctime, changed_module, user_id, is_active FROM cms_backup WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 . "' AND (" .    time() . '-ctime)<' . $vc5b5790b8b74a68d0cde09c8f1080fc5 . " ORDER BY ctime DESC LIMIT {$vaa9f73eea60a006820d0f8768bc8a3fc}";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);if ($result->length() < 2) {$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT id, ctime, changed_module, user_id, is_active FROM cms_backup WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 .     "' ORDER BY ctime DESC LIMIT 2";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);}$v21ffce5b8a6cc8cc6a41448dd69623c9 = [];$vdf347a373b8f92aa0ae3dd920a5ec2f6 = [];$result->setFetchType(IQueryResult::FETCH_ASSOC);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v76383df3d587e927e7477f796135b77e = $this->getChangeInfo(     $vf1965a857bc285d26fe22023aa5ab50d['id'],     $vf1965a857bc285d26fe22023aa5ab50d['ctime'],     $vf1965a857bc285d26fe22023aa5ab50d['changed_module'],     $va6eb4816205178e88dad66a16a19ff45,     $vf1965a857bc285d26fe22023aa5ab50d['user_id'],     $vf1965a857bc285d26fe22023aa5ab50d['is_active']    );if (count($v76383df3d587e927e7477f796135b77e)) {$vdf347a373b8f92aa0ae3dd920a5ec2f6[] = $v76383df3d587e927e7477f796135b77e;}}$v21ffce5b8a6cc8cc6a41448dd69623c9['nodes:revision'] = $vdf347a373b8f92aa0ae3dd920a5ec2f6;return $v21ffce5b8a6cc8cc6a41448dd69623c9;}public function getOverdueChanges($v84e03446728f3b83ee9440e5b4e52fb1 = 30) {if ($v84e03446728f3b83ee9440e5b4e52fb1 === 0) {return [];}$vf4954029b8440447930f092c4781aff8 = 24 * 3600;$vb72919118534641d7e15719a8ce1397d = $v84e03446728f3b83ee9440e5b4e52fb1 * $vf4954029b8440447930f092c4781aff8;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v64528587ef7dc674387251756cccd6d7 = <<<QUERY
				SELECT *
				FROM   `cms_backup` 
				WHERE  `ctime` < unix_timestamp() - ${vb72919118534641d7e15719a8ce1397d};
QUERY;   $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($v64528587ef7dc674387251756cccd6d7);$result->setFetchType(IQueryResult::FETCH_ASSOC);$v5a9d18bb87ff12835dc844883c5c3ebe = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v5a9d18bb87ff12835dc844883c5c3ebe[] = new backupChange(     $vf1965a857bc285d26fe22023aa5ab50d['id'],     $vf1965a857bc285d26fe22023aa5ab50d['ctime'],     $vf1965a857bc285d26fe22023aa5ab50d['changed_module'],     $vf1965a857bc285d26fe22023aa5ab50d['changed_method'],     $vf1965a857bc285d26fe22023aa5ab50d['param'],     $vf1965a857bc285d26fe22023aa5ab50d['param0'],     $vf1965a857bc285d26fe22023aa5ab50d['user_id'],     $vf1965a857bc285d26fe22023aa5ab50d['is_active']    );}return $v5a9d18bb87ff12835dc844883c5c3ebe;}public function deleteChanges($v5a9d18bb87ff12835dc844883c5c3ebe = []) {if (!is_array($v5a9d18bb87ff12835dc844883c5c3ebe)) {return false;}$ve0f4a10e0eaf8c4d022fb7970f890feb = [];foreach ($v5a9d18bb87ff12835dc844883c5c3ebe as $vde5954cc2b01aa31deedd6a679b37a68) {if ($vde5954cc2b01aa31deedd6a679b37a68 instanceof backupChange) {$ve0f4a10e0eaf8c4d022fb7970f890feb[] = $vde5954cc2b01aa31deedd6a679b37a68->__get('id');}}if (empty($ve0f4a10e0eaf8c4d022fb7970f890feb)) {return false;}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v36bb03c00577049736e662c77ec82c70 = implode($ve0f4a10e0eaf8c4d022fb7970f890feb, ', ');$v089cb4d661ea956d66b6ba3de86b48db = <<<QUERY
				DELETE 
				FROM   `cms_backup` 
				WHERE  `id` IN (${v36bb03c00577049736e662c77ec82c70})
QUERY;   $v4717d53ebfdfea8477f780ec66151dcb->query($v089cb4d661ea956d66b6ba3de86b48db);return true;}public function deletePageChanges($va6eb4816205178e88dad66a16a19ff45) {$va6eb4816205178e88dad66a16a19ff45 = (int) $va6eb4816205178e88dad66a16a19ff45;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `cms_backup` WHERE `param` = $va6eb4816205178e88dad66a16a19ff45
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()    ->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $v4717d53ebfdfea8477f780ec66151dcb->affectedRows();}protected function getChangeInfo($v3d477c1c43140638c8738b94181f5b18, $v1ed2e1b19b6e55d52d2473be17a4afd9, $v2af1c72c36c6bfb90c3118324b1a9118, $va6eb4816205178e88dad66a16a19ff45, $v8e44f0089b076e18a718eb9ca3d94674, $v367e854225a0810977297b3bedb2f309) {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v8b1dc169bf460ee884fceef66c6607d6 = cmsController::getInstance();$v76383df3d587e927e7477f796135b77e = [];$v8e2dcfd7e7e24b1ca76c1193f645902b = $vb81ca7c0ccaa77e7aa91936ab0070695->getElement($va6eb4816205178e88dad66a16a19ff45);if ($v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement) {$v76383df3d587e927e7477f796135b77e['attribute:changetime'] = $v1ed2e1b19b6e55d52d2473be17a4afd9;$v76383df3d587e927e7477f796135b77e['attribute:user-id'] = $v8e44f0089b076e18a718eb9ca3d94674;$v2af1c72c36c6bfb90c3118324b1a9118 = (string) $v2af1c72c36c6bfb90c3118324b1a9118;if ($v2af1c72c36c6bfb90c3118324b1a9118 === '') {$v76383df3d587e927e7477f796135b77e['attribute:is-void'] = true;}if ($v367e854225a0810977297b3bedb2f309) {$v76383df3d587e927e7477f796135b77e['attribute:active'] = 'active';}$v76383df3d587e927e7477f796135b77e['date'] = new umiDate($v1ed2e1b19b6e55d52d2473be17a4afd9);$v76383df3d587e927e7477f796135b77e['author'] = selector::get('object')->id($v8e44f0089b076e18a718eb9ca3d94674);$v76383df3d587e927e7477f796135b77e['link'] = "/admin/backup/rollback/{$v3d477c1c43140638c8738b94181f5b18}/";$v854203cccade0bbe21be239a208aea49 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getModule();$v2fa70149e2a7e75da2b0303d0a36a944 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getMethod();$v22884db148f0ffb0d830ba431102b0b5 = $v8b1dc169bf460ee884fceef66c6607d6->getModule($v854203cccade0bbe21be239a208aea49);if ($v22884db148f0ffb0d830ba431102b0b5 instanceof def_module) {$v807765384d9d5527da8848df14a4f02f = $v22884db148f0ffb0d830ba431102b0b5->getEditLink($va6eb4816205178e88dad66a16a19ff45, $v2fa70149e2a7e75da2b0303d0a36a944);if (isset($v807765384d9d5527da8848df14a4f02f[1])) {$v76383df3d587e927e7477f796135b77e['page'] = [];$v76383df3d587e927e7477f796135b77e['page']['attribute:name'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->getName();$v76383df3d587e927e7477f796135b77e['page']['attribute:edit-link'] = $v807765384d9d5527da8848df14a4f02f[1];$v76383df3d587e927e7477f796135b77e['page']['attribute:link'] = $vb81ca7c0ccaa77e7aa91936ab0070695->getPathById($v8e2dcfd7e7e24b1ca76c1193f645902b->getId());}}}return $v76383df3d587e927e7477f796135b77e;}public function getAllChanges() {if (!Service::Registry()->get('modules/backup/enabled')) {return false;}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<'SQL'
SELECT id, ctime, changed_module, param, user_id, is_active
FROM cms_backup ORDER BY ctime DESC LIMIT 100
SQL;   $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ASSOC);$v21ffce5b8a6cc8cc6a41448dd69623c9 = [];$vdf347a373b8f92aa0ae3dd920a5ec2f6 = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v8bc182b015e0e0749de8158e4343b3da = $this->getChangeInfo(     $vf1965a857bc285d26fe22023aa5ab50d['id'],     $vf1965a857bc285d26fe22023aa5ab50d['ctime'],     $vf1965a857bc285d26fe22023aa5ab50d['changed_module'],     $vf1965a857bc285d26fe22023aa5ab50d['param'],     $vf1965a857bc285d26fe22023aa5ab50d['user_id'],     $vf1965a857bc285d26fe22023aa5ab50d['is_active']    );if (count($v8bc182b015e0e0749de8158e4343b3da)) {$vdf347a373b8f92aa0ae3dd920a5ec2f6[] = $v8bc182b015e0e0749de8158e4343b3da;}}$v21ffce5b8a6cc8cc6a41448dd69623c9['nodes:revision'] = $vdf347a373b8f92aa0ae3dd920a5ec2f6;return $v21ffce5b8a6cc8cc6a41448dd69623c9;}public function save($va6eb4816205178e88dad66a16a19ff45 = '', $v7b975dff6c0134c6f231fd13895c2349 = '', $vb6ad8768e9a35023e3d824c5057699d1 = '') {if (!Service::Registry()->get('//modules/backup/enabled')) {return false;}if (getRequest('rollbacked')) {return false;}$this->restoreIncrement();$v8b1dc169bf460ee884fceef66c6607d6 = cmsController::getInstance();$v7b975dff6c0134c6f231fd13895c2349 = $v7b975dff6c0134c6f231fd13895c2349 ?: $v8b1dc169bf460ee884fceef66c6607d6->getCurrentModule();$v7b975dff6c0134c6f231fd13895c2349 = $v7b975dff6c0134c6f231fd13895c2349 ?: getRequest('module');$vb6ad8768e9a35023e3d824c5057699d1 = $v8b1dc169bf460ee884fceef66c6607d6->getCurrentMethod();$vb6ad8768e9a35023e3d824c5057699d1 = $vb6ad8768e9a35023e3d824c5057699d1 ?: getRequest('method');$vfa53b91ccc1b78668d5af58e1ed3a485 = Service::Auth();$v8e44f0089b076e18a718eb9ca3d94674 = $vfa53b91ccc1b78668d5af58e1ed3a485->getUserId();$v1ed2e1b19b6e55d52d2473be17a4afd9 = time();$vdd8086e8cfd7708cd20d06bf319817dc = [];foreach ($_REQUEST as $v6a992d5529f459a44fee58c733255e86 => $v2063c1608d6e0baf80249c42e2be5804) {if ($v6a992d5529f459a44fee58c733255e86 == 'save-mode') {continue;}$vdd8086e8cfd7708cd20d06bf319817dc[$v6a992d5529f459a44fee58c733255e86] = (!is_array($v2063c1608d6e0baf80249c42e2be5804)) ? base64_encode($v2063c1608d6e0baf80249c42e2be5804) : $v2063c1608d6e0baf80249c42e2be5804;}if (isset($vdd8086e8cfd7708cd20d06bf319817dc['data']['new'])) {$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($va6eb4816205178e88dad66a16a19ff45);if ($v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement) {$vdd8086e8cfd7708cd20d06bf319817dc['data'][$v8e2dcfd7e7e24b1ca76c1193f645902b->getObjectId()] = $vdd8086e8cfd7708cd20d06bf319817dc['data']['new'];unset($vdd8086e8cfd7708cd20d06bf319817dc['data']['new']);}}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vdd8086e8cfd7708cd20d06bf319817dc = serialize($vdd8086e8cfd7708cd20d06bf319817dc);$vdd8086e8cfd7708cd20d06bf319817dc = $v4717d53ebfdfea8477f780ec66151dcb->escape($vdd8086e8cfd7708cd20d06bf319817dc);$va6eb4816205178e88dad66a16a19ff45 = $v4717d53ebfdfea8477f780ec66151dcb->escape($va6eb4816205178e88dad66a16a19ff45);$v7b975dff6c0134c6f231fd13895c2349 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v7b975dff6c0134c6f231fd13895c2349);$vb6ad8768e9a35023e3d824c5057699d1 = $v4717d53ebfdfea8477f780ec66151dcb->escape($vb6ad8768e9a35023e3d824c5057699d1);$vac5c74b64b4b8352ef2f181affb5ac2a = "UPDATE cms_backup SET is_active='0' WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 . "'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO cms_backup (ctime, changed_module, changed_method, param, param0, user_id, is_active)
				VALUES('{$v1ed2e1b19b6e55d52d2473be17a4afd9}', '{$v7b975dff6c0134c6f231fd13895c2349}', '{$vb6ad8768e9a35023e3d824c5057699d1}', '{$va6eb4816205178e88dad66a16a19ff45}', '{$vdd8086e8cfd7708cd20d06bf319817dc}', '{$v8e44f0089b076e18a718eb9ca3d94674}', '1')
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vaa9f73eea60a006820d0f8768bc8a3fc = Service::Registry()->get('//modules/backup/max_save_actions');$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT COUNT(`id`) FROM cms_backup WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 . "' ORDER BY ctime DESC";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$vde656d919add5d3d9019ccfe7eee2ff0 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$vde656d919add5d3d9019ccfe7eee2ff0 = array_shift($v54851b009c5c647ca3e77cc517b8c76c);}$v6a1eea8c8e0dcb15f57825051b0629b7 = $vde656d919add5d3d9019ccfe7eee2ff0 - $vaa9f73eea60a006820d0f8768bc8a3fc;if ($v6a1eea8c8e0dcb15f57825051b0629b7 < 0) {$v6a1eea8c8e0dcb15f57825051b0629b7 = 0;}$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT id FROM cms_backup WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 . "' ORDER BY ctime DESC LIMIT 2";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$v975736d9abdba70140122f735ae3078e = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v975736d9abdba70140122f735ae3078e[] = array_shift($vf1965a857bc285d26fe22023aa5ab50d);}$v0b951629e3502f9eedc07d60d307de11 = '';if (count($v975736d9abdba70140122f735ae3078e)) {$v0b951629e3502f9eedc07d60d307de11 = 'AND id NOT IN (' . implode(', ', $v975736d9abdba70140122f735ae3078e) . ')';}$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM cms_backup WHERE param='$va6eb4816205178e88dad66a16a19ff45' {$v0b951629e3502f9eedc07d60d307de11} ORDER BY ctime ASC LIMIT $v6a1eea8c8e0dcb15f57825051b0629b7";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vbae06316313152c3dd23cc012ff88343 = Service::Registry()->get('//modules/backup/max_timelimit');$vc5b5790b8b74a68d0cde09c8f1080fc5 = $vbae06316313152c3dd23cc012ff88343 * 3600 * 24;$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM cms_backup WHERE param='" . $va6eb4816205178e88dad66a16a19ff45 . "' AND (" . time() . '-ctime)>' . $vc5b5790b8b74a68d0cde09c8f1080fc5 .    " {$v0b951629e3502f9eedc07d60d307de11} ORDER BY ctime ASC";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return true;}public function rollback($v3d477c1c43140638c8738b94181f5b18) {if (!Service::Registry()->get('//modules/backup/enabled')) {return false;}$v3d477c1c43140638c8738b94181f5b18 = (int) $v3d477c1c43140638c8738b94181f5b18;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT param, param0, changed_module, changed_method FROM cms_backup WHERE id='$v3d477c1c43140638c8738b94181f5b18' LIMIT 1";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ASSOC);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v7552cd149af7495ee7d8225974e50f80 = $vf1965a857bc285d26fe22023aa5ab50d['param'];$v8d777f385d3dfec8815d20f7496026dc = $vf1965a857bc285d26fe22023aa5ab50d['param0'];$v2af1c72c36c6bfb90c3118324b1a9118 = $vf1965a857bc285d26fe22023aa5ab50d['changed_module'];$v90f9e7ef6042e1fea914a29474921825 = $vf1965a857bc285d26fe22023aa5ab50d['changed_method'];$v8a3ed86d229f8d8fd5821d143560f34a = $v7552cd149af7495ee7d8225974e50f80;$vac5c74b64b4b8352ef2f181affb5ac2a = "UPDATE cms_backup SET is_active='0' WHERE param='" . $v8a3ed86d229f8d8fd5821d143560f34a . "'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = "UPDATE cms_backup SET is_active='1' WHERE id='" . $v3d477c1c43140638c8738b94181f5b18 . "'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vdd8086e8cfd7708cd20d06bf319817dc = unserialize($v8d777f385d3dfec8815d20f7496026dc);$_REQUEST = [];foreach ($vdd8086e8cfd7708cd20d06bf319817dc as $v6a992d5529f459a44fee58c733255e86 => $v2063c1608d6e0baf80249c42e2be5804) {if (is_array($v2063c1608d6e0baf80249c42e2be5804)) {foreach ($v2063c1608d6e0baf80249c42e2be5804 as $v865c0c0b4ab0e063e5caa3387c1a8741 => $v9e3669d19b675bd57058fd4664205d2a) {$v2063c1608d6e0baf80249c42e2be5804[$v865c0c0b4ab0e063e5caa3387c1a8741] = $v9e3669d19b675bd57058fd4664205d2a;}}else {$v2063c1608d6e0baf80249c42e2be5804 = base64_decode($v2063c1608d6e0baf80249c42e2be5804);}$_REQUEST[$v6a992d5529f459a44fee58c733255e86] = $v2063c1608d6e0baf80249c42e2be5804;$_POST[$v6a992d5529f459a44fee58c733255e86] = $v2063c1608d6e0baf80249c42e2be5804;}$_REQUEST['rollbacked'] = true;$_REQUEST['save-mode'] = getLabel('label-save');if (!$v2b46272d125296ffdc5fa359568fb278 = cmsController::getInstance()->getModule($v2af1c72c36c6bfb90c3118324b1a9118)) {throw new requreMoreAdminPermissionsException("You can't rollback this action. No permission to this module.");}$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7552cd149af7495ee7d8225974e50f80);if ($v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement) {$v807765384d9d5527da8848df14a4f02f = $v2b46272d125296ffdc5fa359568fb278->getEditLink($v7552cd149af7495ee7d8225974e50f80, $v8e2dcfd7e7e24b1ca76c1193f645902b->getMethod());if (umiCount($v807765384d9d5527da8848df14a4f02f) >= 2) {$v98248c827299f5fed27aa8d5a9494032 = $v807765384d9d5527da8848df14a4f02f[1];$_REQUEST['referer'] = $v98248c827299f5fed27aa8d5a9494032;$v98248c827299f5fed27aa8d5a9494032 = trim($v98248c827299f5fed27aa8d5a9494032, '/') . '/do';if (preg_match("/admin\/[A-z]+\/([^\/]+)\//", $v98248c827299f5fed27aa8d5a9494032, $vc68271a63ddbc431c307beb7d2918275)) {if (isset($vc68271a63ddbc431c307beb7d2918275[1])) {$v90f9e7ef6042e1fea914a29474921825 = $vc68271a63ddbc431c307beb7d2918275[1];}}$_REQUEST['path'] = $v98248c827299f5fed27aa8d5a9494032;$_REQUEST['param0'] = $v7552cd149af7495ee7d8225974e50f80;$_REQUEST['param1'] = 'do';}}return $v2b46272d125296ffdc5fa359568fb278->cms_callMethod($v90f9e7ef6042e1fea914a29474921825, []);}}public function addLogMessage($v7552cd149af7495ee7d8225974e50f80) {if (!Service::Registry()->get('//modules/backup/enabled')) {return false;}$this->restoreIncrement();$vfa53b91ccc1b78668d5af58e1ed3a485 = Service::Auth();$v8e44f0089b076e18a718eb9ca3d94674 = $vfa53b91ccc1b78668d5af58e1ed3a485->getUserId();$v07cc694b9b3fc636710fa08b6922c42b = time();$veca07335a33c5aeb5e1bc7c98b4b9d80 = (int) $v7552cd149af7495ee7d8225974e50f80;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO cms_backup (ctime, param, user_id, param0)
VALUES('{$v07cc694b9b3fc636710fa08b6922c42b}', '{$veca07335a33c5aeb5e1bc7c98b4b9d80}', '{$v8e44f0089b076e18a718eb9ca3d94674}', '{$v07cc694b9b3fc636710fa08b6922c42b}')
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return true;}public function fakeBackup($v7552cd149af7495ee7d8225974e50f80) {$v8e2dcfd7e7e24b1ca76c1193f645902b = selector::get('page')->id($v7552cd149af7495ee7d8225974e50f80);if (!($v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement)) {return false;}$v539f42cd378873bb0f9889eff317bafa = $_REQUEST;$va8cfde6331bd59eb2ac96f8911c4b666 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getObject();$v599dcce2998a6b40b1e38e8c6006cb0a = selector::get('object-type')->id($va8cfde6331bd59eb2ac96f8911c4b666->getTypeId());$_REQUEST['name'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->getName();$_REQUEST['alt-name'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->getAltName();$_REQUEST['active'] = $v8e2dcfd7e7e24b1ca76c1193f645902b->getIsActive();foreach ($v599dcce2998a6b40b1e38e8c6006cb0a->getAllFields() as $v06e3d36fa30cea095545139854ad1fb9) {$v972bf3f05d14ffbdb817bef60638ff00 = $v06e3d36fa30cea095545139854ad1fb9->getName();$v2063c1608d6e0baf80249c42e2be5804 = $this->fakeBackupValue($va8cfde6331bd59eb2ac96f8911c4b666, $v06e3d36fa30cea095545139854ad1fb9);if ($v2063c1608d6e0baf80249c42e2be5804 === null) {continue;}$_REQUEST['data'][$va8cfde6331bd59eb2ac96f8911c4b666->getId()][$v972bf3f05d14ffbdb817bef60638ff00] = $v2063c1608d6e0baf80249c42e2be5804;}$this->save($v7552cd149af7495ee7d8225974e50f80, $v8e2dcfd7e7e24b1ca76c1193f645902b->getModule());$_REQUEST = $v539f42cd378873bb0f9889eff317bafa;return true;}protected function fakeBackupValue(iUmiObject $va8cfde6331bd59eb2ac96f8911c4b666, iUmiField $v06e3d36fa30cea095545139854ad1fb9) {$v2063c1608d6e0baf80249c42e2be5804 = $va8cfde6331bd59eb2ac96f8911c4b666->getValue($v06e3d36fa30cea095545139854ad1fb9->getName());switch ($v06e3d36fa30cea095545139854ad1fb9->getDataType()) {case 'file':    case 'img_file':    case 'swf_file':     return ($v2063c1608d6e0baf80249c42e2be5804 instanceof iUmiFile) ? $v2063c1608d6e0baf80249c42e2be5804->getFilePath() : '';case 'boolean':     return $v2063c1608d6e0baf80249c42e2be5804 ? '1' : '0';case 'date':     return ($v2063c1608d6e0baf80249c42e2be5804 instanceof iUmiDate) ? $v2063c1608d6e0baf80249c42e2be5804->getFormattedDate('U') : null;case 'tags':     return is_array($v2063c1608d6e0baf80249c42e2be5804) ? implode(', ', $v2063c1608d6e0baf80249c42e2be5804) : null;default:     return is_array($v2063c1608d6e0baf80249c42e2be5804) ? $v2063c1608d6e0baf80249c42e2be5804 : (string) $v2063c1608d6e0baf80249c42e2be5804;}}protected function restoreIncrement() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v1804956abd21cd701c0e7931d7ebf5df = $v4717d53ebfdfea8477f780ec66151dcb->queryResult('SELECT max( id ) FROM `cms_backup`');$v1804956abd21cd701c0e7931d7ebf5df->setFetchType(IQueryResult::FETCH_ROW);$ve674db5dfaf0af7ad4edaefc84d799a9 = $v1804956abd21cd701c0e7931d7ebf5df->fetch();$v604fe262b965cdecbfe3856ae4ff1a3d = $ve674db5dfaf0af7ad4edaefc84d799a9[0] + 1;$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult("SHOW TABLE STATUS LIKE 'cms_backup'");$result->setFetchType(IQueryResult::FETCH_ARRAY);$vf1965a857bc285d26fe22023aa5ab50d = $result->fetch();$v8c36426826ccf38cedc202042ef32a38 = isset($vf1965a857bc285d26fe22023aa5ab50d['Auto_increment']) ? (int) $vf1965a857bc285d26fe22023aa5ab50d['Auto_increment'] : false;if ($v8c36426826ccf38cedc202042ef32a38 !== false && $v8c36426826ccf38cedc202042ef32a38 != $v604fe262b965cdecbfe3856ae4ff1a3d) {$v4717d53ebfdfea8477f780ec66151dcb->query("ALTER TABLE `cms_backup` AUTO_INCREMENT={$v604fe262b965cdecbfe3856ae4ff1a3d}");}}}