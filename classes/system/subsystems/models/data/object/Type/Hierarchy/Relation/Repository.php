<?php
 namespace UmiCms\System\Data\Object\Type\Hierarchy\Relation;use UmiCms\System\Data\Object\Type\Hierarchy\iRelation;class Repository implements iRepository {private $connection;private $factory;public function __construct(\IConnection $v4717d53ebfdfea8477f780ec66151dcb, iFactory $v9549dd6065d019211460c59a86dd6536) {$this->connection = $v4717d53ebfdfea8477f780ec66151dcb;$this->factory = $v9549dd6065d019211460c59a86dd6536;}public function getChildList($v0b6849d57acb5403d1e63cce49f86ed5) {$vf52d41aa6adb579d526a7e6277ac6534 = $this->getNullOrIdCondition($v0b6849d57acb5403d1e63cce49f86ed5);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id`, `parent_id`, `child_id`, `level`
FROM `cms3_object_type_tree`
WHERE `parent_id` $vf52d41aa6adb579d526a7e6277ac6534
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildRelationList($result);}public function getChildListWithDomain($v0b6849d57acb5403d1e63cce49f86ed5, $v72ee76c5c29383b7c9f9225c1fa4d10b) {$v0b6849d57acb5403d1e63cce49f86ed5 = (int) $v0b6849d57acb5403d1e63cce49f86ed5;$vf52d41aa6adb579d526a7e6277ac6534 = $this->getNullOrIdCondition($v0b6849d57acb5403d1e63cce49f86ed5);$vbf14d04db94110ef7eb9bf81e6cda0af = $this->getDomainIdCondition($v72ee76c5c29383b7c9f9225c1fa4d10b, '`cms3_object_types`.`domain_id`');$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `cms3_object_type_tree`.`id`, `cms3_object_type_tree`.`parent_id`, `child_id`, `level`
FROM `cms3_object_type_tree`
LEFT JOIN `cms3_object_types` ON `cms3_object_type_tree`.`child_id` = `cms3_object_types`.`id`
WHERE `cms3_object_type_tree`.`parent_id` $vf52d41aa6adb579d526a7e6277ac6534 AND $vbf14d04db94110ef7eb9bf81e6cda0af
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildRelationList($result);}public function getNearestChildIdList($v0b6849d57acb5403d1e63cce49f86ed5) {$v0b6849d57acb5403d1e63cce49f86ed5 = (int) $v0b6849d57acb5403d1e63cce49f86ed5;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id` FROM `cms3_object_types` WHERE `parent_id` = $v0b6849d57acb5403d1e63cce49f86ed5
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildIdList($result);}public function getNearestChildIdListWithDomain($v0b6849d57acb5403d1e63cce49f86ed5, $v72ee76c5c29383b7c9f9225c1fa4d10b) {$v0b6849d57acb5403d1e63cce49f86ed5 = (int) $v0b6849d57acb5403d1e63cce49f86ed5;$vbf14d04db94110ef7eb9bf81e6cda0af = $this->getDomainIdCondition($v72ee76c5c29383b7c9f9225c1fa4d10b);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id` FROM `cms3_object_types` WHERE `parent_id` = $v0b6849d57acb5403d1e63cce49f86ed5 AND $vbf14d04db94110ef7eb9bf81e6cda0af
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildIdList($result);}public function getNearestAncestorId($vf4f40123eb510dd3290125b38f4eb898) {$vf4f40123eb510dd3290125b38f4eb898 = (int) $vf4f40123eb510dd3290125b38f4eb898;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `parent_id` FROM `cms3_object_types` WHERE `id` = $vf4f40123eb510dd3290125b38f4eb898 LIMIT 0,1
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildNumberValue($result);}public function getChildListByAncestorIdList(array $v5a2576254d428ddc22a03fac145c8749) {$v5a2576254d428ddc22a03fac145c8749 = $this->prepareIdList($v5a2576254d428ddc22a03fac145c8749);if (isEmptyString($v5a2576254d428ddc22a03fac145c8749)) {return [];}$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id`, `parent_id`, `child_id`, `level`
FROM `cms3_object_type_tree`
WHERE `parent_id` IN ($v5a2576254d428ddc22a03fac145c8749)
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildRelationList($result);}public function getAncestorList($vf4f40123eb510dd3290125b38f4eb898) {$vf4f40123eb510dd3290125b38f4eb898 = (int) $vf4f40123eb510dd3290125b38f4eb898;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id`, `parent_id`, `child_id`, `level`
FROM `cms3_object_type_tree`
WHERE `child_id` = $vf4f40123eb510dd3290125b38f4eb898
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildRelationList($result);}public function createRecursively($v0b6849d57acb5403d1e63cce49f86ed5, $vf4f40123eb510dd3290125b38f4eb898) {$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction('Create object type relation');try {$va951c4e53c6084439a713c266a10339e = $this->getAncestorList($v0b6849d57acb5403d1e63cce49f86ed5);$v77708e6125ba907df6089d4359fc7108 = 0;foreach ($va951c4e53c6084439a713c266a10339e as $v43730ab7a59cd64b02661edf1c346d10) {$v77708e6125ba907df6089d4359fc7108 = max($v77708e6125ba907df6089d4359fc7108, $v43730ab7a59cd64b02661edf1c346d10->getLevel());}$v712f0d055ba9a325dd266c1b040c28a7 = ($v0b6849d57acb5403d1e63cce49f86ed5 == 0) ? 0 : $v77708e6125ba907df6089d4359fc7108 + 1;foreach ($va951c4e53c6084439a713c266a10339e as $v43730ab7a59cd64b02661edf1c346d10) {$this->create($v43730ab7a59cd64b02661edf1c346d10->getParentId(), $vf4f40123eb510dd3290125b38f4eb898, $v712f0d055ba9a325dd266c1b040c28a7);}$v2617c9384e4bb1af369e034ffd4490c9 = $this->create($v0b6849d57acb5403d1e63cce49f86ed5, $vf4f40123eb510dd3290125b38f4eb898, $v712f0d055ba9a325dd266c1b040c28a7);}catch (\databaseException $v42552b1f133f9f8eb406d4f306ea9fd1) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $v42552b1f133f9f8eb406d4f306ea9fd1;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();return $v2617c9384e4bb1af369e034ffd4490c9;}public function create($v0b6849d57acb5403d1e63cce49f86ed5, $vf4f40123eb510dd3290125b38f4eb898, $vc9e9a848920877e76685b2e4e76de38d) {$v0b6849d57acb5403d1e63cce49f86ed5 = ($v0b6849d57acb5403d1e63cce49f86ed5 === 0) ? 'NULL' : (int) $v0b6849d57acb5403d1e63cce49f86ed5;$vf4f40123eb510dd3290125b38f4eb898 = (int) $vf4f40123eb510dd3290125b38f4eb898;$vc9e9a848920877e76685b2e4e76de38d = (int) $vc9e9a848920877e76685b2e4e76de38d;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO `cms3_object_type_tree` (`parent_id`, `child_id`, `level`) VALUES ($v0b6849d57acb5403d1e63cce49f86ed5, $vf4f40123eb510dd3290125b38f4eb898, $vc9e9a848920877e76685b2e4e76de38d) 
ON DUPLICATE KEY UPDATE `parent_id` = $v0b6849d57acb5403d1e63cce49f86ed5, `child_id` = $vf4f40123eb510dd3290125b38f4eb898, `level` = $vc9e9a848920877e76685b2e4e76de38d
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->get($v4717d53ebfdfea8477f780ec66151dcb->insertId());}public function deleteInvolving($v5f694956811487225d15e973ca38fbab) {$v5f694956811487225d15e973ca38fbab = (int) $v5f694956811487225d15e973ca38fbab;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `cms3_object_type_tree` WHERE `parent_id` = $v5f694956811487225d15e973ca38fbab OR `child_id` = $v5f694956811487225d15e973ca38fbab
SQL;   $v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $v4717d53ebfdfea8477f780ec66151dcb->affectedRows() > 0;}public function deleteAll() {$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
TRUNCATE TABLE `cms3_object_type_tree`
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}private function get($vb80bb7740288fda1f201890375a60c8f) {$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `id`, `parent_id`, `child_id`, `level`
FROM `cms3_object_type_tree`
WHERE `id` = $vb80bb7740288fda1f201890375a60c8f
LIMIT 0, 1
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);return $this->buildRelation($result);}private function getDomainIdCondition($v72ee76c5c29383b7c9f9225c1fa4d10b, $v06e3d36fa30cea095545139854ad1fb9 = '`domain_id`') {$v72ee76c5c29383b7c9f9225c1fa4d10b = (int) $v72ee76c5c29383b7c9f9225c1fa4d10b;$v1ddcb92ade31c8fbd370001f9b29a7d9 = ($v72ee76c5c29383b7c9f9225c1fa4d10b > 0) ? "($v06e3d36fa30cea095545139854ad1fb9 %s OR $v06e3d36fa30cea095545139854ad1fb9 IS NULL)" : "$v06e3d36fa30cea095545139854ad1fb9 %s";return sprintf($v1ddcb92ade31c8fbd370001f9b29a7d9, $this->getNullOrIdCondition($v72ee76c5c29383b7c9f9225c1fa4d10b));}private function getNullOrIdCondition($vb80bb7740288fda1f201890375a60c8f) {$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;return ($vb80bb7740288fda1f201890375a60c8f === 0) ? 'IS NULL' : "= $vb80bb7740288fda1f201890375a60c8f";}private function prepareIdList(array $v5a2576254d428ddc22a03fac145c8749) {$v5a2576254d428ddc22a03fac145c8749 = array_map('intval', $v5a2576254d428ddc22a03fac145c8749);$v5a2576254d428ddc22a03fac145c8749 = array_unique($v5a2576254d428ddc22a03fac145c8749);if (isEmptyArray($v5a2576254d428ddc22a03fac145c8749)) {return '';}return implode(',', $v5a2576254d428ddc22a03fac145c8749);}private function buildNumberValue(\IQueryResult $result) {$vf1965a857bc285d26fe22023aa5ab50d = $result->fetch();return (int) is_array($vf1965a857bc285d26fe22023aa5ab50d) ? array_shift($vf1965a857bc285d26fe22023aa5ab50d) : null;}private function buildRelation(\IQueryResult $result) {if ($result->length() === 0) {return null;}$vf1965a857bc285d26fe22023aa5ab50d = $result->setFetchType(\IQueryResult::FETCH_ASSOC)    ->fetch();return $this->getFactory()    ->create($vf1965a857bc285d26fe22023aa5ab50d);}private function buildRelationList(\IQueryResult $result) {if ($result->length() === 0) {return [];}$result->setFetchType(\IQueryResult::FETCH_ASSOC);$v8f860260e98c7b73cb53d4d3eba7f7f8 = [];$v9549dd6065d019211460c59a86dd6536 = $this->getFactory();foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v8f860260e98c7b73cb53d4d3eba7f7f8[] = $v9549dd6065d019211460c59a86dd6536->create($vf1965a857bc285d26fe22023aa5ab50d);}return $v8f860260e98c7b73cb53d4d3eba7f7f8;}private function buildIdList(\IQueryResult $result) {if ($result->length() === 0) {return [];}$result->setFetchType(\IQueryResult::FETCH_ROW);$v5a2576254d428ddc22a03fac145c8749 = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v5a2576254d428ddc22a03fac145c8749[] = (int) array_shift($vf1965a857bc285d26fe22023aa5ab50d);}return $v5a2576254d428ddc22a03fac145c8749;}private function getConnection() {return $this->connection;}private function getFactory() {return $this->factory;}}