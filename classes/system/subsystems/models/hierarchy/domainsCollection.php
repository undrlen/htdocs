<?php
 use UmiCms\Service;use UmiCms\Classes\System\Utils\Idn\iConverter;class domainsCollection implements iDomainsCollection {private $connection;private $idnConverter;private $domainList = [];private $hostMap = [];public function __construct(IConnection $v4717d53ebfdfea8477f780ec66151dcb, iConverter $vb9d9a209340c95b228b7a557bd6ec030) {$this->connection = $v4717d53ebfdfea8477f780ec66151dcb;$this->idnConverter = $vb9d9a209340c95b228b7a557bd6ec030;}public function addDomain($v67b3dba8bc6778101892eb77249db32e, $v694b5b6b5536d28285396c8ce7c268bc = false, $ve558e63f3083922542d8745224a66eea = false, $v66e6283a2d6b70fd594bdf4f315d6074 = false) {$vb80bb7740288fda1f201890375a60c8f = $this->getDomainId($v67b3dba8bc6778101892eb77249db32e);if ($vb80bb7740288fda1f201890375a60c8f) {throw new coreException("Domain #{$v67b3dba8bc6778101892eb77249db32e} already exist.");}$v5a05866850c28651fe234659f6c92ada = Service::LanguageCollection();if (!$v5a05866850c28651fe234659f6c92ada->isExists($v694b5b6b5536d28285396c8ce7c268bc)) {if ($v5a05866850c28651fe234659f6c92ada->getDefaultLang()) {$v694b5b6b5536d28285396c8ce7c268bc = $v5a05866850c28651fe234659f6c92ada->getDefaultLang()->getId();}else {throw new coreException("Language $v694b5b6b5536d28285396c8ce7c268bc doesn't exist.");}}$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Create domain {$v67b3dba8bc6778101892eb77249db32e}");try {$ve558e63f3083922542d8745224a66eea = (int) $ve558e63f3083922542d8745224a66eea;$v66e6283a2d6b70fd594bdf4f315d6074 = (int) $v66e6283a2d6b70fd594bdf4f315d6074;$v694b5b6b5536d28285396c8ce7c268bc = (int) $v694b5b6b5536d28285396c8ce7c268bc;$vac5c74b64b4b8352ef2f181affb5ac2a = "INSERT INTO `cms3_domains` VALUES (null, '%s', %d, %d, %d, null)";$vac5c74b64b4b8352ef2f181affb5ac2a = sprintf($vac5c74b64b4b8352ef2f181affb5ac2a, $v67b3dba8bc6778101892eb77249db32e, $ve558e63f3083922542d8745224a66eea, $v694b5b6b5536d28285396c8ce7c268bc, $v66e6283a2d6b70fd594bdf4f315d6074);$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vb80bb7740288fda1f201890375a60c8f = $v4717d53ebfdfea8477f780ec66151dcb->insertId();$vad5f82e879a9c5d6b5b442eb37e50551 = new domain($vb80bb7740288fda1f201890375a60c8f);$vad5f82e879a9c5d6b5b442eb37e50551->setHost($v67b3dba8bc6778101892eb77249db32e);$vad5f82e879a9c5d6b5b442eb37e50551->setIsDefault($ve558e63f3083922542d8745224a66eea);$vad5f82e879a9c5d6b5b442eb37e50551->setDefaultLangId($v694b5b6b5536d28285396c8ce7c268bc);$vad5f82e879a9c5d6b5b442eb37e50551->setUsingSsl($v66e6283a2d6b70fd594bdf4f315d6074);$vad5f82e879a9c5d6b5b442eb37e50551->commit();}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();$this->setDomain($vad5f82e879a9c5d6b5b442eb37e50551);if ($ve558e63f3083922542d8745224a66eea) {$this->setDefaultDomain($vb80bb7740288fda1f201890375a60c8f);}return $vb80bb7740288fda1f201890375a60c8f;}public function delDomain($vb80bb7740288fda1f201890375a60c8f) {if (!$this->isExists($vb80bb7740288fda1f201890375a60c8f)) {throw new coreException("Domain #{$vb80bb7740288fda1f201890375a60c8f} doesn't exist.");}$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Delete domain #{$vb80bb7740288fda1f201890375a60c8f}");try {$vad5f82e879a9c5d6b5b442eb37e50551 = $this->getDomain($vb80bb7740288fda1f201890375a60c8f);$vad5f82e879a9c5d6b5b442eb37e50551->delAllMirrors();$v817f7de13f58df29b13a9570082097da = (int) $vb80bb7740288fda1f201890375a60c8f;$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM `cms3_domains` WHERE `id` = $v817f7de13f58df29b13a9570082097da";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();$this->unsetDomain($vad5f82e879a9c5d6b5b442eb37e50551);unset($vad5f82e879a9c5d6b5b442eb37e50551);return true;}public function getDomain($vb80bb7740288fda1f201890375a60c8f) {return $this->isExists($vb80bb7740288fda1f201890375a60c8f) ? $this->getList()[$vb80bb7740288fda1f201890375a60c8f] : false;}public function getDefaultDomain() {foreach ($this->getList() as $vad5f82e879a9c5d6b5b442eb37e50551) {if ($vad5f82e879a9c5d6b5b442eb37e50551->getIsDefault()) {return $vad5f82e879a9c5d6b5b442eb37e50551;}}return false;}public function setDefaultDomain($vb80bb7740288fda1f201890375a60c8f) {if (!$this->isExists($vb80bb7740288fda1f201890375a60c8f)) {throw new coreException("Domain #{$vb80bb7740288fda1f201890375a60c8f} doesn't exist.");}$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Set default domain #{$vb80bb7740288fda1f201890375a60c8f}");try {$v38f000757de9753e99a73845d122fba5 = $this->getDefaultDomain();if ($v38f000757de9753e99a73845d122fba5 instanceof iDomain) {$v38f000757de9753e99a73845d122fba5->setIsDefault(false);$v38f000757de9753e99a73845d122fba5->commit();}$vfdef55ccbcecfd3267ee3732552880d0 = $this->getDomain($vb80bb7740288fda1f201890375a60c8f);$vfdef55ccbcecfd3267ee3732552880d0->setIsDefault(true);$vfdef55ccbcecfd3267ee3732552880d0->commit();}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();return true;}public function getDomainId($v67b3dba8bc6778101892eb77249db32e, $vec5b73a04eaacdb9d355adab61b6da19 = true, $v67e64ff6d302b3c7ffd5e192df30fe7a = true) {if (!is_string($v67b3dba8bc6778101892eb77249db32e) || empty($v67b3dba8bc6778101892eb77249db32e)) {return false;}if (empty($this->hostMap)) {$this->loadDomainList();}if (isset($this->hostMap[$v67b3dba8bc6778101892eb77249db32e])) {$vad5f82e879a9c5d6b5b442eb37e50551 = $this->hostMap[$v67b3dba8bc6778101892eb77249db32e];if ($vec5b73a04eaacdb9d355adab61b6da19) {return $vad5f82e879a9c5d6b5b442eb37e50551->getId();}return ($vad5f82e879a9c5d6b5b442eb37e50551->getHost() === $v67b3dba8bc6778101892eb77249db32e) ? $vad5f82e879a9c5d6b5b442eb37e50551->getId() : false;}if ($v67e64ff6d302b3c7ffd5e192df30fe7a) {$v67b3dba8bc6778101892eb77249db32e = $this->getIdnConverter()->convert($v67b3dba8bc6778101892eb77249db32e);return $this->getDomainId($v67b3dba8bc6778101892eb77249db32e, $vec5b73a04eaacdb9d355adab61b6da19, false);}return false;}public function getDomainByHost($v67b3dba8bc6778101892eb77249db32e) {$vb80bb7740288fda1f201890375a60c8f = $this->getDomainId($v67b3dba8bc6778101892eb77249db32e);return $this->getDomain($vb80bb7740288fda1f201890375a60c8f);}public function getList() {if (empty($this->domainList)) {$this->loadDomainList();}return $this->domainList;}public function isExists($vb80bb7740288fda1f201890375a60c8f) {if (!is_string($vb80bb7740288fda1f201890375a60c8f) && !is_int($vb80bb7740288fda1f201890375a60c8f)) {return false;}return array_key_exists($vb80bb7740288fda1f201890375a60c8f, $this->getList());}public function getDomainIdByUrl($v572d4e421e5e6b9bc11d815e8a027112) {if (!is_string($v572d4e421e5e6b9bc11d815e8a027112) || empty($v572d4e421e5e6b9bc11d815e8a027112)) {return false;}if (!preg_match('/^https?:\/\/([^\/]*)/', $v572d4e421e5e6b9bc11d815e8a027112, $v9c28d32df234037773be184dbdafc274)) {return false;}$v67b3dba8bc6778101892eb77249db32e = $v9c28d32df234037773be184dbdafc274[1];return $this->getDomainId($v67b3dba8bc6778101892eb77249db32e);}public function clearCache() {$ve4e46deb7f9cc58c7abfb32e5570b6f3 = $this->getList();foreach ($ve4e46deb7f9cc58c7abfb32e5570b6f3 as $vad5f82e879a9c5d6b5b442eb37e50551) {$this->unsetDomain($vad5f82e879a9c5d6b5b442eb37e50551);unset($vad5f82e879a9c5d6b5b442eb37e50551);}unset($ve4e46deb7f9cc58c7abfb32e5570b6f3);}public function isDefaultDomain($v67b3dba8bc6778101892eb77249db32e) {$vc04e88ea80c3ceb91a10af3ec937f249 = $this->getDefaultDomain()->getHost();$v0ea7dd4da372f1a68a5dda3b9fc7e2e8 = $this->getIdnConverter();$vc04e88ea80c3ceb91a10af3ec937f249 = $v0ea7dd4da372f1a68a5dda3b9fc7e2e8->encode($vc04e88ea80c3ceb91a10af3ec937f249);$v67b3dba8bc6778101892eb77249db32e = $v0ea7dd4da372f1a68a5dda3b9fc7e2e8->encode($v67b3dba8bc6778101892eb77249db32e);$v9348c895145fa0e884a5de5201664d74 = [$vc04e88ea80c3ceb91a10af3ec937f249, 'www.' . $vc04e88ea80c3ceb91a10af3ec937f249];if (in_array($v67b3dba8bc6778101892eb77249db32e, $v9348c895145fa0e884a5de5201664d74)) {return true;}return false;}private function unsetDomain(iDomain $vad5f82e879a9c5d6b5b442eb37e50551) {unset($this->domainList[$vad5f82e879a9c5d6b5b442eb37e50551->getId()]);unset($this->hostMap[$vad5f82e879a9c5d6b5b442eb37e50551->getHost()]);foreach ($vad5f82e879a9c5d6b5b442eb37e50551->getMirrorsList() as $vfbe322a89bc0ba531c3f0050e3935f28) {unset($this->hostMap[$vfbe322a89bc0ba531c3f0050e3935f28->getHost()]);}return $this;}private function setDomain(iDomain $vad5f82e879a9c5d6b5b442eb37e50551) {$this->domainList[$vad5f82e879a9c5d6b5b442eb37e50551->getId()] = $vad5f82e879a9c5d6b5b442eb37e50551;$this->hostMap[$vad5f82e879a9c5d6b5b442eb37e50551->getHost()] = $vad5f82e879a9c5d6b5b442eb37e50551;foreach ($vad5f82e879a9c5d6b5b442eb37e50551->getMirrorsList() as $vfbe322a89bc0ba531c3f0050e3935f28) {$this->hostMap[$vfbe322a89bc0ba531c3f0050e3935f28->getHost()] = $vad5f82e879a9c5d6b5b442eb37e50551;}return $this;}private function loadDomainList() {$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT `id`, `host`, `is_default`, `default_lang_id`, `use_ssl`, `favicon` FROM `cms3_domains`';$result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {try {$vad5f82e879a9c5d6b5b442eb37e50551 = new domain($vf1965a857bc285d26fe22023aa5ab50d[0], $vf1965a857bc285d26fe22023aa5ab50d);}catch (privateException $ve1671797c52e15f763380b45e841ec32) {$ve1671797c52e15f763380b45e841ec32->unregister();continue;}if ($vad5f82e879a9c5d6b5b442eb37e50551 instanceof iDomain) {$this->setDomain($vad5f82e879a9c5d6b5b442eb37e50551);}}return true;}private function getConnection() {return $this->connection;}private function getIdnConverter() {return $this->idnConverter;}public function getRequestDomain() {return false;}public static function getInstance($v4a8a08f09d37b73795649038408b5f33 = null) {return Service::DomainCollection();}}