<?php
 use UmiCms\Service;class template extends umiEntinty implements iTemplate {protected $store_type = 'template';private $name;private $filename;private $type;private $title;private $domain_id;private $lang_id;private $is_default;private $resourcesDirectory;private $templatesDirectory;private $filePath;public function getName() {return $this->name;}public function getFilename() {return $this->filename;}public function getResourcesDirectory($v64feae0988f5b61c96c305e3c3f04551 = false) {if ($v64feae0988f5b61c96c305e3c3f04551) {return $this->resourcesDirectory ? '/templates/' . $this->name . '/' : '/';}return $this->resourcesDirectory;}public function getTemplatesDirectory() {return $this->templatesDirectory;}public function getFilePath() {return $this->filePath;}public function getType() {return $this->type;}public function getTitle() {return $this->title;}public function getDomainId() {return $this->domain_id;}public function getLangId() {return $this->lang_id;}public function getIsDefault() {return $this->is_default;}public function setName($vb068931cc450442b63f5b3d276ea4297) {if ($this->getName() != $vb068931cc450442b63f5b3d276ea4297) {$this->name = $vb068931cc450442b63f5b3d276ea4297;$this->setIsUpdated();}}public function setFilename($v435ed7e9f07f740abf511a62c00eef6e) {if ($this->getFilename() != $v435ed7e9f07f740abf511a62c00eef6e) {$this->filename = $v435ed7e9f07f740abf511a62c00eef6e;$this->setIsUpdated();}}public function setTitle($vd5d3db1765287eef77d7927cc956f50a) {if ($this->getTitle() != $vd5d3db1765287eef77d7927cc956f50a) {$this->title = $vd5d3db1765287eef77d7927cc956f50a;$this->setIsUpdated();}}public function setType($v599dcce2998a6b40b1e38e8c6006cb0a) {if ($this->getType() != $v599dcce2998a6b40b1e38e8c6006cb0a) {$this->type = $v599dcce2998a6b40b1e38e8c6006cb0a;$this->setIsUpdated();}}public function setDomainId($v72ee76c5c29383b7c9f9225c1fa4d10b) {if (!Service::DomainCollection()->isExists($v72ee76c5c29383b7c9f9225c1fa4d10b)) {return false;}if ($this->getDomainId() != $v72ee76c5c29383b7c9f9225c1fa4d10b) {$this->domain_id = (int) $v72ee76c5c29383b7c9f9225c1fa4d10b;$this->setIsUpdated();}return true;}public function setLangId($vf585b7f018bb4ced15a03683a733e50b) {if (!Service::LanguageCollection()->isExists($vf585b7f018bb4ced15a03683a733e50b)) {return false;}if ($this->getLangId() != $vf585b7f018bb4ced15a03683a733e50b) {$this->lang_id = (int) $vf585b7f018bb4ced15a03683a733e50b;$this->setIsUpdated();}return true;}public function setIsDefault($ve558e63f3083922542d8745224a66eea) {$ve558e63f3083922542d8745224a66eea = (bool) $ve558e63f3083922542d8745224a66eea;if ($this->getIsDefault() != $ve558e63f3083922542d8745224a66eea) {$this->is_default = $ve558e63f3083922542d8745224a66eea;$this->setIsUpdated();}}public function getFileExtension() {switch ($this->getType()) {case 'xslt' : {return 'xsl';}case 'php' : {return 'phtml';}case 'tpls' : {return 'tpl';}default : {throw new coreException('Unsupported type given: ' . $this->getType());}}}public function getConfigPath() {$vb068931cc450442b63f5b3d276ea4297 = $this->getName();if (is_string($vb068931cc450442b63f5b3d276ea4297) && !empty($vb068931cc450442b63f5b3d276ea4297)) {return $this->resourcesDirectory . 'config.ini';}return null;}public function getUsedPages($vaa9f73eea60a006820d0f8768bc8a3fc = 0, $v7a86c157ee9713c34fbd7a1ee40f0c5a = 0) {$vf287ed381c001989407dc155355eb3b2 = '';$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v5a0f217f54927dfb5cb016b73d657e97 = $v4717d53ebfdfea8477f780ec66151dcb->escape($vaa9f73eea60a006820d0f8768bc8a3fc);$v8c9b5763e67cd287e1e815fffa4de408 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v7a86c157ee9713c34fbd7a1ee40f0c5a);if (is_numeric($vaa9f73eea60a006820d0f8768bc8a3fc) && $vaa9f73eea60a006820d0f8768bc8a3fc > 0) {$vf287ed381c001989407dc155355eb3b2 = "LIMIT ${v8c9b5763e67cd287e1e815fffa4de408}, ${v5a0f217f54927dfb5cb016b73d657e97}";}$vac5c74b64b4b8352ef2f181affb5ac2a = <<<QUERY
SELECT SQL_CALC_FOUND_ROWS
	     h.id,
       o.NAME
FROM   cms3_hierarchy h,
       cms3_objects o
WHERE  h.tpl_id = '{$this->id}'
       AND o.id = h.obj_id
       AND h.is_deleted = '0'
       AND h.domain_id = '{$this->domain_id}'
       ${vf287ed381c001989407dc155355eb3b2}
QUERY;   $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$v9b207167e5381c47682c6b4f58a623fb = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {list($vb80bb7740288fda1f201890375a60c8f, $vb068931cc450442b63f5b3d276ea4297) = $vf1965a857bc285d26fe22023aa5ab50d;$v9b207167e5381c47682c6b4f58a623fb[] = [$vb80bb7740288fda1f201890375a60c8f, $vb068931cc450442b63f5b3d276ea4297];}return $v9b207167e5381c47682c6b4f58a623fb;}public function getTotalUsedPages() {$v1b1cc7f086b3f074da452bc3129981eb = <<<QUERY
SELECT count(`id`)
FROM   cms3_hierarchy h USE INDEX (PRIMARY)
WHERE  h.tpl_id = '{$this->id}'
       AND h.is_deleted = '0'
       AND h.domain_id = '{$this->domain_id}'
QUERY;   $v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($v1b1cc7f086b3f074da452bc3129981eb);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return $ve2942a04780e223b215eb8b663cf5353;}public function getRelatedPages($vaa9f73eea60a006820d0f8768bc8a3fc = 0, $v7a86c157ee9713c34fbd7a1ee40f0c5a = 0) {$ve87645ca6a33b39fec3feffd67bd9d35 = $this->getUsedPages($vaa9f73eea60a006820d0f8768bc8a3fc, $v7a86c157ee9713c34fbd7a1ee40f0c5a);$vb02f4573339bb52a0393bc441bf398d2 = [];foreach ($ve87645ca6a33b39fec3feffd67bd9d35 as $v5390e7f5923d832bb240f9bdbce27c40) {if (isset($v5390e7f5923d832bb240f9bdbce27c40[0]) && is_numeric($v5390e7f5923d832bb240f9bdbce27c40[0])) {$vb02f4573339bb52a0393bc441bf398d2[] = $v5390e7f5923d832bb240f9bdbce27c40[0];}}$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();return $vb81ca7c0ccaa77e7aa91936ab0070695->loadElements($vb02f4573339bb52a0393bc441bf398d2);}public function setUsedPages($vb3b32a2d422265cd25c3323ed0157f81) {if ($vb3b32a2d422265cd25c3323ed0157f81 === null) {return false;}$vde0c2006a577d53dfd22f172baf697ed = templatesCollection::getInstance()    ->getDefaultTemplate($this->domain_id, $this->lang_id)    ->getId();$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
UPDATE cms3_hierarchy
SET tpl_id = '{$vde0c2006a577d53dfd22f172baf697ed}'
WHERE tpl_id = '{$this->id}' AND is_deleted = '0' AND domain_id = '{$this->domain_id}'
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();if (!is_array($vb3b32a2d422265cd25c3323ed0157f81)) {return false;}if (is_array($vb3b32a2d422265cd25c3323ed0157f81) && !empty($vb3b32a2d422265cd25c3323ed0157f81)) {foreach ($vb3b32a2d422265cd25c3323ed0157f81 as $v7552cd149af7495ee7d8225974e50f80) {$v71860c77c6745379b0d44304d66b6a13 = $vb81ca7c0ccaa77e7aa91936ab0070695->getElement($v7552cd149af7495ee7d8225974e50f80);if ($v71860c77c6745379b0d44304d66b6a13 instanceof iUmiHierarchyElement) {$v71860c77c6745379b0d44304d66b6a13->setTplId($this->id);$v71860c77c6745379b0d44304d66b6a13->commit();unset($v71860c77c6745379b0d44304d66b6a13);$vb81ca7c0ccaa77e7aa91936ab0070695->unloadElement($v7552cd149af7495ee7d8225974e50f80);}}}return true;}protected function loadInfo($vf1965a857bc285d26fe22023aa5ab50d = false) {if (!is_array($vf1965a857bc285d26fe22023aa5ab50d) || count($vf1965a857bc285d26fe22023aa5ab50d) < 8) {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v817f7de13f58df29b13a9570082097da = (int) $this->getId();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT id, name, filename, type, title, domain_id, lang_id, is_default 
FROM cms3_templates WHERE id = $v817f7de13f58df29b13a9570082097da LIMIT 0,1
SQL;    $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$vf1965a857bc285d26fe22023aa5ab50d = $result->fetch();}if (!is_array($vf1965a857bc285d26fe22023aa5ab50d) || count($vf1965a857bc285d26fe22023aa5ab50d) < 8) {return false;}list($vb80bb7740288fda1f201890375a60c8f, $vb068931cc450442b63f5b3d276ea4297, $v435ed7e9f07f740abf511a62c00eef6e, $v599dcce2998a6b40b1e38e8c6006cb0a, $vd5d3db1765287eef77d7927cc956f50a, $v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b, $ve558e63f3083922542d8745224a66eea) = $vf1965a857bc285d26fe22023aa5ab50d;$this->name = (string) $vb068931cc450442b63f5b3d276ea4297;$this->filename = $v435ed7e9f07f740abf511a62c00eef6e;$this->type = (string) $v599dcce2998a6b40b1e38e8c6006cb0a;$this->title = $vd5d3db1765287eef77d7927cc956f50a;$this->domain_id = (int) $v72ee76c5c29383b7c9f9225c1fa4d10b;$this->lang_id = (int) $vf585b7f018bb4ced15a03683a733e50b;$this->is_default = (bool) $ve558e63f3083922542d8745224a66eea;if (!empty($this->filename)) {$v076ccfd7e9875932f89de6676f4c73d8 = pathinfo($this->filename, PATHINFO_EXTENSION);if ($this->type === '') {switch(mb_strtolower($v076ccfd7e9875932f89de6676f4c73d8)) {case 'xsl':       $this->type = 'xslt';break;case 'tpl':       $this->type = 'tpls';break;case 'phtml':       $this->type = 'php';break;default:       $this->type = $v076ccfd7e9875932f89de6676f4c73d8 !== '' ? $v076ccfd7e9875932f89de6676f4c73d8 : 'xslt';}}$v2245023265ae4cf87d02c8b6ba991139 = mainConfiguration::getInstance();if ($this->type == 'xslt') {$this->templatesDirectory = $va44b3818d66f01cde4647f3ad2e3cb06 = $v2245023265ae4cf87d02c8b6ba991139->includeParam('templates.xsl');}elseif ($this->type == 'tpls') {$this->templatesDirectory = $v2245023265ae4cf87d02c8b6ba991139->includeParam('templates.tpl');$va44b3818d66f01cde4647f3ad2e3cb06 = $this->templatesDirectory . 'content/';}elseif ($this->type == 'php') {$this->templatesDirectory = $v2245023265ae4cf87d02c8b6ba991139->includeParam('templates.php');$va44b3818d66f01cde4647f3ad2e3cb06 = $this->templatesDirectory . 'content/';}else {$this->templatesDirectory = $va44b3818d66f01cde4647f3ad2e3cb06 = $v2245023265ae4cf87d02c8b6ba991139->includeParam('templates.' . $this->type) . '/';}if ($this->name !== '') {$this->resourcesDirectory = CURRENT_WORKING_DIR . '/templates/' . $this->name . '/';$va44b3818d66f01cde4647f3ad2e3cb06 = $this->templatesDirectory = $this->resourcesDirectory . $this->type . '/';if ($this->type == 'tpls') {$va44b3818d66f01cde4647f3ad2e3cb06 = $this->templatesDirectory . 'content/';}}if (Service::Request()->isMobile() && is_file($va44b3818d66f01cde4647f3ad2e3cb06 . 'mobile/' . $this->filename)) {$this->filePath = $va44b3818d66f01cde4647f3ad2e3cb06 . 'mobile/' . $this->filename;}else {$this->filePath = $va44b3818d66f01cde4647f3ad2e3cb06 . $this->filename;}}return true;}protected function save() {$vb068931cc450442b63f5b3d276ea4297 = self::filterInputString($this->name);$v435ed7e9f07f740abf511a62c00eef6e = self::filterInputString($this->filename);$v599dcce2998a6b40b1e38e8c6006cb0a = self::filterInputString($this->type);$vd5d3db1765287eef77d7927cc956f50a = self::filterInputString($this->title);$v72ee76c5c29383b7c9f9225c1fa4d10b = (int) $this->domain_id;$vf585b7f018bb4ced15a03683a733e50b = (int) $this->lang_id;$ve558e63f3083922542d8745224a66eea = (int) $this->is_default;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
UPDATE cms3_templates
SET name = '{$vb068931cc450442b63f5b3d276ea4297}', filename = '{$v435ed7e9f07f740abf511a62c00eef6e}', type = '{$v599dcce2998a6b40b1e38e8c6006cb0a}', title = '{$vd5d3db1765287eef77d7927cc956f50a}',
    domain_id = '{$v72ee76c5c29383b7c9f9225c1fa4d10b}', lang_id = '{$vf585b7f018bb4ced15a03683a733e50b}', is_default = '{$ve558e63f3083922542d8745224a66eea}'
WHERE id = '{$this->id}'
SQL;   $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return true;}}