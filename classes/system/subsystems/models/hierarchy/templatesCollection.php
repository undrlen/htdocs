<?php
 use UmiCms\Service;class templatesCollection extends singleton implements iSingleton, iTemplatesCollection {private $templates = [];protected function __construct() {$this->loadTemplates();}public static function getInstance($v4a8a08f09d37b73795649038408b5f33 = null) {return parent::getInstance(__CLASS__);}public function addTemplate(   $v435ed7e9f07f740abf511a62c00eef6e,   $vd5d3db1765287eef77d7927cc956f50a,   $v72ee76c5c29383b7c9f9225c1fa4d10b = false,   $vf585b7f018bb4ced15a03683a733e50b = false,   $ve558e63f3083922542d8745224a66eea = false  ) {$ve4e46deb7f9cc58c7abfb32e5570b6f3 = Service::DomainCollection();$v5a05866850c28651fe234659f6c92ada = Service::LanguageCollection();if (!$ve4e46deb7f9cc58c7abfb32e5570b6f3->isExists($v72ee76c5c29383b7c9f9225c1fa4d10b)) {if ($ve4e46deb7f9cc58c7abfb32e5570b6f3->getDefaultDomain()) {$v72ee76c5c29383b7c9f9225c1fa4d10b = $ve4e46deb7f9cc58c7abfb32e5570b6f3->getDefaultDomain()->getId();}else {return false;}}if (!$v5a05866850c28651fe234659f6c92ada->isExists($vf585b7f018bb4ced15a03683a733e50b)) {if ($v5a05866850c28651fe234659f6c92ada->getDefaultLang()) {$vf585b7f018bb4ced15a03683a733e50b = $v5a05866850c28651fe234659f6c92ada->getDefaultLang()->getId();}else {return false;}}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Create template $vd5d3db1765287eef77d7927cc956f50a");try {$vac5c74b64b4b8352ef2f181affb5ac2a = 'INSERT INTO cms3_templates VALUES()';$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vb80bb7740288fda1f201890375a60c8f = $v4717d53ebfdfea8477f780ec66151dcb->insertId();$v66f6181bcb4cff4cd38fbc804a036db6 = new template($vb80bb7740288fda1f201890375a60c8f);$v66f6181bcb4cff4cd38fbc804a036db6->setFilename($v435ed7e9f07f740abf511a62c00eef6e);$v66f6181bcb4cff4cd38fbc804a036db6->setTitle($vd5d3db1765287eef77d7927cc956f50a);$v66f6181bcb4cff4cd38fbc804a036db6->setDomainId($v72ee76c5c29383b7c9f9225c1fa4d10b);$v66f6181bcb4cff4cd38fbc804a036db6->setLangId($vf585b7f018bb4ced15a03683a733e50b);$v66f6181bcb4cff4cd38fbc804a036db6->setIsDefault($ve558e63f3083922542d8745224a66eea);$v66f6181bcb4cff4cd38fbc804a036db6->commit();$v66f6181bcb4cff4cd38fbc804a036db6->update();}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();if ($ve558e63f3083922542d8745224a66eea) {$this->setDefaultTemplate($vb80bb7740288fda1f201890375a60c8f);}$this->templates[$vb80bb7740288fda1f201890375a60c8f] = $v66f6181bcb4cff4cd38fbc804a036db6;return $vb80bb7740288fda1f201890375a60c8f;}public function setDefaultTemplate($v3200a31fc05da4e9d5a0465c36822e2f, $v72ee76c5c29383b7c9f9225c1fa4d10b = false, $vf585b7f018bb4ced15a03683a733e50b = false) {if (!$this->isExists($v3200a31fc05da4e9d5a0465c36822e2f)) {return false;}$v72ee76c5c29383b7c9f9225c1fa4d10b = $v72ee76c5c29383b7c9f9225c1fa4d10b ?: Service::DomainDetector()->detectId();$vf585b7f018bb4ced15a03683a733e50b = $vf585b7f018bb4ced15a03683a733e50b ?: Service::LanguageDetector()->detectId();$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Set default template $v3200a31fc05da4e9d5a0465c36822e2f");try {$v4334e531f3928afebdbe8f44febfc0fa = $this->getTemplatesList($v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b);foreach ($v4334e531f3928afebdbe8f44febfc0fa as $v66f6181bcb4cff4cd38fbc804a036db6) {$ve558e63f3083922542d8745224a66eea = ($v3200a31fc05da4e9d5a0465c36822e2f == $v66f6181bcb4cff4cd38fbc804a036db6->getId());$v66f6181bcb4cff4cd38fbc804a036db6->setIsDefault($ve558e63f3083922542d8745224a66eea);$v66f6181bcb4cff4cd38fbc804a036db6->commit();}}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();return true;}public function delTemplate($vb80bb7740288fda1f201890375a60c8f) {$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;if (!$this->isExists($vb80bb7740288fda1f201890375a60c8f)) {return false;}unset($this->templates[$vb80bb7740288fda1f201890375a60c8f]);$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Delete template $vb80bb7740288fda1f201890375a60c8f");try {$v17a02f222e08ec71e130ceda99afaddb = $this->getDefaultTemplate();if ($v17a02f222e08ec71e130ceda99afaddb instanceof iTemplate && $v17a02f222e08ec71e130ceda99afaddb->getId() != $vb80bb7740288fda1f201890375a60c8f) {$vcc12e483aa34f3e08439b63ce2daee2c = "UPDATE cms3_hierarchy SET tpl_id = '{$v17a02f222e08ec71e130ceda99afaddb->getId()}' WHERE tpl_id='{$vb80bb7740288fda1f201890375a60c8f}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vcc12e483aa34f3e08439b63ce2daee2c);}$vb0d5e4eccb561fd846e3140d40f64aa2 = "DELETE FROM cms3_templates WHERE id = '{$vb80bb7740288fda1f201890375a60c8f}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vb0d5e4eccb561fd846e3140d40f64aa2);}catch (databaseException $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();return true;}public function getTemplatesList($v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b) {$v4334e531f3928afebdbe8f44febfc0fa = [];foreach ($this->templates as $v66f6181bcb4cff4cd38fbc804a036db6) {if ($v66f6181bcb4cff4cd38fbc804a036db6->getDomainId() == $v72ee76c5c29383b7c9f9225c1fa4d10b && $v66f6181bcb4cff4cd38fbc804a036db6->getLangId() == $vf585b7f018bb4ced15a03683a733e50b) {$v4334e531f3928afebdbe8f44febfc0fa[] = $v66f6181bcb4cff4cd38fbc804a036db6;}}return $v4334e531f3928afebdbe8f44febfc0fa;}public function getFullTemplatesList() {return $this->templates;}public function getDefaultTemplate($v72ee76c5c29383b7c9f9225c1fa4d10b = false, $vf585b7f018bb4ced15a03683a733e50b = false) {$v72ee76c5c29383b7c9f9225c1fa4d10b = $v72ee76c5c29383b7c9f9225c1fa4d10b ?: Service::DomainDetector()->detectId();$vf585b7f018bb4ced15a03683a733e50b = $vf585b7f018bb4ced15a03683a733e50b ?: Service::LanguageDetector()->detectId();$v4334e531f3928afebdbe8f44febfc0fa = $this->getTemplatesList($v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b);foreach ($v4334e531f3928afebdbe8f44febfc0fa as $v66f6181bcb4cff4cd38fbc804a036db6) {if ($v66f6181bcb4cff4cd38fbc804a036db6->getIsDefault()) {return $v66f6181bcb4cff4cd38fbc804a036db6;}}if (count($v4334e531f3928afebdbe8f44febfc0fa) > 0) {$vfb59a97b8c19b3d211b93e7d664b73ad = $v4334e531f3928afebdbe8f44febfc0fa[0];$this->setDefaultTemplate($vfb59a97b8c19b3d211b93e7d664b73ad->getId(), $v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b);return $vfb59a97b8c19b3d211b93e7d664b73ad;}return false;}public function getCurrentTemplate() {$v594c103f2c6e04c3d8ab059f031e0c1a = cmsController::getInstance();$vd58c61d4baf203c327ec51adbd377a4e = umiHierarchy::getInstance()    ->getElement($v594c103f2c6e04c3d8ab059f031e0c1a->getCurrentElementId(), true);if ($vd58c61d4baf203c327ec51adbd377a4e instanceof iUmiHierarchyElement) {return $this->getTemplate($vd58c61d4baf203c327ec51adbd377a4e->getTplId());}$vcfb14cbbb0da97c5d6fc00de2231984b = $this->getHierarchyTypeTemplate($v594c103f2c6e04c3d8ab059f031e0c1a->getCurrentModule(), $v594c103f2c6e04c3d8ab059f031e0c1a->getCurrentMethod());if ($vcfb14cbbb0da97c5d6fc00de2231984b) {return $this->getTemplate($vcfb14cbbb0da97c5d6fc00de2231984b);}return $this->getDefaultTemplate();}public function getHierarchyTypeTemplate($v22884db148f0ffb0d830ba431102b0b5, $vea9f6aca279138c58f705c8d4cb4b8ce) {$vb80bb7740288fda1f201890375a60c8f = null;if (class_exists($v22884db148f0ffb0d830ba431102b0b5) && method_exists($v22884db148f0ffb0d830ba431102b0b5, 'setupTemplate')) {$vb80bb7740288fda1f201890375a60c8f = call_user_func([$v22884db148f0ffb0d830ba431102b0b5, 'setupTemplate'], $vea9f6aca279138c58f705c8d4cb4b8ce);}if (!$this->isExists($vb80bb7740288fda1f201890375a60c8f)) {$vb80bb7740288fda1f201890375a60c8f = mainConfiguration::getInstance()     ->get('templates', "{$v22884db148f0ffb0d830ba431102b0b5}.{$vea9f6aca279138c58f705c8d4cb4b8ce}");}return $this->isExists($vb80bb7740288fda1f201890375a60c8f) ? $vb80bb7740288fda1f201890375a60c8f : false;}public function getTemplate($vb80bb7740288fda1f201890375a60c8f) {return $this->isExists($vb80bb7740288fda1f201890375a60c8f) ? $this->templates[$vb80bb7740288fda1f201890375a60c8f] : false;}public function isExists($vb80bb7740288fda1f201890375a60c8f) {return array_key_exists((int) $vb80bb7740288fda1f201890375a60c8f, $this->templates);}public function isExistsForSite($v3200a31fc05da4e9d5a0465c36822e2f, $v72ee76c5c29383b7c9f9225c1fa4d10b = false, $vf585b7f018bb4ced15a03683a733e50b = false) {$v72ee76c5c29383b7c9f9225c1fa4d10b = $v72ee76c5c29383b7c9f9225c1fa4d10b ?: Service::DomainDetector()->detectId();$vf585b7f018bb4ced15a03683a733e50b = $vf585b7f018bb4ced15a03683a733e50b ?: Service::LanguageDetector()->detectId();foreach ($this->getTemplatesList($v72ee76c5c29383b7c9f9225c1fa4d10b, $vf585b7f018bb4ced15a03683a733e50b) as $v65afdfb40872c44eb6118b669b0d751e) {if ($v65afdfb40872c44eb6118b669b0d751e->getId() == $v3200a31fc05da4e9d5a0465c36822e2f) {return true;}}return false;}public function getFirstByName($vb068931cc450442b63f5b3d276ea4297) {$v10ae9fc7d453b0dd525d0edf2ede7961 = $this->getListByName($vb068931cc450442b63f5b3d276ea4297);if (empty($v10ae9fc7d453b0dd525d0edf2ede7961)) {return null;}return array_shift($v10ae9fc7d453b0dd525d0edf2ede7961);}public function getListByName($vb068931cc450442b63f5b3d276ea4297) {return array_filter(    $this->getFullTemplatesList(),    function (iTemplate $v66f6181bcb4cff4cd38fbc804a036db6) use ($vb068931cc450442b63f5b3d276ea4297) {return $v66f6181bcb4cff4cd38fbc804a036db6->getName() == $vb068931cc450442b63f5b3d276ea4297;});}private function loadTemplates() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT id, name, filename, type, title, domain_id, lang_id, is_default FROM cms3_templates';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$vb80bb7740288fda1f201890375a60c8f = $vf1965a857bc285d26fe22023aa5ab50d[0];try {$v66f6181bcb4cff4cd38fbc804a036db6 = new template($vb80bb7740288fda1f201890375a60c8f, $vf1965a857bc285d26fe22023aa5ab50d);}catch (privateException $ve1671797c52e15f763380b45e841ec32) {$ve1671797c52e15f763380b45e841ec32->unregister();continue;}$this->templates[$vb80bb7740288fda1f201890375a60c8f] = $v66f6181bcb4cff4cd38fbc804a036db6;}return true;}public function clearCache() {$this->templates = [];$this->loadTemplates();}}