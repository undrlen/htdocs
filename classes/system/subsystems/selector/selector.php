<?php
 use UmiCms\Service;class selector implements IteratorAggregate {protected static $modes = ['objects', 'pages'];protected static $sysPagesWhereFields = [   'id',   'name',   'owner',   'domain',   'lang',   'is_deleted',   'is_active',   'is_visible',   'updatetime',   'is_default',   'template_id',   'alt_name',   'ord',   '*',  ];protected static $sysPagesGroupFields = [   'name',   'owner',   'domain',   'lang',   'is_deleted',   'is_active',   'is_visible',   'updatetime',   'is_default',   'template_id',   'obj_id',   'obj_type_id',   'ord',  ];protected static $sysObjectsWhereFields = ['id', 'name', 'owner', 'guid', 'updatetime', 'ord', '*'];protected static $sysObjectsGroupFields = ['id', 'name', 'owner', 'guid', 'updatetime', 'ord'];protected static $sysOrderFields = ['name', 'ord', 'rand', 'updatetime', 'id'];protected $mode;protected $executor;protected $options = [];protected $permissions;protected $limit;protected $offset;protected $types = [];protected $hierarchy = [];protected $whereSysProps = [];protected $groupSysProps = [];protected $orderSysProps = [];protected $whereFieldProps = [];protected $groupFieldProps = [];protected $orderFieldProps = [];protected $result;protected $length;private $allowedPropertyList = [   'mode',   'offset',   'limit',   'whereFieldProps',   'orderFieldProps',   'groupFieldProps',   'whereSysProps',   'orderSysProps',   'groupSysProps',   'types',   'permissions',   'hierarchy',   'options',  ];public static function get($v9c32b08fe4f1100357be3cefc37fb591) {return new selectorGetter($v9c32b08fe4f1100357be3cefc37fb591);}public function __construct($v15d61712450a686a7f365adf4fef581f) {$this->setMode($v15d61712450a686a7f365adf4fef581f);}public function types($v2dda916891cbd0bf046213df34800783 = false) {$this->throwIfAlreadyExecuted();if ($v2dda916891cbd0bf046213df34800783 === false) {return $this->types;}return $this->types[] = new selectorType($v2dda916891cbd0bf046213df34800783);}public function where($v972bf3f05d14ffbdb817bef60638ff00) {$this->throwIfAlreadyExecuted();if ($v972bf3f05d14ffbdb817bef60638ff00 == 'hierarchy') {if ($this->mode == 'objects') {throw new selectorException('Hierarchy filter is not suitable for "objects" selector mode');}return $this->hierarchy[] = new selectorWhereHierarchy();}if ($v972bf3f05d14ffbdb817bef60638ff00 == 'permissions') {if ($this->mode == 'objects') {throw new selectorException('Permissions filter is not suitable for "objects" selector mode');}if ($this->permissions === null) {$this->permissions = new selectorWherePermissions();}return $this->permissions;}if (in_array($v972bf3f05d14ffbdb817bef60638ff00, ($this->mode == 'pages')    ? self::$sysPagesWhereFields    : self::$sysObjectsWhereFields)) {return $this->whereSysProps[] = new selectorWhereSysProp($v972bf3f05d14ffbdb817bef60638ff00);}$ve491e7c03c219d563fe5073ad035bb25 = $this->searchField($v972bf3f05d14ffbdb817bef60638ff00);$ve491e7c03c219d563fe5073ad035bb25 = is_array($ve491e7c03c219d563fe5073ad035bb25) ? $ve491e7c03c219d563fe5073ad035bb25 : [$ve491e7c03c219d563fe5073ad035bb25];if (empty($ve491e7c03c219d563fe5073ad035bb25)) {throw new selectorException(     __METHOD__ . ": Field \"{$v972bf3f05d14ffbdb817bef60638ff00}\" is not presented in selected object types"    );}if (umiCount($ve491e7c03c219d563fe5073ad035bb25) > 1) {$vef3e30e070f70244fd6578d88a6b77ac = $this->option('or-mode');$v7f4435dcfb648bbff2e18576a078f9e7 = (array) $vef3e30e070f70244fd6578d88a6b77ac->value;$v26acbc73be3d4e95dfed25df97552502 = isset($v7f4435dcfb648bbff2e18576a078f9e7['fields']) ? $v7f4435dcfb648bbff2e18576a078f9e7['fields'] : [];$v26acbc73be3d4e95dfed25df97552502[] = $v972bf3f05d14ffbdb817bef60638ff00;call_user_func_array([$vef3e30e070f70244fd6578d88a6b77ac, 'fields'], $v26acbc73be3d4e95dfed25df97552502);}return $this->whereFieldProps[] =    new selectorWhereFieldProp($ve491e7c03c219d563fe5073ad035bb25, $this->option('search-in-related-object')->value);}public function order($v972bf3f05d14ffbdb817bef60638ff00) {$this->throwIfAlreadyExecuted();if (in_array($v972bf3f05d14ffbdb817bef60638ff00, self::$sysOrderFields)) {return $this->orderSysProps[] = new selectorOrderSysProp($v972bf3f05d14ffbdb817bef60638ff00);}$ve491e7c03c219d563fe5073ad035bb25 = $this->searchField($v972bf3f05d14ffbdb817bef60638ff00);$ve491e7c03c219d563fe5073ad035bb25 = is_array($ve491e7c03c219d563fe5073ad035bb25) ? $ve491e7c03c219d563fe5073ad035bb25 : [$ve491e7c03c219d563fe5073ad035bb25];if (empty($ve491e7c03c219d563fe5073ad035bb25)) {throw new selectorException(     __METHOD__ . ": Field \"{$v972bf3f05d14ffbdb817bef60638ff00}\" is not presented in selected objects types"    );}return $this->orderFieldProps[] = new selectorOrderFieldProp($ve491e7c03c219d563fe5073ad035bb25);}public function group($v972bf3f05d14ffbdb817bef60638ff00) {$this->throwIfAlreadyExecuted();if (in_array($v972bf3f05d14ffbdb817bef60638ff00, ($this->mode == 'pages')    ? self::$sysPagesGroupFields    : self::$sysObjectsGroupFields)) {return $this->groupSysProps[] = new selectorGroupSysProp($v972bf3f05d14ffbdb817bef60638ff00);}$ve491e7c03c219d563fe5073ad035bb25 = $this->searchField($v972bf3f05d14ffbdb817bef60638ff00);$ve491e7c03c219d563fe5073ad035bb25 = is_array($ve491e7c03c219d563fe5073ad035bb25) ? $ve491e7c03c219d563fe5073ad035bb25 : [$ve491e7c03c219d563fe5073ad035bb25];if (empty($ve491e7c03c219d563fe5073ad035bb25)) {throw new selectorException(     __METHOD__ . ": Field \"{$v972bf3f05d14ffbdb817bef60638ff00}\" is not presented in selected objects types"    );}return $this->groupFieldProps[] = new selectorGroupFieldProp($ve491e7c03c219d563fe5073ad035bb25);}public function limit($v7a86c157ee9713c34fbd7a1ee40f0c5a, $vaa9f73eea60a006820d0f8768bc8a3fc) {$this->throwIfAlreadyExecuted();if ($vaa9f73eea60a006820d0f8768bc8a3fc === KEYWORD_GRAB_ALL) {return $this;}$this->limit = (int) $vaa9f73eea60a006820d0f8768bc8a3fc;$this->offset = (int) $v7a86c157ee9713c34fbd7a1ee40f0c5a;return $this;}public function unsetLimit() {$this->limit(0, 0);return $this;}public function result() {if ($this->result === null) {if (umiCount($this->orderSysProps) == 0) {$this->order('ord')->asc();}if ($this->mode == 'pages' && $this->permissions === null && !$this->option('no-permissions')->value) {$this->where('permissions');}$ve70c4df10ef0983b9c8c31bd06b2a2c3 = $this->option('return')->value;if (is_array($ve70c4df10ef0983b9c8c31bd06b2a2c3) && in_array('count', $ve70c4df10ef0983b9c8c31bd06b2a2c3)) {$this->result = $this->executor()->length();}else {$this->result = $this->executor()->result();$this->length = $this->executor()->length;}}$this->unloadExecutor();return $this->result;}public function length() {if ($this->length === null) {if ($this->mode == 'pages' && $this->permissions === null) {$this->where('permissions');}$v2fa47f7c65fec19cc163b195725e3844 = $this->executor()->length();if (in_array('count', $this->option('return')->value)) {$this->result = $v2fa47f7c65fec19cc163b195725e3844;}else {$this->result = $this->executor()->result();}$this->length = $v2fa47f7c65fec19cc163b195725e3844;}$this->unloadExecutor();return $this->length;}public function option($vb068931cc450442b63f5b3d276ea4297, $v2063c1608d6e0baf80249c42e2be5804 = null) {$this->throwIfAlreadyExecuted();if (!isset($this->options[$vb068931cc450442b63f5b3d276ea4297])) {$ved94a6ed342e92fe771ebe903685f5c8 = new selectorOption($vb068931cc450442b63f5b3d276ea4297);$this->options[$vb068931cc450442b63f5b3d276ea4297] = $ved94a6ed342e92fe771ebe903685f5c8;}if ($v2063c1608d6e0baf80249c42e2be5804 !== null) {$this->options[$vb068931cc450442b63f5b3d276ea4297]->value($v2063c1608d6e0baf80249c42e2be5804);}return $this->options[$vb068931cc450442b63f5b3d276ea4297];}public function flush() {$this->result = null;$this->length = null;}public function __get($v1a8db4c996d8ed8289da5f957879ab94) {switch ($v1a8db4c996d8ed8289da5f957879ab94) {case 'length':    case 'total':     return $this->length();case 'result':     return $this->result();case 'first':     return $this->first();case 'last':     return $this->last();}if (in_array($v1a8db4c996d8ed8289da5f957879ab94, $this->allowedPropertyList)) {return $this->$v1a8db4c996d8ed8289da5f957879ab94;}return null;}public function __isset($v1a8db4c996d8ed8289da5f957879ab94) {return in_array($v1a8db4c996d8ed8289da5f957879ab94, [    'length',    'total',    'result',    'first',    'last',    'mode',    'offset',    'limit',    'whereFieldProps',    'orderFieldProps',    'groupFieldProps',    'whereSysProps',    'orderSysProps',    'groupSysProps',    'types',    'permissions',    'hierarchy',    'options'   ]);}public function getIterator() {$this->result();return new ArrayIterator($this->result);}public function query() {if ($this->mode == 'pages') {if (umiCount($this->orderSysProps) == 0) {$this->order('ord')->asc();}if ($this->permissions === null) {$this->where('permissions');}}return $this->executor()->query();}public function searchField($v972bf3f05d14ffbdb817bef60638ff00, $vd270863f2e24cdca2232a9f92e98ed0f = false) {$v5bf771c31a2488978f269aface6f7a45 = [];if ($this->mode == 'pages' && umiCount($this->types) == 0) {$v599dcce2998a6b40b1e38e8c6006cb0a = new selectorType('object-type');$v599dcce2998a6b40b1e38e8c6006cb0a->guid('root-pages-type');$this->types[] = $v599dcce2998a6b40b1e38e8c6006cb0a;}foreach ($this->types as $v599dcce2998a6b40b1e38e8c6006cb0a) {$v945100186b119048837b9859c2c46410 = $v599dcce2998a6b40b1e38e8c6006cb0a->getFieldsId($v972bf3f05d14ffbdb817bef60638ff00);if ($v945100186b119048837b9859c2c46410) {if (is_array($v945100186b119048837b9859c2c46410)) {$v5bf771c31a2488978f269aface6f7a45 = array_unique(array_merge($v5bf771c31a2488978f269aface6f7a45, $v945100186b119048837b9859c2c46410));}else {$v5bf771c31a2488978f269aface6f7a45[] = $v945100186b119048837b9859c2c46410;}}}if (umiCount($v5bf771c31a2488978f269aface6f7a45) === 1) {return (int) array_shift($v5bf771c31a2488978f269aface6f7a45);}return $vd270863f2e24cdca2232a9f92e98ed0f ? array_shift($v5bf771c31a2488978f269aface6f7a45) : $v5bf771c31a2488978f269aface6f7a45;}protected function throwIfAlreadyExecuted() {if ($this->executor && $this->executor->getSkipExecutedCheckState()) {return;}if ($this->result !== null || $this->length !== null) {$v78e731027d8fd50ed642340b7c9a63b3 = getLabel('error-selector-executed');throw new selectorException($v78e731027d8fd50ed642340b7c9a63b3);}}protected function executor() {if (!$this->executor) {$this->executor = new selectorExecutor($this);}return $this->executor;}protected function unloadExecutor() {if ($this->length !== null && $this->result !== null) {unset($this->executor);}}protected function setMode($v15d61712450a686a7f365adf4fef581f) {if (!in_array($v15d61712450a686a7f365adf4fef581f, self::$modes)) {$v0f217972ba4782e962e2a3eaeefffe9c = implode(', ', self::$modes);throw new selectorException("This mode \"{$v15d61712450a686a7f365adf4fef581f}\" is not supported, choose one of these: {$v0f217972ba4782e962e2a3eaeefffe9c}");}$this->mode = $v15d61712450a686a7f365adf4fef581f;if ($v15d61712450a686a7f365adf4fef581f == 'pages') {$this->setDefaultPagesWhere();}}protected function setDefaultPagesWhere() {$this->where('domain')->equals(Service::DomainDetector()->detectId());$this->where('lang')->equals(Service::LanguageDetector()->detectId());$this->where('is_deleted')->equals(0);if (Service::Request()->isNotAdmin()) {$this->where('is_active')->equals(1);}}public function first() {$result = $this->result();if (is_array($result) && count($result) > 0) {return $result[0];}return null;}public function last() {$result = $this->result();if (is_array($result) && count($result) > 0) {return $result[count($result) - 1];}return null;}}