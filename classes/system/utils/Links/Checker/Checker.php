<?php
 namespace UmiCms\Classes\System\Utils\Links\Checker;use UmiCms\Classes\System\Utils\Links\iEntity;use UmiCms\Classes\System\Utils\Links\Injectors;class Checker implements iChecker, \iUmiService, \iUmiRegistryInjector, Injectors\iLinksCollection {use \tUmiService;use \tUmiRegistryInjector;use Injectors\tLinksCollection;private $state;const REGISTRY_KEY = '/settings/umiLinksChecker';const OK_HTTP_STATUS_CODE = 200;const USER_AGENT = 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:48.0) Gecko/20100101 Firefox/48.0';const HOST_WITH_PROTOCOL_PATTERN = '/(https?:\/\/)([a-z0-9-_]+\.){1,}([a-z]+){1}/';const HOST_PATTERN = '/([a-z0-9-_]+\.){1,}([a-z]+){1}';const URL_PROTOCOL_START_SYMBOLS = 'http';const URL_DEFAULT_PROTOCOL = 'http://';const URI_SEPARATOR = '/';const URL_QUERY_START_SYMBOL = '?';const URL_FRAGMENT_START_SYMBOL = '#';const HEAD_HTTP_REQUEST_TYPE = 'HEAD';const CURL_TIMEOUT = 5;const CHECKING_LIMIT_BY_ONE_ITERATION = 10;public function checkBrokenUrls() {$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();if ($v9ed39e2ea931586b6a985a6942ef573e->isComplete()) {return $this;}$v807765384d9d5527da8848df14a4f02f = $this->getLinks();if (umiCount($v807765384d9d5527da8848df14a4f02f) === 0) {$v9ed39e2ea931586b6a985a6942ef573e->setCompleteStatus(true);return $this;}foreach ($v807765384d9d5527da8848df14a4f02f as $v2a304a1348456ccd2234cd71a81bd338) {$v572d4e421e5e6b9bc11d815e8a027112 = $this->getAbsoluteLink($v2a304a1348456ccd2234cd71a81bd338);if ($this->isUrlBroken($v572d4e421e5e6b9bc11d815e8a027112)) {$v2a304a1348456ccd2234cd71a81bd338->setBroken(true);$v2a304a1348456ccd2234cd71a81bd338->commit();}}$v9ed39e2ea931586b6a985a6942ef573e->setOffset(    $v9ed39e2ea931586b6a985a6942ef573e->getOffset() + $v9ed39e2ea931586b6a985a6942ef573e->getLimit()   );return $this;}public function setState(iState $v9ed39e2ea931586b6a985a6942ef573e) {$this->state = $v9ed39e2ea931586b6a985a6942ef573e;return $this;}public function saveState() {$va9205dcfd4a6f7c2cbe8be01566ff84a = $this->getRegistry();$v9ed39e2ea931586b6a985a6942ef573e = $this->getState()    ->export();$va9205dcfd4a6f7c2cbe8be01566ff84a->set(self::REGISTRY_KEY, json_encode($v9ed39e2ea931586b6a985a6942ef573e));return $this;}public function flushSavedState() {$va9205dcfd4a6f7c2cbe8be01566ff84a = $this->getRegistry();$va9205dcfd4a6f7c2cbe8be01566ff84a->set(self::REGISTRY_KEY, null);return $this;}public function isComplete() {return $this->getState()    ->isComplete();}private function getAbsoluteLink(iEntity $vf5e638cc78dd325906c1298a0c21fb6b) {$v1b4b9fbc52861329a1e3fdffd482b433 = $vf5e638cc78dd325906c1298a0c21fb6b->getAddress();if ($this->isAbsoluteUrl($v1b4b9fbc52861329a1e3fdffd482b433)) {return $v1b4b9fbc52861329a1e3fdffd482b433;}$v1ca0b14b9be01258143f4c344e7c8cf1 = $vf5e638cc78dd325906c1298a0c21fb6b->getPlace();$v0c5d6b57ac65d9a5b955bc06996207dd = $this->getProtocolWithHostFromAbsoluteUrl($v1ca0b14b9be01258143f4c344e7c8cf1);if ($this->isUrlPath($v1b4b9fbc52861329a1e3fdffd482b433)) {return $v0c5d6b57ac65d9a5b955bc06996207dd . $v1b4b9fbc52861329a1e3fdffd482b433;}if ($this->isUrlQuery($v1b4b9fbc52861329a1e3fdffd482b433)) {return $v0c5d6b57ac65d9a5b955bc06996207dd . self::URI_SEPARATOR . $v1b4b9fbc52861329a1e3fdffd482b433;}if ($this->isUrlFragment($v1b4b9fbc52861329a1e3fdffd482b433)) {return $v0c5d6b57ac65d9a5b955bc06996207dd . self::URI_SEPARATOR . $v1b4b9fbc52861329a1e3fdffd482b433;}if ($this->isUrlHost($v1b4b9fbc52861329a1e3fdffd482b433)) {return self::URL_DEFAULT_PROTOCOL . $v1b4b9fbc52861329a1e3fdffd482b433;}return $v1ca0b14b9be01258143f4c344e7c8cf1 . $v1b4b9fbc52861329a1e3fdffd482b433;}private function getProtocolWithHostFromAbsoluteUrl($v572d4e421e5e6b9bc11d815e8a027112) {preg_match(self::HOST_WITH_PROTOCOL_PATTERN, $v572d4e421e5e6b9bc11d815e8a027112, $v9c28d32df234037773be184dbdafc274);if (!isset($v9c28d32df234037773be184dbdafc274[0])) {throw new \privateException('Cant detect host');}return $v9c28d32df234037773be184dbdafc274[0];}private function isAbsoluteUrl($vb45cffe084dd3d20d928bee85e7b0f21) {return startsWith($vb45cffe084dd3d20d928bee85e7b0f21, self::URL_PROTOCOL_START_SYMBOLS);}private function isUrlPath($vb45cffe084dd3d20d928bee85e7b0f21) {return startsWith($vb45cffe084dd3d20d928bee85e7b0f21, self::URI_SEPARATOR);}private function isUrlQuery($vb45cffe084dd3d20d928bee85e7b0f21) {return startsWith($vb45cffe084dd3d20d928bee85e7b0f21, self::URL_QUERY_START_SYMBOL);}private function isUrlFragment($vb45cffe084dd3d20d928bee85e7b0f21) {return startsWith($vb45cffe084dd3d20d928bee85e7b0f21, self::URL_FRAGMENT_START_SYMBOL);}private function isUrlHost($vb45cffe084dd3d20d928bee85e7b0f21) {return (bool) preg_match(self::HOST_PATTERN, $vb45cffe084dd3d20d928bee85e7b0f21);}private function getLinks() {$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();$v12ce548f7dd8102106679b39a1c0b17e = $this->getLinksCollection();return $v12ce548f7dd8102106679b39a1c0b17e->getCorrectLinks(    $v9ed39e2ea931586b6a985a6942ef573e->getOffset(),    $v9ed39e2ea931586b6a985a6942ef573e->getLimit()   );}private function isUrlBroken($v572d4e421e5e6b9bc11d815e8a027112) {return ($this->requestUrlStatus($v572d4e421e5e6b9bc11d815e8a027112) !== self::OK_HTTP_STATUS_CODE);}private function requestUrlStatus($v572d4e421e5e6b9bc11d815e8a027112) {if (!function_exists('curl_init')) {throw new \RequiredFunctionIsNotExistsException('cURL library should be installed');}$vd88fc6edf21ea464d35ff76288b84103 = curl_init();curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_URL, $v572d4e421e5e6b9bc11d815e8a027112);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_HEADER, false);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_RETURNTRANSFER, true);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_USERAGENT, self::USER_AGENT);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_CUSTOMREQUEST, self::HEAD_HTTP_REQUEST_TYPE);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_NOBODY, true);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_FOLLOWLOCATION, true);curl_setopt($vd88fc6edf21ea464d35ff76288b84103, CURLOPT_TIMEOUT, self::CURL_TIMEOUT);curl_exec($vd88fc6edf21ea464d35ff76288b84103);$v9acb44549b41563697bb490144ec6258 = (int) curl_getinfo($vd88fc6edf21ea464d35ff76288b84103, CURLINFO_HTTP_CODE);curl_close($vd88fc6edf21ea464d35ff76288b84103);return $v9acb44549b41563697bb490144ec6258;}private function getState() {if ($this->state === null) {$this->setState(     $this->loadState()    );}return $this->state;}private function loadState() {$va9205dcfd4a6f7c2cbe8be01566ff84a = $this->getRegistry();$v9ed39e2ea931586b6a985a6942ef573e = $va9205dcfd4a6f7c2cbe8be01566ff84a->get(self::REGISTRY_KEY);$v9ed39e2ea931586b6a985a6942ef573e = json_decode($v9ed39e2ea931586b6a985a6942ef573e, true);if (!is_array($v9ed39e2ea931586b6a985a6942ef573e)) {$v9ed39e2ea931586b6a985a6942ef573e = $this->getStartState();}return new State($v9ed39e2ea931586b6a985a6942ef573e);}private function getStartState() {return [    iState::COMPLETE_KEY => false,    iState::LIMIT_KEY => self::CHECKING_LIMIT_BY_ONE_ITERATION,    iState::OFFSET_KEY => 0   ];}}