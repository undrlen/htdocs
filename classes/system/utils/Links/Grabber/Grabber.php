<?php
 namespace UmiCms\Classes\System\Utils\Links\Grabber;use UmiCms\Classes\System\Utils\Links\Entity;use UmiCms\Classes\System\Utils\Links\Grabber\Steps;use UmiCms\Classes\System\Utils\Links\Injectors;class Grabber implements  iGrabber,  \iUmiService,  \iUmiConfigInjector,  \iUmiTemplatesInjector,  \iUmiDirectoriesInjector,  \iUmiDataBaseInjector,  \iUmiPagesInjector,  Injectors\iLinksCollection,  Injectors\iLinksSourcesCollection {use \tUmiService;use \tUmiConfigInjector;use \tUmiTemplatesInjector;use \tUmiDirectoriesInjector;use \tUmiDataBaseInjector;use \tUmiPagesInjector;use Injectors\tLinksCollection;use Injectors\tLinksSourcesCollection;private $state;private $step;private $result;private $isFirstLaunch = false;const STATE_FILE_NAME = 'linksGrabberState';const CONFIG_CACHE_PATH_KEY = 'system.runtime-cache';const MYSQL_DUPLICATE_ENTRY_ERROR_TEXT = 'Duplicate entry';const GRAB_STEP_SERVICE_NAME_PREFIX = 'UmiCms\Classes\System\Utils\Links\Grabber\Steps\\';public function grab() {if ($this->isComplete()) {return $this;}$v2764ca9d34e90313978d044f27ae433b = $this->getCurrentStep();if ($this->isFirstLaunch()) {$this->deleteAllLinks();$this->setIsFirstLaunch(false);}$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();$v3b15d4be5a300c4b02550b8f882ed339 = $v9ed39e2ea931586b6a985a6942ef573e->getStateOfStep($v2764ca9d34e90313978d044f27ae433b);$v2764ca9d34e90313978d044f27ae433b->setState($v3b15d4be5a300c4b02550b8f882ed339);if ($v2764ca9d34e90313978d044f27ae433b->isComplete()) {$this->switchToNextStep();$this->grab();return $this;}$v2764ca9d34e90313978d044f27ae433b->grab();$v9ed39e2ea931586b6a985a6942ef573e->setStateOfStep($v2764ca9d34e90313978d044f27ae433b);$v187812f4b91f26632752dd0b1c71113d = $v2764ca9d34e90313978d044f27ae433b->getResult();$this->setResult($v187812f4b91f26632752dd0b1c71113d);$this->switchToNextStep();return $this;}public function isComplete() {return $this->getState()    ->isComplete();}public function getStateName() {return $this->getState()    ->getCurrentStepName();}public function getResult() {if ($this->result === null) {throw new \RequiredPropertyHasNoValueException('You should grab first');}return $this->result;}public function setState(iState $v9ed39e2ea931586b6a985a6942ef573e) {$this->state = $v9ed39e2ea931586b6a985a6942ef573e;return $this;}public function saveState() {$v17686b6dc6aae6ad46d83d04aa895405 = $this->getStateFilePath();$v9ed39e2ea931586b6a985a6942ef573e = $this->getState()    ->export();if (!@file_put_contents($v17686b6dc6aae6ad46d83d04aa895405, json_encode($v9ed39e2ea931586b6a985a6942ef573e))) {throw new \privateException('Cannot save state');}return $this;}public function flushSavedState() {$v17686b6dc6aae6ad46d83d04aa895405 = $this->getStateFilePath();if (!@unlink($v17686b6dc6aae6ad46d83d04aa895405)) {throw new \privateException('Cannot flush state');}return $this;}public function saveResult() {foreach ($this->getResult() as $v98248c827299f5fed27aa8d5a9494032 => $v807765384d9d5527da8848df14a4f02f) {$this->createLinkEntities($v98248c827299f5fed27aa8d5a9494032, $v807765384d9d5527da8848df14a4f02f);unset($this->result[$v98248c827299f5fed27aa8d5a9494032]);}return $this;}private function setIsFirstLaunch($v9acb44549b41563697bb490144ec6258 = true) {$this->isFirstLaunch = (bool) $v9acb44549b41563697bb490144ec6258;return $this;}private function isFirstLaunch() {return $this->isFirstLaunch;}private function getStateFilePath() {return $this->getConfiguration()     ->includeParam(self::CONFIG_CACHE_PATH_KEY) . self::STATE_FILE_NAME;}private function createLinkEntities($vebed715e82a0a0f3e950ef6565cdc4a8, array $v963e3a2fe559e393bad631f3dc686f69) {$v6e422d769b360a2b8fab6ecfd903f037 = $this->getState()    ->getCurrentStepName();switch ($v6e422d769b360a2b8fab6ecfd903f037) {case Steps\SitesUrls::STEP_NAME: {$this->createLinks($vebed715e82a0a0f3e950ef6565cdc4a8, $v963e3a2fe559e393bad631f3dc686f69);break;}default : {$this->createLinksSources($vebed715e82a0a0f3e950ef6565cdc4a8, $v963e3a2fe559e393bad631f3dc686f69);}}}private function createLinks($vebed715e82a0a0f3e950ef6565cdc4a8, array $v963e3a2fe559e393bad631f3dc686f69) {$v6500964acba13be70b7eaf1a98876db9 = $this->getLinksCollection();foreach ($v963e3a2fe559e393bad631f3dc686f69 as $v884d9804999fc47a3c2694e49ad2536a) {if (!is_string($v884d9804999fc47a3c2694e49ad2536a) || trim($v884d9804999fc47a3c2694e49ad2536a) === '') {continue;}try {$v6500964acba13be70b7eaf1a98876db9->createByAddressAndPlace($v884d9804999fc47a3c2694e49ad2536a, $vebed715e82a0a0f3e950ef6565cdc4a8);}catch (\databaseException $ve1671797c52e15f763380b45e841ec32) {if (!contains($ve1671797c52e15f763380b45e841ec32->getMessage(), self::MYSQL_DUPLICATE_ENTRY_ERROR_TEXT)) {throw $ve1671797c52e15f763380b45e841ec32;}}}}private function createLinksSources($vebed715e82a0a0f3e950ef6565cdc4a8, array $v963e3a2fe559e393bad631f3dc686f69) {$v6500964acba13be70b7eaf1a98876db9 = $this->getLinksCollection();$va59c2db5de9617977b0fbe5ae8116d31 = $this->getLinksSourcesCollection();foreach ($v963e3a2fe559e393bad631f3dc686f69 as $v884d9804999fc47a3c2694e49ad2536a) {$v2a304a1348456ccd2234cd71a81bd338 = $v6500964acba13be70b7eaf1a98876db9->getByAddress($v884d9804999fc47a3c2694e49ad2536a);if (!$v2a304a1348456ccd2234cd71a81bd338 instanceof Entity) {continue;}try {$va59c2db5de9617977b0fbe5ae8116d31->createByLinkIdAndPlace($v2a304a1348456ccd2234cd71a81bd338->getId(), $vebed715e82a0a0f3e950ef6565cdc4a8);}catch (\databaseException $ve1671797c52e15f763380b45e841ec32) {if (!contains($ve1671797c52e15f763380b45e841ec32->getMessage(), self::MYSQL_DUPLICATE_ENTRY_ERROR_TEXT)) {throw $ve1671797c52e15f763380b45e841ec32;}}}}private function switchToNextStep() {$v2764ca9d34e90313978d044f27ae433b = $this->getCurrentStep();if (!$v2764ca9d34e90313978d044f27ae433b->isComplete()) {return $this;}$v73b0cd13b3ac5e2a9dc70a4a52e142de = $this->getNextStepName($v2764ca9d34e90313978d044f27ae433b);$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();if (is_string($v73b0cd13b3ac5e2a9dc70a4a52e142de)) {$v9ed39e2ea931586b6a985a6942ef573e->setCurrentStepName($v73b0cd13b3ac5e2a9dc70a4a52e142de);return $this->setStep(     $this->loadStep()    );}$v9ed39e2ea931586b6a985a6942ef573e->setCompleteStatus(true);return $this;}private function getNextStepName(Steps\iStep $v5b91c3b93abe37cd0a2753f7a377a30e) {$v6e422d769b360a2b8fab6ecfd903f037 = $v5b91c3b93abe37cd0a2753f7a377a30e->getName();$v2fb9168446a14fa343c7d9bad3023c70 = false;$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();$v73b0cd13b3ac5e2a9dc70a4a52e142de = null;foreach ($v9ed39e2ea931586b6a985a6942ef573e->getStepsNames() as $vc2a4cfd1efe2fcc567e41922b33e8d28) {if ($v6e422d769b360a2b8fab6ecfd903f037 == $vc2a4cfd1efe2fcc567e41922b33e8d28) {$v2fb9168446a14fa343c7d9bad3023c70 = true;continue;}if ($v2fb9168446a14fa343c7d9bad3023c70) {$v73b0cd13b3ac5e2a9dc70a4a52e142de = $vc2a4cfd1efe2fcc567e41922b33e8d28;break;}}return $v73b0cd13b3ac5e2a9dc70a4a52e142de;}private function getCurrentStep() {if ($this->step === null) {$this->setStep(     $this->loadStep()    );}return $this->step;}private function setStep(Steps\iStep $v2764ca9d34e90313978d044f27ae433b) {$this->step = $v2764ca9d34e90313978d044f27ae433b;return $this;}private function loadStep($vc2a4cfd1efe2fcc567e41922b33e8d28 = null) {if ($vc2a4cfd1efe2fcc567e41922b33e8d28 === null) {$v9ed39e2ea931586b6a985a6942ef573e = $this->getState();$vc2a4cfd1efe2fcc567e41922b33e8d28 = $v9ed39e2ea931586b6a985a6942ef573e->getCurrentStepName();}$vf219370ddf03f7b05f2182f8064636c0 = self::GRAB_STEP_SERVICE_NAME_PREFIX . $vc2a4cfd1efe2fcc567e41922b33e8d28;if (!class_exists($vf219370ddf03f7b05f2182f8064636c0)) {throw new \privateException(sprintf('Step %s not found', $vf219370ddf03f7b05f2182f8064636c0));}$v2764ca9d34e90313978d044f27ae433b = new $vf219370ddf03f7b05f2182f8064636c0();switch ($v2764ca9d34e90313978d044f27ae433b->getName()) {case Steps\DesignTemplates::STEP_NAME : {$v2764ca9d34e90313978d044f27ae433b->setTemplatesCollection(      $this->getTemplatesCollection()     );$v2764ca9d34e90313978d044f27ae433b->setDirectoriesHandler(      $this->getDirectoriesHandler()     );break;}case Steps\SitesUrls::STEP_NAME : {$v2764ca9d34e90313978d044f27ae433b->setPagesCollection(      $this->getPagesCollection()     );$v2764ca9d34e90313978d044f27ae433b->setConnection($this->getConnection());break;}default : {$v2764ca9d34e90313978d044f27ae433b->setConnection(      $this->getConnection()     );}}return $v2764ca9d34e90313978d044f27ae433b;}private function loadState() {$v17686b6dc6aae6ad46d83d04aa895405 = $this->getStateFilePath();$v9ed39e2ea931586b6a985a6942ef573e = @file_get_contents($v17686b6dc6aae6ad46d83d04aa895405);$v9ed39e2ea931586b6a985a6942ef573e = json_decode($v9ed39e2ea931586b6a985a6942ef573e, true);if (!is_array($v9ed39e2ea931586b6a985a6942ef573e)) {$this->setIsFirstLaunch();$v9ed39e2ea931586b6a985a6942ef573e = $this->getStartStateStructure();}$v9ed39e2ea931586b6a985a6942ef573e = new State($v9ed39e2ea931586b6a985a6942ef573e);return $this->setState($v9ed39e2ea931586b6a985a6942ef573e);}private function getStartStateStructure() {$v07414f4e15ca943e6cde032dec85d92f = [    iState::STEPS_KEY => [     'SitesUrls' => [],     'ObjectsFields' => [],     'ObjectsNames' => [],     'DesignTemplates' => []    ],    iState::CURRENT_STEP_KEY => 'SitesUrls',    iState::COMPLETE_KEY => false   ];foreach ($v07414f4e15ca943e6cde032dec85d92f[iState::STEPS_KEY] as $vc2a4cfd1efe2fcc567e41922b33e8d28 => $v3b15d4be5a300c4b02550b8f882ed339) {$v07414f4e15ca943e6cde032dec85d92f[iState::STEPS_KEY][$vc2a4cfd1efe2fcc567e41922b33e8d28] = $this->loadStep($vc2a4cfd1efe2fcc567e41922b33e8d28)     ->getStartStateStructure();}return $v07414f4e15ca943e6cde032dec85d92f;}private function getState() {if ($this->state === null) {$this->loadState();}return $this->state;}private function setResult(array $result) {if ($this->result === null) {$this->result = [];}$this->result = array_merge($this->result, $result);return $this;}private function deleteAllLinks() {$this->getLinksCollection()    ->deleteAll();}}