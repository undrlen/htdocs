<?php
 namespace UmiCms\Utils\SiteMap;use UmiCms\System\Events\iEventPointFactory as EventFactory;class Updater implements iUpdater {private $connection;private $umiHierarchy;private $eventFactory;public function __construct(\IConnection $v4717d53ebfdfea8477f780ec66151dcb, \iUmiHierarchy $vb81ca7c0ccaa77e7aa91936ab0070695, EventFactory $v67c06be409275078f3a98d129b0123c8) {$this->connection = $v4717d53ebfdfea8477f780ec66151dcb;$this->umiHierarchy = $vb81ca7c0ccaa77e7aa91936ab0070695;$this->eventFactory = $v67c06be409275078f3a98d129b0123c8;}public function update(\iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$v7552cd149af7495ee7d8225974e50f80 = (int) $v8e2dcfd7e7e24b1ca76c1193f645902b->getId();$v2a304a1348456ccd2234cd71a81bd338 = $this->getLink($v7552cd149af7495ee7d8225974e50f80);$v5fa40b2485d1096a170d2d7ecd0f7030 = date('Y-m-d H:i:s', $v8e2dcfd7e7e24b1ca76c1193f645902b->getUpdateTime());$vb988295c268025b49dfb3df26171ddc3 = (float) $this->getPriority($v7552cd149af7495ee7d8225974e50f80);$v075d12d847ab6a1266bae1458b09cfc0 = (int) $this->getMaxLevel($v8e2dcfd7e7e24b1ca76c1193f645902b);$v72ee76c5c29383b7c9f9225c1fa4d10b = (int) $v8e2dcfd7e7e24b1ca76c1193f645902b->getDomainId();$vf585b7f018bb4ced15a03683a733e50b = (int) $v8e2dcfd7e7e24b1ca76c1193f645902b->getLangId();$vf280fa25484b1dcd8f06326d682aafbf = $this->getRobotsDeny($v8e2dcfd7e7e24b1ca76c1193f645902b);$this->delete($v7552cd149af7495ee7d8225974e50f80);$this->getEventFactory()    ->create('before_update_sitemap', 'before')    ->setParam('id', $v7552cd149af7495ee7d8225974e50f80)    ->setParam('domainId', $v72ee76c5c29383b7c9f9225c1fa4d10b)    ->setParam('langId', $vf585b7f018bb4ced15a03683a733e50b)    ->addRef('link', $v2a304a1348456ccd2234cd71a81bd338)    ->addRef('pagePriority', $vb988295c268025b49dfb3df26171ddc3)    ->setParam('updateTime', $v5fa40b2485d1096a170d2d7ecd0f7030)    ->setParam('level', $v075d12d847ab6a1266bae1458b09cfc0)    ->addRef('robots_deny', $vf280fa25484b1dcd8f06326d682aafbf)    ->call();if ($v8e2dcfd7e7e24b1ca76c1193f645902b->getIsActive() && !$vf280fa25484b1dcd8f06326d682aafbf && !$v8e2dcfd7e7e24b1ca76c1193f645902b->getIsDeleted()) {$v4717d53ebfdfea8477f780ec66151dcb = $this->getConnection();$v2a304a1348456ccd2234cd71a81bd338 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v2a304a1348456ccd2234cd71a81bd338);$v5fa40b2485d1096a170d2d7ecd0f7030 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v5fa40b2485d1096a170d2d7ecd0f7030);mt_srand();$v577c2406e417ed786986e6a6cfd55317 = mt_rand(0, 16);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO `cms_sitemap` (`id`, `domain_id`, `link`, `sort`, `priority`, `dt`, `level`, `lang_id`)
VALUES ($v7552cd149af7495ee7d8225974e50f80, $v72ee76c5c29383b7c9f9225c1fa4d10b, "$v2a304a1348456ccd2234cd71a81bd338", $v577c2406e417ed786986e6a6cfd55317, $vb988295c268025b49dfb3df26171ddc3, "$v5fa40b2485d1096a170d2d7ecd0f7030", $v075d12d847ab6a1266bae1458b09cfc0, $vf585b7f018bb4ced15a03683a733e50b);
SQL;    $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);}return $this;}public function updateList(array $v8bde57434adb7a78cc31875b6e82f43e) {foreach ($v8bde57434adb7a78cc31875b6e82f43e as $v8e2dcfd7e7e24b1ca76c1193f645902b) {if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof \iUmiHierarchyElement) {continue;}$this->update($v8e2dcfd7e7e24b1ca76c1193f645902b);}return $this;}public function delete($v7552cd149af7495ee7d8225974e50f80) {if (!is_numeric($v7552cd149af7495ee7d8225974e50f80) || (int) $v7552cd149af7495ee7d8225974e50f80 === 0) {return $this;}$v817f7de13f58df29b13a9570082097da = (int) $v7552cd149af7495ee7d8225974e50f80;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `cms_sitemap` WHERE `id` = $v817f7de13f58df29b13a9570082097da;
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}public function deleteList(array $vc30fd998704ca76bdea9af17c4f2b156) {if (empty($vc30fd998704ca76bdea9af17c4f2b156)) {return $this;}$v0763e0b509c9384232da95d941a0f85a = array_map(    function ($vb80bb7740288fda1f201890375a60c8f) {return (int) $vb80bb7740288fda1f201890375a60c8f;},    $vc30fd998704ca76bdea9af17c4f2b156   );$v3f9178c25b78ed8bed19091bcb62e266 = implode(', ', $v0763e0b509c9384232da95d941a0f85a);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `cms_sitemap` WHERE `id` IN ($v3f9178c25b78ed8bed19091bcb62e266);
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}public function deleteAll() {$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
TRUNCATE TABLE `cms_sitemap`;
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}public function deleteByDomain($vb80bb7740288fda1f201890375a60c8f) {$vb80bb7740288fda1f201890375a60c8f = (int) $vb80bb7740288fda1f201890375a60c8f;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
DELETE FROM `cms_sitemap` WHERE `domain_id` = $vb80bb7740288fda1f201890375a60c8f;
SQL;   $this->getConnection()    ->query($vac5c74b64b4b8352ef2f181affb5ac2a);return $this;}private function getRobotsDeny(\iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$vf8aea31a0fd948447674cb859137e6e7 = $this->getHierarchy();$v3a6dbc22c79208bc65665635bc19d967 = $vf8aea31a0fd948447674cb859137e6e7->getAllParents($v8e2dcfd7e7e24b1ca76c1193f645902b->getId(), true);$v326f338554374193a7a745b14d96459d = $vf8aea31a0fd948447674cb859137e6e7->loadElements($v3a6dbc22c79208bc65665635bc19d967);foreach ($v326f338554374193a7a745b14d96459d as $vd0e45878043844ffc41aac437e86b602) {if ($vd0e45878043844ffc41aac437e86b602->getValue('robots_deny')) {return true;}}return false;}private function getLink($v7552cd149af7495ee7d8225974e50f80) {$vb81ca7c0ccaa77e7aa91936ab0070695 = $this->getHierarchy();$v0382b9fd9ef50b6a335f35e0aaaebf99 = $vb81ca7c0ccaa77e7aa91936ab0070695->forceAbsolutePath();$vd6002bad1f6c9bdfa67a8df49c831798 = false;$v3cf2633035406f8e3eb4962af191fe14 = false;$vece42746c2b3aa1e585809fa739602ae = true;$v2a304a1348456ccd2234cd71a81bd338 = $vb81ca7c0ccaa77e7aa91936ab0070695->getPathById($v7552cd149af7495ee7d8225974e50f80, $vd6002bad1f6c9bdfa67a8df49c831798, $v3cf2633035406f8e3eb4962af191fe14, $vece42746c2b3aa1e585809fa739602ae);$vb81ca7c0ccaa77e7aa91936ab0070695->forceAbsolutePath($v0382b9fd9ef50b6a335f35e0aaaebf99);return $v2a304a1348456ccd2234cd71a81bd338;}private function getPriority($v7552cd149af7495ee7d8225974e50f80) {$v817f7de13f58df29b13a9570082097da = (int) $v7552cd149af7495ee7d8225974e50f80;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `level` FROM `cms3_hierarchy_relations` WHERE (`rel_id` = '' or `rel_id` is null) and `child_id` = $v817f7de13f58df29b13a9570082097da;
SQL;   $result = $this->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(\IQueryResult::FETCH_ROW);$v8aac9ddfd8f1554f195cfe07c8bd36f5 = 0.5;foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$vc9e9a848920877e76685b2e4e76de38d = (int) array_shift($vf1965a857bc285d26fe22023aa5ab50d);$v8aac9ddfd8f1554f195cfe07c8bd36f5 = round(1 / ($vc9e9a848920877e76685b2e4e76de38d + 1), 1);if ($v8aac9ddfd8f1554f195cfe07c8bd36f5 < 0.1) {$v8aac9ddfd8f1554f195cfe07c8bd36f5 = 0.1;}}return $v8aac9ddfd8f1554f195cfe07c8bd36f5;}private function getMaxLevel(\iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$vb81ca7c0ccaa77e7aa91936ab0070695 = $this->getHierarchy();return $v8e2dcfd7e7e24b1ca76c1193f645902b->getIsDefault() ? 0 : (int) $vb81ca7c0ccaa77e7aa91936ab0070695->getMaxDepth($v8e2dcfd7e7e24b1ca76c1193f645902b->getId(), 1);}private function getConnection() {return $this->connection;}private function getHierarchy() {return $this->umiHierarchy;}private function getEventFactory() {return $this->eventFactory;}}