<?php
 namespace UmiCms\Classes\System\Utils\Captcha\Strategies;use UmiCms\Service;class ClassicCaptcha extends CaptchaStrategy {const ID_PARAM = 'captcha_id';public function getName() {return 'captcha';}public function generate($v66f6181bcb4cff4cd38fbc804a036db6, $v56d72c4d5259a6034a152e6c02cd754c, $vf66412bef9a4d9ac818c3141160250bd, $v123c50dcaa827353e19cd0140ab2c896) {if (!$this->isRequired()) {return \def_module::isXSLTResultMode() ? [     'comment:explain' => 'Captcha is not required for logged users'    ] : '';}if (!$v66f6181bcb4cff4cd38fbc804a036db6) {$v66f6181bcb4cff4cd38fbc804a036db6 = 'default';}if (!$v56d72c4d5259a6034a152e6c02cd754c) {$v56d72c4d5259a6034a152e6c02cd754c = 'sys_captcha';}if (!$vf66412bef9a4d9ac818c3141160250bd) {$vf66412bef9a4d9ac818c3141160250bd = '';}$v9af24b163db8fe13fd0c36ae8c4080c1 = '?' . time();$vf585b7f018bb4ced15a03683a733e50b = Service::LanguageDetector()->detectId();$vfca1bff8ad8b3a8585abfb0ad523ba42 = [];$vfca1bff8ad8b3a8585abfb0ad523ba42['void:input_id'] = $v56d72c4d5259a6034a152e6c02cd754c;$vfca1bff8ad8b3a8585abfb0ad523ba42['attribute:captcha_hash'] = $vf66412bef9a4d9ac818c3141160250bd;$vfca1bff8ad8b3a8585abfb0ad523ba42['attribute:random_string'] = $v9af24b163db8fe13fd0c36ae8c4080c1;$vfca1bff8ad8b3a8585abfb0ad523ba42['attribute:lang_id'] = $vf585b7f018bb4ced15a03683a733e50b;$vfca1bff8ad8b3a8585abfb0ad523ba42['url'] = [    'attribute:random-string' => $v9af24b163db8fe13fd0c36ae8c4080c1,    'attribute:lang_id' => $vf585b7f018bb4ced15a03683a733e50b,    'node:value' => '/captcha.php',   ];if ($v123c50dcaa827353e19cd0140ab2c896) {$vfca1bff8ad8b3a8585abfb0ad523ba42['url']['attribute:id_param'] = self::ID_PARAM;$vfca1bff8ad8b3a8585abfb0ad523ba42['url']['attribute:id'] = $v123c50dcaa827353e19cd0140ab2c896;}list($vb7c60eca084c05c6f9d7b6f220a32025) = \def_module::loadTemplates('captcha/' . $v66f6181bcb4cff4cd38fbc804a036db6, 'captcha');return \def_module::parseTemplate($vb7c60eca084c05c6f9d7b6f220a32025, $vfca1bff8ad8b3a8585abfb0ad523ba42);}public function isRequired() {if (!parent::isRequired()) {return false;}if (!$this->shouldRemember()) {return true;}return (Service::Session()->get('is_human') != 1);}public function shouldRemember() {return Service::CaptchaSettingsFactory()    ->getCurrentSettings()    ->shouldRemember();}public function isValid() {if (!$this->isRequired()) {return true;}$v21d6f40cfb511982e4424e0e250a9557 = Service::Session();if (!$v21d6f40cfb511982e4424e0e250a9557->isExist('umi_captcha')) {return false;}$v70b29c4920daf4e51e8175179027e668 = $v21d6f40cfb511982e4424e0e250a9557->get('umi_captcha');$vbbb69e0d53c0db1cc9031fb3cce6ba6a = $v70b29c4920daf4e51e8175179027e668;$v8c19079cbb35687f0d341457a8fb2604 = (string) getRequest('captcha');if (is_array($v70b29c4920daf4e51e8175179027e668)) {$v123c50dcaa827353e19cd0140ab2c896 = (string) getRequest(self::ID_PARAM);if (!isset($v70b29c4920daf4e51e8175179027e668[$v123c50dcaa827353e19cd0140ab2c896])) {return false;}$vbbb69e0d53c0db1cc9031fb3cce6ba6a = $v70b29c4920daf4e51e8175179027e668[$v123c50dcaa827353e19cd0140ab2c896];}return $this->compareCodes($vbbb69e0d53c0db1cc9031fb3cce6ba6a, $v8c19079cbb35687f0d341457a8fb2604);}public function getDrawer() {$vb068931cc450442b63f5b3d276ea4297 = Service::CaptchaSettingsFactory()    ->getCurrentSettings()    ->getDrawerName() ?: 'default';return $this->findDrawer($vb068931cc450442b63f5b3d276ea4297);}private function compareCodes($vbbb69e0d53c0db1cc9031fb3cce6ba6a, $v75713501e0b503df00adf22454cc969f) {$v26354d41d77e6eabc83df9db8c1898d7 = md5($v75713501e0b503df00adf22454cc969f);$v21d6f40cfb511982e4424e0e250a9557 = Service::Session();if (Service::Protection()->hashEquals($vbbb69e0d53c0db1cc9031fb3cce6ba6a, $v26354d41d77e6eabc83df9db8c1898d7)) {$v21d6f40cfb511982e4424e0e250a9557->set('is_human', 1);return true;}$v21d6f40cfb511982e4424e0e250a9557->del('is_human');return false;}}