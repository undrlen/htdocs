<?php
 use UmiCms\Service;class umiExceptionHandler {private static $templateFile;protected static function getExceptionTemplate() {if (!file_exists(self::$templateFile)) {self::setExceptionTemplate(SYS_ERRORS_PATH . 'exception.html.php');}return self::$templateFile;}protected static function setExceptionTemplate($v8c7dd922ad47494fc02c388e12c00eac) {if (!file_exists($v8c7dd922ad47494fc02c388e12c00eac)) {throw new Exception('Exception template not exists');}self::$templateFile = $v8c7dd922ad47494fc02c388e12c00eac;}protected static function printTemplate($ve1671797c52e15f763380b45e841ec32) {$v42552b1f133f9f8eb406d4f306ea9fd1 = new stdClass();$v42552b1f133f9f8eb406d4f306ea9fd1->code = $ve1671797c52e15f763380b45e841ec32->getCode();$v42552b1f133f9f8eb406d4f306ea9fd1->message = $ve1671797c52e15f763380b45e841ec32->getMessage();$v42552b1f133f9f8eb406d4f306ea9fd1->type = get_class($ve1671797c52e15f763380b45e841ec32);if (DEBUG_SHOW_BACKTRACE) {$v42552b1f133f9f8eb406d4f306ea9fd1->trace = $ve1671797c52e15f763380b45e841ec32->getTrace();$v42552b1f133f9f8eb406d4f306ea9fd1->traceAsString = $ve1671797c52e15f763380b45e841ec32->getTraceAsString();}require self::getExceptionTemplate();}public static function set($vab8c9e32f5757d87122d20d002fc1749 = 'base', $v66f6181bcb4cff4cd38fbc804a036db6 = '') {$vab8c9e32f5757d87122d20d002fc1749 = $vab8c9e32f5757d87122d20d002fc1749 . 'Handler';if (method_exists(__CLASS__, $vab8c9e32f5757d87122d20d002fc1749)) {self::setExceptionTemplate($v66f6181bcb4cff4cd38fbc804a036db6);return set_exception_handler([     __CLASS__,     $vab8c9e32f5757d87122d20d002fc1749    ]);}throw new Exception('Error handler not exist');}public static function restore() {return restore_exception_handler();}public static function createCrashReport($v78e731027d8fd50ed642340b7c9a63b3, $v04a75036e9d520bb983c5ed03b8d0182) {$v0b385c8d43e6b02e3394085f06ee22e6 = mainConfiguration::getInstance()->get('debug', 'log-exceptions');if (!$v0b385c8d43e6b02e3394085f06ee22e6) {return false;}$v63a04a2f17915ed7c241c38ff2a29f4d = ERRORS_LOGS_PATH . '/exceptions/';if (!is_dir($v63a04a2f17915ed7c241c38ff2a29f4d)) {mkdir($v63a04a2f17915ed7c241c38ff2a29f4d, 0777, true);}try {$v6db435f352d7ea4a67807a3feb447bf7 = new umiLogger($v63a04a2f17915ed7c241c38ff2a29f4d);$v6db435f352d7ea4a67807a3feb447bf7->pushGlobalEnvironment();$v6db435f352d7ea4a67807a3feb447bf7->push($v78e731027d8fd50ed642340b7c9a63b3);$v6db435f352d7ea4a67807a3feb447bf7->push($v04a75036e9d520bb983c5ed03b8d0182);$v6db435f352d7ea4a67807a3feb447bf7->save();return true;}catch (Exception $ve1671797c52e15f763380b45e841ec32) {return false;}}public static function report(Exception $v42552b1f133f9f8eb406d4f306ea9fd1) {return self::createCrashReport($v42552b1f133f9f8eb406d4f306ea9fd1->getMessage(), $v42552b1f133f9f8eb406d4f306ea9fd1->getTraceAsString());}public static function baseHandler($ve1671797c52e15f763380b45e841ec32) {if (!DEBUG_SHOW_BACKTRACE && $ve1671797c52e15f763380b45e841ec32 instanceof databaseException) {$ve1671797c52e15f763380b45e841ec32 = new Exception(     'Произошла критическая ошибка. Скорее всего, потребуется участие разработчиков.  Подробности по ссылке <a title="" target="_blank" href="https://errors.umi-cms.ru/17000/">17000</a>',     17000,     $ve1671797c52e15f763380b45e841ec32    );}$v7f2db423a49b305459147332fb01cf87 = Service::Response()    ->getCurrentBuffer();$v7f2db423a49b305459147332fb01cf87->status(500);self::printTemplate($ve1671797c52e15f763380b45e841ec32);self::createCrashReport($ve1671797c52e15f763380b45e841ec32->getMessage(), $ve1671797c52e15f763380b45e841ec32->getTraceAsString());$v7f2db423a49b305459147332fb01cf87->stop();}public static function handleShutdown() {if (!mainConfiguration::getInstance()->get('debug', 'handle-shutdown')) {return false;}register_shutdown_function(function () {if (libxml_get_last_error()) {var_export(libxml_get_last_error());echo '<br />';}if (error_get_last()) {var_export(error_get_last());}});}}